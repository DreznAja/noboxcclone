$(document).ready(function () {
    //data pada inbox
    let Inbox = {
        User: {
            UserId: 1,
        },
        Default: {
            Funnels: [],
            Tags: [],
            QuickReply: [],
            Users: [],
            Acccounts: [],
        },
        ListMessages: [],
        ListRoom: [],
        ListRoomAll: [],
        DataRoomActive: {},
        SkipRoom: 0,
        SkipHistory: 0,
        SkipArchived: 0,
        ListRoomNotif: [],
        ListRoomNotifAll: [],
        IsAgentView: false,
        IdRoomAktif: "",
        IsBack: true,
        ReplyIdMsg: null,
        //sudah jelas dipakai
        Data: {
            Funnels: [],
            Tags: []
        },
        Function: {
            renderChannelInListConversation: (chId) => {
                let iconkontak = '';
                switch (chId) {
                    case 1:
                    case 1557:
                        iconkontak = `<div class="inboxicon whatsapp"></div>`;
                        break;
                    case 2:
                        iconkontak = `<div class="inboxicon telegram"></div>`;
                        break;
                    case 3:
                        iconkontak = `<div class="inboxicon instagram"></div>`;
                        break;
                    case 4:
                        iconkontak = `<div class="inboxicon messenger"></div>`;
                        break;
                    case 19:
                        iconkontak = `<div class="fas fa-envelope text-danger" style="font-size:initial;"></div>`;
                        break;
                    case 7:
                        iconkontak = `<div class="inboxicon messenger"></div>`;
                        break;
                    case 8:
                        iconkontak = `<div class="inboxicon twitter"></div>`;
                        break;
                    case 1492:
                        iconkontak = `<div class="inboxicon bukalapak"></div>`;
                        break;
                    case 1502:
                        iconkontak = `<div class="inboxicon blibli"></div>`;
                        break;
                    case 1556:
                        iconkontak = `<div class="inboxicon blibliseller"></div>`;
                        break;
                    case 1503:
                        iconkontak = `<div class="inboxicon lazada"></div>`;
                        break;
                    case 1504:
                        iconkontak = `<div class="inboxicon shopee"></div>`;
                        break;
                    case 1505:
                    case 1562:
                        iconkontak = `<div class="inboxicon tokopedia"></div>`;
                        break;
                    case 1532:
                        iconkontak = `<div class="inboxicon olx"></div>`;
                        break
                    case 6:
                        iconkontak = `<div class="inboxicon tiktok"></div>`;
                        break;
                    case 1569:
                        iconkontak = `<div class="inboxicon noboxchat"></div>`;
                        break;
                    default:
                        iconkontak = ''; // Optional: Set default value if no match is found
                        break;
                }
                return iconkontak;
            },
            renderChannelInDetailConversation: () => {
                let channelContent = '';
                switch (Inbox.DataRoomActive.Room.ChId) {
                    case 2:
                        channelContent = `<div class="inboxicon telegram" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.IsGrp == 1
                            ? Inbox.DataRoomActive.Room.GrpExtId
                            : Inbox.DataRoomActive.Room.CtIdExt
                            }`;
                        break;
                    case 3:
                        channelContent = `<div class="inboxicon instagram" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 4:
                        channelContent = `<div class="inboxicon messenger" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 19:
                        channelContent = `<i class="text-danger fas fa-envelope" style="font-size:16px;margin-top:-6px;"></i>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 7:
                        channelContent = `<div class="inboxicon messenger" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1:
                    case 1557:
                        channelContent = `<div class="inboxicon whatsapp" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.IsGrp == 1
                            ? Inbox.DataRoomActive.Room.GrpExtId
                            : Inbox.DataRoomActive.Room.CtIdExt
                            }`;
                        break;
                    case 1492:
                        channelContent = `<div class="inboxicon bukalapak" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1502:
                        channelContent = `<div class="inboxicon blibli" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1556:
                        channelContent = `<div class="inboxicon blibliseller" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1503:
                        channelContent = `<div class="inboxicon lazada" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1504:
                        channelContent = `<div class="inboxicon shopee" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1505:
                    case 1562:
                        channelContent = `<div class="inboxicon tokopedia" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1532:
                        channelContent = `<div class="inboxicon olx" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 6:
                        channelContent = `<div class="inboxicon tiktok" style="margin-top: -6px;"></div>&nbsp;${Inbox.DataRoomActive.Room.CtIdExt}`;
                        break;
                    case 1569:
                        const ctIdExt = Inbox.DataRoomActive.Room.CtIdExt;
                        const shortCtIdExt = ctIdExt.length > 25 ? ctIdExt.slice(0, 25) + "..." : ctIdExt;
                        channelContent = `<div class="inboxicon noboxchat" style="margin-top: -3px;"></div>&nbsp;${shortCtIdExt}`;
                        break;
                    default:
                        channelContent = '';
                        break;
                }
                return channelContent;
            },
            text2Url: (text, klas) => {
                let urlRegex = /(https?:\/\/[^\s]+)/g;
                let hasil = String(text).replace(urlRegex, function (url) {
                    if (klas == "chatsss") {
                        return (
                            '<a target="_blank" style="text-decoration: underline;line-break:auto;" href="' +
                            url +
                            '">' +
                            url +
                            "</a>"
                        );
                    } else {
                        return (
                            '<a target="_blank" style="text-decoration: underline;color:white;line-break:auto;" href="' +
                            url +
                            '">' +
                            url +
                            "</a>"
                        );
                    }
                })
                return hasil == "null" ? "" : Inbox.Function.TemplateElmMsg.Part.formatMsg(hasil);
            },
            vCard2List: (input) => {
                let Re1 = /^(version|fn|title|org):(.+)$/i;
                let Re2 = /^([^:;]+);([^:]+):(.+)$/;
                let ReKey = /item\d{1,2}\./;
                let fields = {};

                input.split(/\r\n|\r|\n/).forEach(function (line) {
                    let results, key;

                    if (Re1.test(line)) {
                        results = line.match(Re1);
                        key = results[1].toLowerCase();
                        fields[key] = results[2];
                    } else if (Re2.test(line)) {
                        results = line.match(Re2);
                        key = results[1].replace(ReKey, "").toLowerCase();

                        let meta = {};
                        results[2]
                            .split(";")
                            .map(function (p, i) {
                                let match = p.match(/([a-z]+)=(.*)/i);
                                if (match) {
                                    return [match[1], match[2]];
                                } else {
                                    return ["TYPE" + (i === 0 ? "" : i), p];
                                }
                            })
                            .forEach(function (p) {
                                meta[p[0]] = p[1];
                            });

                        if (!fields[key]) fields[key] = [];

                        fields[key].push({
                            meta: meta,
                            value: results[3].split(";"),
                        });
                    }
                });

                return fields;
            },
            autoNumericFormatter: (val) => {
                let input = $(`<input type="text">`);

                let optionAuto = $.cookie("formatnumber");
                if (optionAuto == null) {
                    input.autoNumeric("init");
                } else {
                    let formatnumber = JSON.parse(decodeURIComponent(optionAuto));
                    if (jQuery.isEmptyObject(formatnumber)) {
                    } else {
                        let obj = {};
                        if ("aDec" in formatnumber) {
                            obj["aDec"] = formatnumber["aDec"];
                        }
                        if ("mDec" in formatnumber) {
                            obj["mDec"] = formatnumber["mDec"];
                        }
                        if ("aSep" in formatnumber) {
                            obj["aSep"] = formatnumber["aSep"];
                        }
                        if ("dGroup" in formatnumber) {
                            obj["dGroup"] = formatnumber["dGroup"];
                        }
                        if ("lZero" in formatnumber) {
                            obj["lZero"] = formatnumber["lZero"];
                        }
                        input.autoNumeric("init", obj);
                    }
                }
                if (val == "" || val == null) {
                    return "";
                } else {
                    input.autoNumeric("set", val);
                    return input.val();
                }
            },
            goToBottom: (selector) => {
                if (selector == "#chat-container") {
                    selector = "#chatBox";
                    let element = $(selector);
                    element[0].scrollTop = element[0].scrollHeight;
                } else {
                    let element = document.getElementById("chat-history-cnt");
                    element.scrollTop = element.scrollHeight;
                }
            },
            downloadFile: (content, filename, contentType) => {
                const a = document.createElement("a");
                const file = new Blob([content], { type: contentType });

                a.href = URL.createObjectURL(file);
                a.download = filename;
                a.click();

                URL.revokeObjectURL(a.href);
            },
            isValidJson: (str) => {
                try {
                    let data = JSON.parse(str);
                    return { err: false, data: data };
                } catch (e) {
                    return { err: true };
                }
            },
            isVideo: (filePath) => {
                const videoExtensions = /\.(mp4|webm|ogg|avi|mov|wmv|flv)$/i;
                const urlWithoutQuery = filePath.split('?')[0];
                return videoExtensions.test(urlWithoutQuery);
            },
            isValidUrl: (string) => {
                try {
                    new URL(string);
                    return true;
                } catch (err) {
                    return false;
                }
            },
            eventChatBubble: (m, selector) => {
                jQuery("abbrds.timeago").timeago();

                $("a.imgphotos" + m.RoomId).colorbox({
                    //photo: true,
                    //rel: selector.replace("#", "image") + m.RoomId,
                });
                $("a.stickerphotos" + m.RoomId).colorbox({
                    //photo: true,
                    //rel: selector.replace("#", "sticker") + m.RoomId,
                });

                $(".listMenu").unbind("click");
                $(".listMenu").on("click", function () {
                    let dataMenu = $(this).attr("data-menu");
                    let dlg = new Nobox.Nobox.CampaignListMessageDialog();
                    dlg.showFromInbox(dataMenu);
                    dlg.loadNewAndOpenDialog();
                    dlg.hideFromInbox();
                });

                $(".highlightChatTrigger").unbind("click");
                $(".highlightChatTrigger").on("click", function () {
                    let idElm = $(this).attr("href");
                    $(idElm).addClass(" highlightChat");
                    setTimeout(() => {
                        $(idElm).removeClass(" highlightChat");
                    }, 500);
                });

                //deleteMsg
                $(".DeleteMsg").unbind("click");
                $(".DeleteMsg").on("click", function () {
                    if (Inbox.DataRoomActive?.Room.Sess == 2)
                        return;
                    let idMsg = $(this).attr("data-id-msg");
                    Inbox.Function.MsgAction.deleteMsg(idMsg);
                });

                //replyMsg
                $(".ReplyMsg").unbind("click");
                $(".ReplyMsg").on("click", function () {
                    if (Inbox.DataRoomActive?.Room.Sess == 2)
                        return;
                    let idMsg = $(this).attr("data-id-msg");
                    Inbox.ReplyIdMsg = idMsg;
                    let dataMsg = Inbox.ListMessages.filter(x => x.Type.toString() != "6").find(x => x.Id.toString() == idMsg);
                    //ReplyMedia
                    let isReplyMedia = false;
                    let replyMedia = null;
                    let replyText = dataMsg.Msg;
                    if (!Q.isEmptyOrNull(dataMsg.File) && (dataMsg.Type == "3" || dataMsg.Type == "7")) {
                        let objFile = JSON.parse(dataMsg.File);
                        if (objFile != null) {
                            isReplyMedia = true;
                            replyMedia = Inbox.Function.isValidUrl(objFile.Filename) ? objFile.Filename : Q.resolveUrl("~/upload/") + objFile.Filename;
                        }
                    }
                    if (dataMsg.Type == "24" || dataMsg.Type == "25") {
                        let objMsg = JSON.parse(dataMsg.Msg);
                        if (!Q.isEmptyOrNull(objMsg.Image)) {
                            isReplyMedia = true;
                            replyMedia = Inbox.Function.isValidUrl(objMsg.Image) ? objMsg.Image : Q.resolveUrl("~/upload/") + objMsg.Image;
                        }
                        if (dataMsg.Type == "24") {
                            if (!Q.isEmptyOrNull(objMsg.Caption)) {
                                replyText = objMsg.Caption;
                            } else {
                                replyText = "ðŸ–¼";
                            }
                        } else {
                            replyText = objMsg.Username;
                        }
                    }
                    if (isReplyMedia) {
                        $("#replyMediaElm").show();
                    } else {
                        $("#replyMediaElm").hide();
                    }
                    $("#replyMediaElm").css("background-image", `url(${replyMedia})`);

                    //ReplyUser
                    let replyUser = null;
                    if (Inbox.DataRoomActive.Link != null) {
                        if (dataMsg.From == Inbox.DataRoomActive.Link.Id) {
                            if (Inbox.DataRoomActive.ContactReal != null) {
                                replyUser = Inbox.DataRoomActive.ContactReal.Name;
                            } else {
                                replyUser = Inbox.DataRoomActive.Link.Name;
                            }
                        } else {
                            replyUser = Inbox.DataRoomActive.Account.Name;
                        }
                    } else if (Inbox.DataRoomActive.Group != null) {
                        if (dataMsg.From == Inbox.DataRoomActive.Account.Id)
                            replyUser = Inbox.DataRoomActive.Account.Name;
                        else
                            replyUser = Inbox.DataRoomActive.Group.Name;
                    }
                    $("#replyUserElm").text(replyUser);

                    //ReplyText
                    switch (dataMsg.Type) {
                        case "2":
                            replyText = "ðŸ”Š Audio";
                            break;
                        case "3":
                            replyText = "ðŸ–¼ Photo";
                            break;
                        case "4":
                            replyText = "ðŸŽ¬ Video";
                            break;
                        case "5":
                            replyText = "ðŸ“ Document";
                            break;
                        case "7":
                            replyText = "ðŸŒŸ Sticker";
                            break;
                        case "9":
                            replyText = "ðŸ“ Location";
                            break;
                        case "10":
                            replyText = "ðŸ›’ Order";
                            break;
                        case "11":
                            replyText = "ðŸ“¦ Catalog";
                            break;
                        case "12":
                            replyText = "ðŸ‘¤ Contact";
                            break;
                        case "13":
                            replyText = "ðŸ‘¤ Contacts";
                            break;
                        case "14":
                            replyText = "ðŸ“‹ Interactive Order";
                            break;
                        case "15":
                            replyText = "ðŸ“Š Polling";
                            break;
                        case "16":
                            replyText = "âŒ Unsupport Message";
                            break;
                        case "17":
                            replyText = "âŒ Storage Limit";
                            break;
                        case "18":
                            replyText = "âŒ Channel Limit";
                            break;
                        case "19":
                            replyText = "ðŸ“ Interactive List";
                            break;
                        case "21":
                            replyText = "ðŸ“Ÿ Interactive Button";
                            break;
                        case "24":
                            replyText = "ðŸ–¼ Post";
                            break;
                        case "25":
                            replyText = "ðŸ‘¤ Profile";
                            break;
                        case "26":
                            replyText = "ðŸŒŸ Sticker not Support";
                            break;
                        case "27":
                            replyText = "ðŸ“ƒ Template Message";
                            break;
                        default:
                            break;
                    }
                    $("#replyTextElm").text(Inbox.Function.msgTranslator(replyText));

                    $("#emoji")[0].emojioneArea.setFocus();

                    if ($("#previewReplyElm").is(":hidden"))
                        $("#previewReplyElm").slideToggle(200)
                });

                //kontak multiple
                $(".classContactMulti").unbind("click");
                $(".classContactMulti").on("click", function () {
                    let strKontak = $(this).attr("data-contact-multi");
                    let dlg = new Nobox.ContactMultipleDialog();
                    dlg.showFromInbox(strKontak);
                    dlg.loadNewAndOpenDialog();
                });

                //download 1 kontak menjadi vcard
                $(".DownloadVcard").unbind("click");
                $(".DownloadVcard").on("click", function () {
                    let strKontak = $(this).attr("data-vcard");
                    let dataKontak = Inbox.Function.vCard2List(strKontak);
                    Inbox.Function.downloadFile(strKontak, dataKontak.fn + ".vcf", "text/vcard");
                });

                //download multi kontak menjadi vcard
                $(".DownloadVcardMulti").unbind("click");
                $(".DownloadVcardMulti").on("click", function () {
                    let strKontak = $(this).attr("data-vcard");
                    let arrKontak = JSON.parse(strKontak);
                    Q.confirm(Q.text("Site.Inbox.DownloadContact").replace("{value}", `${arrKontak.length}`), () => {
                        arrKontak.forEach((obj) => {
                            let objKontak = Inbox.Function.vCard2List(obj)
                            Inbox.Function.downloadFile(obj, objKontak.fn + ".vcf", "text/vcard");
                        });
                    });
                });

                $(".btn-detail-transaction").unbind("click");
                $(".btn-detail-transaction").on("click", function () {
                    let strOrder = $(this).closest('.rowInv').attr("data-id");
                    let dlg = new Nobox.InteractiveOrderDialog();
                    dlg.showFromInbox(strOrder);
                    dlg.loadNewAndOpenDialog();
                });

                //Interactive order (menuju ke invoice ke channel masing2) 
                $(".btn-goto-transaction").unbind("click");
                $(".btn-goto-transaction").on("click", function () {
                    let strOrder = $(this).closest('.rowInv').attr("data-id");
                    let objOrder = JSON.parse(strOrder);
                    if ("url_invoice" in objOrder) {
                        if (!Q.isEmptyOrNull(objOrder.url_invoice)) {
                            window.open(objOrder.url_invoice);
                        } else {
                            Q.alert(Q.text("Site.Inbox.NoLinkInvoice"));
                        }
                    } else {
                        Q.alert(Q.text("Site.Inbox.NoLinkInvoice"));
                    }
                });

                //Interactive order add transaction
                $(".btn-plus-transaction").unbind("click");
                $(".btn-plus-transaction").on("click", async function () {
                    let dataKontak = Inbox.DataRoomActive.ContactReal;
                    if (dataKontak != null) {
                        let strOrder = $(this).closest('.rowInv').attr("data-id");
                        let objOrder = JSON.parse(strOrder);
                        let deskripsi = `No: ${objOrder.id_pesanan}\n\n`;
                        let itemsPdt = JSON.parse(objOrder.items);
                        let subtotal = 0;
                        itemsPdt.forEach((yz) => {
                            let harga = yz.Jumlah * yz.harga;
                            deskripsi += `- ${yz.Nama}: ${objOrder.mata_uang
                                } ${Inbox.Function.autoNumericFormatter(harga)
                                }\n`;
                            subtotal += harga;
                        });
                        deskripsi += `\n\nSubtotal: ${objOrder.mata_uang
                            } ${Inbox.Function.autoNumericFormatter(subtotal)}\nDiscount: ${objOrder.mata_uang
                            } ${objOrder.diskon == undefined
                                ? 0
                                : Inbox.Function.autoNumericFormatter(objOrder.diskon)
                            }\nShipping Cost: ${objOrder.mata_uang} ${objOrder.ongkir == undefined
                                ? 0
                                : Inbox.Function.autoNumericFormatter(objOrder.ongkir)
                            }\nTax: ${objOrder.mata_uang} ${objOrder.pajak == undefined
                                ? 0
                                : Inbox.Function.autoNumericFormatter(objOrder.pajak)
                            }`;

                        let idPesan = $(this).parents(".is-me").attr("id");
                        if (idPesan == undefined)
                            idPesan = $(this).parents(".is-you").attr("id");

                        if (idPesan != undefined)
                            idPesan = idPesan.replace("chatidchat-container", "");

                        let hasil = await connection.invoke("CheckDeal", idPesan);
                        if (!hasil) {
                            let dlg = new Nobox.CRM.DealsDialog();
                            let pipeline = $.cookie("Pipeline");
                            let stage = $.cookie("Stage");
                            dlg.loadEntityAndOpenDialog({
                                Prc: objOrder.total_harga,
                                CtDeal: [{ CtId: dataKontak.Id, CtNm: dataKontak.Name }],
                                CtIds: idPesan,
                                PdtIds: "OrderInbox",
                                Pdt: deskripsi,
                                Nm: `${Inbox.DataRoomActive.Account.ChannelNm} - ${objOrder.id_pesanan} - ${dataKontak.Name}`,
                                PlId: pipeline ?? null,
                                piplinetypes: stage ?? null,
                            });
                        } else {
                            Q.notifyInfo(Q.text("Site.Inbox.MsgRecordDeal"));
                        }
                    } else {
                        Q.notifyInfo(Q.text("Site.Inbox.addLinkToContact"));
                    }
                });

                //klik jika pesan tidak terkirim
                $(`[data-error-id=${m.Id}]`).unbind(`click`);
                $(`[data-error-id=${m.Id}]`).on("click", function () {
                    let dlgErr = new Nobox.DialogErrorDialog();
                    dlgErr.loadEntityAndOpenDialog({
                        ErrorMessage: $(this).attr("data-error"),
                    });
                });

                //untuk button quick reply
                $(".btnReplyTextMsg").unbind("click");
                $(".btnReplyTextMsg").on("click", function () {
                    let data = $(this).attr("data-msg");
                    $(".chat-send").attr("data-msg", data);
                    $(".chat-send").click();
                });

                //read more
                $(".toggle-readmore").unbind("click");
                $(".toggle-readmore").on("click", function () {
                    let parent = this.parentElement;
                    let shortText = parent.querySelector('.short-text');
                    let fullText = parent.querySelector('.full-text');
                    if (shortText.style.display === 'none') {
                        shortText.style.display = 'inline';
                        fullText.style.display = 'none';
                        this.innerText = 'Read more';
                    } else {
                        shortText.style.display = 'none';
                        fullText.style.display = 'inline';
                        this.innerText = 'Read less';
                    }
                });
            },
            msgTranslator: (msg) => {
                return String(msg)
                    .replace("Site.Inbox.PaymentPaid", Q.text("Site.Inbox.PaymentPaid"))
                    .replace("Site.Inbox.PaymentPending", Q.text("Site.Inbox.PaymentPending"))
                    .replace("Site.Inbox.StatusPreparing", Q.text("Site.Inbox.StatusPreparing"))
                    .replace("Site.Inbox.StatusPayRequest", Q.text("Site.Inbox.StatusPayRequest"))
                    .replace("Site.Inbox.StatusShipped", Q.text("Site.Inbox.StatusShipped"))
                    .replace("Site.Inbox.StatusDelivered", Q.text("Site.Inbox.StatusDelivered"))
                    .replace("Site.Inbox.StatusCanceled", Q.text("Site.Inbox.StatusCanceled"))
                    .replace("Site.Inbox.OrderConfirm", Q.text("Site.Inbox.OrderConfirm"))
                    .replace("Site.Inbox.OrderReject", Q.text("Site.Inbox.OrderReject"));
            },
            updateData: (dt) => {
                let objDt = Inbox.Function.isValidJson(dt);
                if (!objDt.err) {
                    let data = objDt.data;
                    switch (data.Menu) {
                        case "Tag":
                            let indT = Inbox.Data.Tags.findIndex(t => t.Id == data.Data.Id);
                            if (indT == -1)
                                Inbox.Data.Tags.push({ Id: data.Data.Id, Nm: data.Data.Nm })

                            if ($("#tagskanan").find("option[value='" + data.Data.Id + "']").length == 0) {
                                // Create a DOM Option and pre-select by default
                                let newOption = new Option(data.Data.Nm, data.Data.Id, true, false);
                                // Append it to the select
                                $("#tagskanan").append(newOption).trigger("change");
                            }
                            break;
                        default:
                            break;
                    }
                }
            },
            MsgAction: {
                deleteMsg: (id) => {
                    Q.confirm(
                        Q.text("Site.Inbox.ConfirmDelMsg"),
                        async () => {
                            await connection.invoke(
                                "DelMsg",
                                Inbox.DataRoomActive.Room.Id,
                                Number(id)
                            );
                        },
                        {
                            onNo: () => { },
                        }
                    );
                },
            },
            TemplateElmMsg: {
                Part: {
                    TimeZone: $.cookie("timezone"),
                    isMe: (from) => {
                        let str = "is-you";
                        if (Inbox.Default.Acccounts.filter((d) => d.Id == from).length > 0)
                            str = "is-me";
                        return str;
                    },
                    bubbleColor: (from, agentId) => {
                        let clrBubble = "chatsss";
                        if (Inbox.Default.Acccounts.filter((d) => d.Id == from).length > 0) {
                            clrBubble = "chatss";
                            if (agentId == Inbox.Info.currentUser().UserId)
                                clrBubble = "chats";
                        } else {
                            if (agentId == 0) {
                                clrBubble = "chatss";
                            } else {
                                clrBubble = "chatsss";
                            }
                        }
                        return clrBubble;
                    },
                    ack: (st, id, note) => {
                        let ackCnt;
                        switch (st) {
                            case 1:
                                ackCnt = `<li id="ack${id}"><i class="fas fa-clock"></i></li>`;
                                break;
                            case 2:
                                ackCnt = `<li id="ack${id}"><i class="fas fa-check"></i></li>`;
                                break;
                            case 3:
                                ackCnt = `<li id="ack${id}"><i class="fas fa-check-double"></i></li>`;
                                break;
                            case 5:
                                ackCnt = `<li id="ack${id}"><i class="fas fa-check-double text-primary"></i></li>`;
                                break;
                            case 4:
                                ackCnt = `<li data-error="${note}" data-error-id="${id}" id="ack${id}"><i style="cursor:pointer;" class="fas fa-exclamation-circle text-danger"></i></li>`;
                                break;
                            default:
                                ackCnt = "";
                                break;
                        }
                        return ackCnt;
                    },
                    chatMeta: function (m, isFromMe = true) {
                        let sndr = "Not Found";
                        let akun = Inbox.Default.Acccounts.filter((d) => d.Id == m.From);
                        if (akun.length > 0) {
                            if (m.IsNobox == 1) {
                                sndr = m.Note == "Nobox" ? "Bot" : (Q.isEmptyOrNull(m.Note) ? "Nobox ChatManager" : (m.Ack == 4 ? "Nobox ChatManager" : m.Note));
                            } else if (m.AgentId == 0) {
                                sndr = "Bot";
                            } else {
                                let user = Inbox.Default.Users.filter(u => u.UserId == m.AgentId);
                                if (user.length > 0) {
                                    user = user[0];
                                    sndr = user.DisplayName;
                                    if (user.UserId == Inbox.Info.currentUser().UserId)
                                        sndr = `Me (${user.DisplayName})`;
                                }
                            }
                        } else {
                            let link = Inbox.DataRoomActive.Link;
                            if (link != null) {
                                sndr = link.Name;
                                let contact = Inbox.DataRoomActive.ContactReal;
                                if (contact != null)
                                    sndr = contact.Name;
                            } else {
                                let group = Inbox.DataRoomActive.Group;
                                if (group != null)
                                    sndr = group.Name;
                            }
                        }

                        let timeSent = moment(m.In).utc();
                        return `<ul class="chat-meta mt-0">
                                    <li class="contactNameExternal" style="flex:none;">${sndr}</li>
                                    <li style="flex:none;">
                                        <abbrds class="timeago label" title="${timeSent}">${timeSent}</abbrds>
                                    </li>
                                    ${(isFromMe ? this.ack(m.Ack, m.Id, m.Note) : "")}
                                    ${(m.InteractiveType != 99 ? "" : `<li class="fw-bold">${Q.text("Site.Inbox.EditedMsg")}</li>`)}
                                </ul>`;
                    },
                    chatAction: (id, isMsgAction = true) => {
                        if (Inbox.DataRoomActive.Room.St == 3 || Inbox.DataRoomActive.Room.St == 4 || !isMsgAction) {
                            return `<ul class="chat-msg-more lkbtn" style="cursor:default;"></ul>`;
                        } else {
                            return `<ul class="chat-msg-more" style="gap: 5px;">
                                    <li class="p-0">
                                        <span href="#" class="lkbtn lkbtn-icon lkbtn-sm lkbtn-trigger ReplyMsg" data-id-msg="${id}">
                                            <em class="icon ni ni-reply-fill"></em>
                                        </span>
                                    </li>
                                    <li class="p-0">
                                        <span href="#" class="lkbtn lkbtn-icon lkbtn-sm lkbtn-trigger DeleteMsg" data-id-msg="${id}">
                                            <em class="icon ni ni-trash"></em>
                                        </span>
                                    </li>
                                </ul>`;
                        }
                    },
                    chatProfile: (m) => {
                        let profile = `<div class="chat-media user-lkavatar bg-transparent chat-profile-toggle" style="background-image: url(/Inbox/img/agent.png); background-size: cover; background-position: center;"></div>`;
                        let akun = Inbox.Default.Acccounts.filter((d) => d.Id == m.From);
                        if (akun.length > 0) {
                            if (m.IsNobox == 1) {
                                profile = `<div class="chat-media user-lkavatar bg-primary chat-profile-toggle">
                                                <span><i class="ni ni-user-fill" style="font-size: large;"></i></span>
                                            </div>`;
                            } else if (m.AgentId == 0) {
                                profile = `<div class="chat-media user-lkavatar bg-primary chat-profile-toggle">
                                                <span>B</span>
                                            </div>`;
                            } else {
                                let user = Inbox.Default.Users.filter(u => u.UserId == m.AgentId);
                                if (user.length > 0) {
                                    user = user[0];
                                    let urlProfile = `/Inbox/img/agent.png`;
                                    if (user.UseriImage)
                                        urlProfile = `/upload/${user.UserImage}`;
                                    profile = `<div class="chat-media user-lkavatar bg-transparent chat-profile-toggle" style="background-image: url(${urlProfile}); background-size: cover; background-position: center;"></div>`;
                                }
                            }
                        } else {
                            let link = Inbox.DataRoomActive.Link;
                            if (link != null) {
                                let photoUrl = !Q.isEmptyOrNull(Inbox.DataRoomActive.Room.LinkImg) ? Inbox.DataRoomActive.Room.LinkImg : !Q.isEmptyOrNull(Inbox.DataRoomActive.Room.CtImg) ? Inbox.DataRoomActive.Room.CtImg : `/Inbox/img/user.jpeg`;
                                profile = `<div class="chat-media user-lkavatar bg-transparent chat-profile-toggle contactProfileExternal" style="background-image: url(${photoUrl}); background-size: cover; background-position: center;"></div>`;
                                //link.Photo = link.Photo ? link.Photo : `/Inbox/img/user.jpeg`;
                                //let contact = Inbox.DataRoomActive.ContactReal;
                                //if (contact != null) {
                                //    contact.Photo = contact.Photo ? contact.Photo : link.Photo;
                                //    profile = `<div class="chat-media user-lkavatar bg-transparent chat-profile-toggle contactProfileExternal" style="background-image: url(${contact.Photo}); background-size: cover; background-position: center;"></div>`;
                                //}
                            } else {
                                let group = Inbox.DataRoomActive.Group;
                                if (group != null)
                                    profile = `<div class="chat-media user-lkavatar bg-transparent chat-profile-toggle" style="background-image: url(/Inbox/img/users.jpeg); background-size: cover; background-position: center;"></div>`;
                            }
                        }
                        return profile;
                    },
                    formatMsg: (text) => {
                        // Convert bold (e.g., *Bold*)
                        text = text.replace(/(?<!\w|https?:\/\/)(?<!\S)\*(.*?)\*(?!\S)(?!\w)/g, '<strong style="font-weight: bold;">$1</strong>');

                        // Convert italic (e.g., _Italic_)
                        text = text = text.replace(/(?<!\w|https?:\/\/)(?<!\S)_(.*?)_(?!\S)(?!\w)/g, '<em style="font-style: italic;">$1</em>');

                        // Convert strikethrough (e.g., ~Strikethrough~)
                        text = text.replace(/(?<!\w|https?:\/\/)(?<!\S)~(.*?)~(?!\S)(?!\w)/g, '<s style="text-decoration: line-through;">$1</s>');

                        // Convert monospace block code (e.g., ```Block Code```)
                        text = text.replace(/```([\s\S]*?)```/g, '<pre style="font-family: monospace;background-color: #f3f3f3;padding: 4px;border-radius: 4px;">$1</pre>');

                        // Convert inline monospace (e.g., `Inline Code`)
                        text = text.replace(/(?<!\w|https?:\/\/)(?<!\S)`(.*?)`(?!\S)(?!\w)/g, '<code style="font-family: monospace;background-color:rgb(243 243 243 / 16%);border-radius:4px;padding:2px;">$1</code>');

                        // Process bulleted and numbered lists
                        const lines = text.split('\n');
                        let result = '';
                        let inBulletedList = false;
                        let inNumberedList = false;

                        lines.forEach(line => {
                            if (/^- /.test(line)) {
                                // Handle bulleted list
                                if (!inBulletedList) {
                                    result += '<ul style="padding-left: 20px;">';
                                    inBulletedList = true;
                                }
                                if (inNumberedList) {
                                    result += '</ol>';
                                    inNumberedList = false;
                                }
                                result += `<li style="list-style-type: disc;">${line.substring(2).trim()}</li>`;
                            } else if (/^\d+\. /.test(line)) {
                                // Handle numbered list
                                if (!inNumberedList) {
                                    result += '<ol style="padding-left: 20px;">';
                                    inNumberedList = true;
                                }
                                if (inBulletedList) {
                                    result += '</ul>';
                                    inBulletedList = false;
                                }
                                result += `<li style="list-style-type: decimal;">${line.replace(/^\d+\.\s*/, '').trim()}</li>`;
                            } else if (/^> /.test(line)) {
                                // Handle blockquote
                                if (inBulletedList) {
                                    result += '</ul>';
                                    inBulletedList = false;
                                }
                                if (inNumberedList) {
                                    result += '</ol>';
                                    inNumberedList = false;
                                }
                                result += `<blockquote style="border-left: 4px solid #ccc; margin: 0; font-style: italic; background-color: rgb(243 243 243 / 16%); padding: 2px; border-radius: 4px;">${line.substring(2).trim()}</blockquote>`;
                            } else {
                                // Close any open lists if we encounter a non-list item
                                if (inBulletedList) {
                                    result += '</ul>';
                                    inBulletedList = false;
                                }
                                if (inNumberedList) {
                                    result += '</ol>';
                                    inNumberedList = false;
                                }
                                // Add non-list content with line breaks for empty lines
                                result += line.trim() ? `${line}<br>` : '<br>';
                            }
                        });

                        // Close any open lists at the end
                        if (inBulletedList) {
                            result += '</ul>';
                        }
                        if (inNumberedList) {
                            result += '</ol>';
                        }

                        return result;
                    }
                },
                sap: function (m) {
                    let dataSap = Inbox.Function.isValidJson(m.Msg);
                    if (!dataSap.err) {
                        let objSap = dataSap.data;
                        if (objSap.userHandle == "customer") {
                            m.Msg = "<b>Customer </b>" + Q.text(objSap.msg);
                        } else {
                            let objUserHandle = Inbox.Default.Users.filter(xy => xy.UserId == objSap.userHandle);
                            if (objUserHandle.length > 0) {
                                m.Msg = (objSap.msg.search("HasResolveBy") != -1 || objSap.msg.search("HasArchiveBy") != -1 || objSap.msg.search("HasRestoreBy") != -1) ? `${Q.text(objSap.msg)} <b>${objUserHandle[0].DisplayName}</b>` : `<b>${objUserHandle[0].DisplayName}</b> ${Q.text(objSap.msg)}`;
                                let objUser = Inbox.Default.Users.filter(xy => xy.UserId == objSap.user);
                                if (objUser.length > 0)
                                    m.Msg = objSap.msg != "Site.Inbox.TransferTo" ? `<b>${objUserHandle[0].DisplayName}</b> ${Q.text(objSap.msg)} <b>${objUser[0].DisplayName}</b>` : `<b>${objUser[0].DisplayName}</b> ${Q.text(objSap.msg)} <b>${objUserHandle[0].DisplayName}</b>`;
                            } else {
                                m.Msg = Q.text(objSap.msg);
                            }
                        }
                    }

                    let day = ``;
                    const dateToCheck = moment.tz(m.In, "Asia/Jakarta");
                    const today = moment.tz("Asia/Jakarta").startOf('day');
                    const isToday = dateToCheck.isSame(today, 'day');
                    if (isToday) {
                        day = `${Q.text("Site.Inbox.TodayAt")} `
                    } else {
                        const yesterday = moment.tz("Asia/Jakarta").subtract(1, 'days').startOf('day');
                        const isYesterday = dateToCheck.isSame(yesterday, 'day');
                        if (isYesterday) {
                            day = `${Q.text("Site.Inbox.YesterdayAt")} `
                        } else {
                            day = `${dateToCheck.format("DD MMM YYYY")} `
                        }
                    }

                    return `<div class="chat-sap ml-4 mr-4">
                                    <div class="chat-sap-meta"><span>${day}${dateToCheck.format("HH:mm")}  - ${m.Msg}</span></div>
                                </div>`
                },
                reply: function (m, row = 1, mb = 0) {
                    if (Q.isEmptyOrNull(m.ReplyId))
                        return '';
                    let akun = Inbox.Default.Acccounts.filter((d) => d.Id == m.ReplyFrom);
                    let sndr = Q.text("Site.Inbox.NotFound");
                    if (akun.length > 0) {
                        sndr = `Me (${akun[0].Name})`;
                    }
                    else {
                        if (Q.isEmptyOrNull(m.GrpMember)) {
                            let link = Inbox.DataRoomActive.Link;
                            if (link != null) {
                                sndr = link.Name;
                                let contact = Inbox.DataRoomActive.ContactReal;
                                if (contact != null)
                                    sndr = contact.Name;
                            }
                        } else {
                            sndr = m.RelpyGrpMember;
                        }
                    }
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let replyElm = ``;
                    let clrText = "text-dark";
                    if (Inbox.DataRoomActive.Account.Id == m.From)
                        clrText = "text-white";
                    let fileMsg = {};
                    switch (parseInt(m.ReplyType)) {
                        case 1:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${Inbox.Function.text2Url(m.ReplyMsg, clrBubble)}</div></div></a></div>`;
                            break;
                        case 2:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ”Š Audio</div></div></a></div>`;
                            break;
                        case 3:
                        case 7:
                            try {
                                fileMsg = JSON.parse(m.ReplyFiles);
                            } catch (e) {
                                return null;
                            }
                            let urlImg = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;width: 58px;"><div class="text ${clrText}"><div class="row"><div style="background-image: url('${urlImg}');width: 43px;background-size: cover;height: 43px;background-position: center;border-radius: 4px;margin-left: 5px;"></div><div class="col pl-1 "><div class="text ${clrText}" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${(Q.isEmptyOrNull(m.ReplyMsg) ? (m.ReplyType == 3 ? "ðŸ–¼ " + Q.text("Site.Inbox.Photo") : "ðŸŒŸ Sticker") : "ðŸ–¼ " + Inbox.Function.text2Url(m.ReplyMsg, clrBubble))}</div></div></div></div></a></div>`
                            break;
                        case 4:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${(Q.isEmptyOrNull(m.ReplyMsg) ? "ðŸŽ¬ Video" : "ðŸŽ¬ " + Inbox.Function.text2Url(m.ReplyMsg, clrBubble))}</div></div></a></div>`;
                            break;
                        case 5:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${(Q.isEmptyOrNull(m.ReplyMsg) ? "ðŸ“ Document" : "ðŸ“ " + Inbox.Function.text2Url(m.ReplyMsg, clrBubble))}</div></div></a></div>`;
                            break;
                        case 9:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${(Q.isEmptyOrNull(m.ReplyMsg) ? "ðŸ“ Location" : "ðŸ“ " + Inbox.Function.text2Url(m.ReplyMsg, clrBubble))}</div></div></a></div>`;
                            break;
                        case 10:
                            try {
                                fileMsg = JSON.parse(m.ReplyFiles);
                            } catch (e) {
                                return null;
                            }
                            let urlOrder = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                            //                        let objOrder = e.ReplyMsg.split("[-{=||=}-]");

                            //                        let mediaSend = `<div style="
                            //                            background-image: url('${urlUpload + filesMsg.Filename}'); 
                            //                            width: 63px; 
                            //                            background-size: cover; 
                            //                            height: 63px; 
                            //                            background-position: center; 
                            //                            border-radius: 4px; 
                            //                            margin-left: 5px;">
                            //                        </div>`;

                            //                        e.ReplyMsg = `
                            //<i class="fa fa-shopping-cart" style="font-size: 16px;"></i> 
                            //${objOrder[0]} items<br>
                            //${objOrder[1]} ${AutoNumericFormatter(objOrder[2])}`;

                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;width: 58px;"><div class="text ${clrText}"><div class="row"><div style="background-image: url('${urlOrder}');width: 43px;background-size: cover;height: 43px;background-position: center;border-radius: 4px;margin-left: 5px;"></div><div class="col pl-1 "><div class="text ${clrText}" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ›’ Order</div></div></div></div></a></div>`
                            break;
                        case 12:
                            let dataKontak = Inbox.Function.vCard2List(m.ReplyMsg);
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;width: 58px;"><div class="text ${clrText}"><div class="row"><div style="background-image: url('/Inbox/img/user.jpeg');width: 43px;background-size: cover;height: 43px;background-position: center;border-radius: 50%;margin-left: 5px;"></div><div class="col pl-1 "><div class="text ${clrText}" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;"><i class="ni ni-user-fill"></i> ${dataKontak.fn}</div></div></div></div></a></div>`
                            break;
                        case 13:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="row"><div class="col pl-1 ml-2"><div class="text ${clrText}" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;"><i class="ni ni-users-fill"></i> ${JSON.parse(m.ReplyMsg.split("[-<=|[]|=>-]")[0]).length} contacts</div></div></div></div></a></div>`
                            break;
                        case 16:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${Inbox.Function.text2Url(m.ReplyMsg, clrBubble)}</div></div></a></div>`;
                            break;
                        case 17:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">âŒ Storage Limit</div></div></a></div>`;
                            break;
                        case 18:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">âŒ Channel Limit</div></div></a></div>`;
                            break;
                        case 19:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ“ Interactive List</div></div></a></div>`;
                            break;
                        case 21:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ“Ÿ Interactive Button</div></div></a></div>`;
                            break;
                        case 24:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ–¼ Post</div></div></a></div>`;
                            break;
                        case 25:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ‘¤ Profile</div></div></a></div>`;
                            break;
                        case 26:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸŒŸ Sticker not supported</div></div></a></div>`;
                            break;
                        case 27:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">ðŸ“ƒ Template Message</div></div></a></div>`;
                            break;
                        default:
                            replyElm = `<div class="text-left alert alert-proreply alert-lightreply no-shadow mb-${mb}" style="padding:4px;white-space:pre-line;"><a href="#chatidchat-container${m.ReplyId}" class="alert-text text-dark highlightChatTrigger" style="text-decoration:none;"><div class="text ${clrText}"><div class="text" style="font-weight:600;">${sndr}</div><div class="text" style="display: -webkit-box; -webkit-line-clamp: ${row};line-height:1.1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${Inbox.Function.text2Url(m.ReplyMsg, clrBubble)}</div></div></a></div>`;
                            break;
                    }
                    return replyElm;
                },
                text: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    if (Q.isEmptyOrNull(m.Msg)) {
                        m.Msg = "";
                    }
                    let isLongMessage = m.Msg.length > 500;
                    let shortMessage = isLongMessage ? m.Msg.substring(0, 500) + '...' : m.Msg;

                    let shortMessageContent = Inbox.Function.text2Url(shortMessage, clrBubble);

                    let messageContent = Inbox.Function.text2Url(m.Msg, clrBubble);

                    return `<div class="chat-msg ${clrBubble}" style="max-width: 70%;">
                        ${this.reply(m)}
                        <div class="text ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "pt-1")}">
                            <span class="short-text" style="white-space: pre-line;word-wrap: break-word;">${shortMessageContent}</span>
                            <span class="full-text" style="display: none;white-space: pre-line;word-wrap: break-word;">${messageContent}</span>
                            ${isLongMessage ? `
                                <span class="toggle-readmore" ${clrBubble != "chatsss" ? "style='text-decoration: underline;color:white;font-weight: 600;display:block;padding-top:5px;padding-bottom:5px;width:100%;'" : "style='font-weight: 600;display:block;padding-top:5px;padding-bottom:5px;width:100%;'"}>Read more</span>
                            ` : ''}
                        </div>
                    </div>`;
                },
                image: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let urlImg = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    let msg = '';
                    if (!Q.isEmptyOrNull(m.Msg))
                        msg = `<br><div style="padding:5px 3px 1px 3px;white-space: pre-line;word-wrap: break-word;">${Inbox.Function.text2Url(m.Msg, clrBubble)}</div>`;
                    return `<div class="chat-msg chat-msg-text ${clrBubble}" style="max-width:275px;border-radius:5px;">
                                ${this.reply(m, 1)}
                                <a class="imgphotos${m.RoomId} cboxElement" href="${urlImg}"><img class="${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}" src="${urlImg}" alt="" style="max-width:265px;max-height:265px;border-radius:5px;"></a>
                                ${msg}
                            </div>`
                },
                sticker: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let reply = this.reply(m, 1);
                    let urlSticker = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    let elmSticker = '';
                    if (Inbox.Function.isVideo(urlSticker)) {
                        elmSticker = `<video class="${(Q.isEmptyOrNull(reply) ? "" : "mt-1")}" autoplay="" loop="" muted="" style="min-width:80px;max-width:150px;min-height:80px;max-height:150px;border-radius:5px;">
                                                      <source src="${urlSticker}" type="video/mp4">
                                                      Your browser does not support the video tag.
                                                    </video>`
                    }
                    else {
                        elmSticker = `<a class="stickerphotos${m.RoomId} cboxElement" href="${urlSticker}"><img src="${urlSticker}" class="${(Q.isEmptyOrNull(reply) ? "" : "m-1")}" alt="" style="min-width:80px;max-width:150px;min-height:80px;max-height:150px;border-radius:5px;"></a>`
                    }
                    let msg = '';
                    if (!Q.isEmptyOrNull(m.Msg))
                        msg = `<br><div style="padding:5px 3px 1px 3px;">${Inbox.Function.text2Url(m.Msg, clrBubble)}</div>`;
                    return `<div class="chat-msg chat-msg-text ${clrBubble}" style="text-align:center;max-width:275px;border-radius:5px;${(!Q.isEmptyOrNull(reply) ? "" : "background-color:transparent !important;")}">
                                ${reply}
                                ${elmSticker}
                                ${msg}
                            </div>`
                },
                video: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let urlVideo = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    let msg = '';
                    if (!Q.isEmptyOrNull(m.Msg))
                        msg = `<br><div style="padding:1px 3px 1px 3px;white-space: pre-line;word-wrap: break-word;">${Inbox.Function.text2Url(m.Msg, clrBubble)}</div>`;
                    return `<div class="chat-msg chat-msg-text ${clrBubble}" style="max-width:275px;border-radius:5px;">
                                ${this.reply(m, 1)}
                                <video controls="" src="${urlVideo}" style="max-width:265px;max-height:265px;border-radius:5px;"></video>
                                ${msg}
                            </div>`
                },
                audio: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let urlAudio = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    return `<div class="chat-msg ${clrBubble}" style="padding: 0.2rem 0.2rem;max-width:275px;">
                                ${this.reply(m, 1)}
                                <audio controls class="${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}" src="${urlAudio}" style="max-width:265px;"></audio>
                            </div>`
                },
                document: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let urlDocument = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    let msg = ``;
                    if (!Q.isEmptyOrNull(m.Msg))
                        msg = `<div class="p-1" style="white-space: pre-line;word-wrap: break-word;">${Inbox.Function.text2Url(m.Msg, clrBubble)}</div>`;
                    return `<div class="chat-msg ${clrBubble}" style="max-width: min-content !important; padding: 0.2rem 0.2rem;">
                                ${this.reply(m, 1)}
                                <a style="cursor: pointer;" onclick="window.open('${urlDocument}', '_blank')">
                                    <div class="icon-file p-1" style="min-width: 250px;">
                                        <div class="user-lkavatar" style="margin-left: 3px;">
                                            <i class="fa fa-file-alt" style="font-size: 30px;"></i>
                                        </div>
                                        <div class="col-10 pl-0 ml-1 user-info">
                                            <span class="text">${fileMsg.OriginalName}</span>
                                            <br>
                                            <span style="font-size: 10px;"></span>
                                        </div>
                                    </div>
                                </a>
                                ${msg}
                            </div>`
                },
                location: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = { Filename: "/Inbox/img/map.jpg" };
                    try {
                        if (!Q.isEmptyOrNull(m.File))
                            fileMsg = JSON.parse(m.File);
                    } catch (e) {
                    }

                    let latLong = m.Msg.split("[-{=||=}-]");
                    let hrefMap = `https://www.google.com/maps?q=${latLong[0] || ""},${latLong[1] || ""}&z=21`;
                    if (!Q.isEmptyOrNull(latLong[2])) {
                        hrefMap = `https://www.google.com/maps/search/${latLong[2] || ""}/@${latLong[0] || ""},${latLong[1] || ""},21z`;
                    }
                    let msg = '';
                    if (!Q.isEmptyOrNull(latLong[2]))
                        msg = `<br><div style="padding:5px 3px 1px 3px;white-space: pre-line;word-wrap: break-word;">${Inbox.Function.text2Url(latLong[2], clrBubble)}</div>`;
                    return `<div class="chat-msg chat-msg-text ${clrBubble}" style="max-width:175px;border-radius:5px;">
                                ${this.reply(m, 1)}
                                <a title="Go to Google Maps" href="${hrefMap}" target="_blank" style="cursor:pointer;">
                                    <img class="${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}" src="${fileMsg.Filename}" alt="" style="max-width:165px;max-height:165px;border-radius:5px;">
                                </a>
                                ${msg}
                            </div>`
                },
                order: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let fileMsg = {};
                    try {
                        fileMsg = JSON.parse(m.File);
                    } catch (e) {
                        return null;
                    }
                    let urlImg = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    let objOrder = m.Msg.split("[-{=||=}-]");
                    return `<div class="chat-msg ${clrBubble}" style="max-width:20rem;;padding: 0.2rem 0.2rem;"> 
                                ${this.reply(m, 1)}
                                <div class="p-1 fw-light">${Q.text("Site.Inbox.Order")}</div>
                                <div class="row px-1 pb-1" style="margin-left: 0;">
                                    <div style="background-image: url('${urlImg}');width: 50px;background-size: cover;height: 50px;background-position: center;border-radius: 6px;"></div>
                                    <div class="col pl-1 pr-3" style="margin:auto;">
                                        <div class="text text-bold ">
                                            <i class="fa fa-shopping-cart" style="font-size:20px;margin-left:-3px;"></i> 
                                            ${(objOrder[4] ? objOrder[4] : objOrder[0] + " items")}
                                        </div>
                                        <div class="text" style="display: -webkit-box; -webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${objOrder[1]} ${Inbox.Function.autoNumericFormatter(objOrder[2])}</div>
                                    </div>
                                </div>
                                <div class="row rowInv text-center gx-1" style="cursor: pointer;">
                                    <div class="col-12">
                                        <a class="py-1 text-primary fw-bold btn-interactive" title="" style="border-radius: 4px;margin-top:3px;width:100%;display:block;">${Q.text("Site.Inbox.Detail")}</a>
                                    </div>
                                </div>
                            </div>`
                },
                catalog: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let objData = {}, arrData = m.Msg.split("[<|-=[apa]=-|>]");
                    try {
                        objData = JSON.parse(arrData[0]);
                    } catch (e) {
                        return null;
                    }
                    let msg = '';
                    if (!Q.isEmptyOrNull(arrData[1]))
                        msg = `<div style="padding:1px 3px 1px 3px;white-space: pre-line;word-wrap: break-word;">${Inbox.Function.text2Url(arrData[1], clrBubble)}</div>`;
                    return `<div class="chat-msg ${clrBubble}" style="max-width:20rem;;padding: 0.2rem 0.2rem;"> 
                                ${this.reply(m, 1)}
                                <div class="p-1 fw-light">${Q.text("Site.Inbox.Catalog")}</div>
                                <div class="row px-1 pb-1" style="margin-left: 0;">
                                    <div style="background-image: url('${objData.Image}');width: 50px;background-size: cover;height: 50px;background-position: center;border-radius: 6px;"></div>
                                    <div class="col pl-1 pr-3 ml-1" style="margin:auto;">
                                        <div class="text text-bold ">
                                            <i class="fa fa-store-alt" style="font-size:15px;margin-left:-3px;"></i>
                                            ${objData.Name}
                                        </div>
                                        <div class="text" style="display: -webkit-box; -webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${objData.Price.split("|")[0]} ${Inbox.Function.autoNumericFormatter(objData.Price.split("|")[1])}</div>
                                    </div>
                                </div>
                                ${msg}
                            </div>`
                },
                contact: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let dataKontak = Inbox.Function.vCard2List(m.Msg);
                    if (JSON.stringify(dataKontak) == "{}") return "";
                    if (dataKontak.length != 0) {
                        return `<div class="chat-msg ${clrBubble}" style="max-width:306px !important;padding: 0.2rem 0.2rem;">
                                    ${this.reply(m, 1)}
                                    <div class="row no-gutters ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                        <div class="col-2">
                                            <i class="ni ni-user-fill" style="font-size: 38px;"></i>
                                        </div>
                                        <div class="col-8 pl-1 pr-4" style="margin:auto;">
                                            <div class="text text-bold ">${dataKontak.fn}</div>
                                            <div class="text" style="display: -webkit-box; -webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${dataKontak.tel[0].value[0]}</div>
                                        </div>
                                        <div class="pl-0 DownloadVcard col-2" data-vcard="${m.Msg}" title="Download vcard">
                                            <i class="ni ni-download" style="font-size: 35px;cursor: pointer;"></i>
                                        </div>
                                    </div>
                                </div>`
                    } else {
                        return "";
                    }
                },
                contactMulti: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let arrMsg = m.Msg.split("[-<=|[]|=>-]");
                    if (Inbox.Function.isValidJson(arrMsg[0]).err) return "";
                    let arrKontak = JSON.parse(arrMsg[0]);
                    return `<div class="chat-msg ${clrBubble}" style="max-width:306px !important;padding: 0.2rem 0.2rem;cursor:pointer;">
                            ${this.reply(m, 1)}
                            <div class="row ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                <div class="col-10 row classContactMulti mr-1" 
                                     data-contact-multi='${JSON.stringify(arrKontak).replace(/'/g, "&apos;")}'>
                                    <div style="width: 50px;margin-left:3px;">
                                    <i class="ni ni-users-fill" style="font-size: 38px;"></i>
                                </div>
                                <div class="col pl-1 pr-0" style="margin:auto;">
                                    <div class="text text-bold ">
                                        ${Inbox.Function.vCard2List(arrKontak[0]).fn} ${Q.text("Site.Inbox.and")} ${arrKontak.length - 1} ${Q.text("Site.Inbox.otherContacts")}
                                    </div>
                                </div>
                            </div>
                            <div class="pr-1 DownloadVcardMulti col-2 text-right" data-vcard='${JSON.stringify(arrKontak).replace(/'/g, "&apos;")}' title="Download all vcard">
                                <i class="ni ni-download" style="font-size: 35px;cursor: pointer;"></i>
                            </div>
                        </div>
                    </div>`;
                },
                interactiveOrder: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let objMsg = JSON.parse(m.Msg);
                    let poto = {};
                    try {
                        poto = JSON.parse(objMsg.foto);
                    } catch (er) {
                        return;
                    }
                    return `<div class="chat-msg ${clrBubble}" style="max-width:306px !important;padding: 0.2rem 0.2rem;cursor:pointer; min-width: 250px;">
                                <div class="p-1 fw-light">${Q.text("Site.Inbox.Order")} #${objMsg.id_pesanan}</div>
                                <div class="row">
                                    <div style="background-image: url('${(Inbox.Function.isValidUrl(poto.Filename) ? poto.Filename : `/upload/${poto.Filename}`)}');width: 40px;background-size: cover;height: 40px;background-position: center;border-radius: 6px;margin-left: 20px;"></div>
                                    <div class="col pl-1 pr-3" style="margin:auto;">
                                        <div class="text text-bold" style="display: -webkit-box; -webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${objMsg.nama_produk}</div>
                                        <div class="text" style="display: -webkit-box; -webkit-line-clamp: 1;-webkit-box-orient: vertical;overflow: hidden;text-overflow: ellipsis;">${Q.text("Site.Inbox.Amount")} ${objMsg.jumlah_produk}</div>
                                    </div>
                                </div>
                                <div class="p-1 d-flex">
                                    <p class="mb-0">Total</p>
                                    <p class="ms-auto fw-bold">${objMsg.mata_uang} ${Inbox.Function.autoNumericFormatter(objMsg.total_harga)}</p>
                                </div>
                                <div class="row rowInv text-center gx-1" data-id='${m.Msg}'>
                                    <div class="col-6">
                                        <a class="py-1 text-primary fw-bold btn-interactive btn-detail-transaction" title="" style="border-radius: 4px;margin-top:3px;width:100%;display:block;" title="${Q.text("Site.Inbox.Detail")}">${Q.text("Site.Inbox.Detail")}</a>
                                    </div>
                                    <div class="col-6">
                                        <a class="py-1 text-primary fw-bold btn-interactive btn-goto-transaction" title="" style="border-radius: 4px;margin-top:3px;width:100%;display:block;" title="${Q.text("Site.Inbox.Invoice")}"><i class="fas fa-share"></i>&nbsp${Q.text("Site.Inbox.Invoice")}</a>
                                    </div>
                                    <div class="col-12">
                                        <a class="py-1 text-primary fw-bold btn-interactive btn-plus-transaction" title="" style="border-radius: 4px;margin-top:3px;width:100%;display:block;" title="+ ${Q.text("Site.Inbox.Deal")}">+ ${Q.text("Site.Inbox.Deal")}</a>
                                    </div>
                                </div>
                            </div>`;
                },
                unsupport: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    return `<div class="chat-msg ${clrBubble}" style="max-width:300px;">
                                ${this.reply(m, 1)}
                                <div class="row no-gutters text-center ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                    <i class="col-2 ni ni-cross-circle" style="font-size: 40px;"></i>
                                    <div class="col pl-1 pr-2" style="margin:auto;">
                                        <div class="fw-light ff-italic text-left">${Q.isEmptyOrNull(m.Msg) ? Q.text("Site.Inbox.NoSupportMessage") : m.Msg}</div>         
                                    </div>
                                </div>
                            </div>`
                },
                limitStorage: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    return `<div class="chat-msg ${clrBubble}" style="max-width: 300px;">
                                ${this.reply(m, 1)}
                                <div class="row no-gutters text-center ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                    <i class="col-2 fa fa-times-circle" style="font-size: 40px;"></i>
                                    <div class="col pl-1 pr-2" style="margin: auto;">
                                        <div class="fw-light ff-italic text-left">
                                            ${Q.text('Site.Inbox.LimitStorageMsg')}
                                        </div>
                                    </div>
                                </div>
                                <div class="row rowInv text-center gx-1">
                                    <div class="col-6">
                                        <a href="https://crm.nobox.ai/knowledge-base/article/berlangganan" target="_blank"
                                            class="py-1 text-primary fw-bold btn-interactive" 
                                            style="border-radius: 4px; margin-top: 3px; width: 100%; display: block;" 
                                            title="${Q.text("Site.Inbox.Guide")}">
                                            <i class="fas fa-book"></i>&nbsp;${Q.text("Site.Inbox.Guide")}
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <a href="https://crm.nobox.ai/services/category/8/server" target="_blank"
                                            class="py-1 text-primary fw-bold btn-interactive" 
                                            style="border-radius: 4px; margin-top: 3px; width: 100%; display: block;" 
                                            title="${Q.text("Site.Inbox.Upgrade")}">
                                            <i class="fas fa-share"></i>&nbsp;${Q.text("Site.Inbox.Upgrade")}
                                        </a>
                                    </div>
                                </div>
                            </div>`
                },
                limitChannel: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let indChannelUpgrade = Inbox.Info.currentUser().Channels.findIndex(ch => ch.Data === Inbox.DataRoomActive.Room.ChId);
                    let urlUpgrade = "https://crm.nobox.ai/services/category/7/unlimited";

                    if (indChannelUpgrade !== -1) {
                        const channelLevel = Inbox.Info.currentUser().Channels[indChannelUpgrade].Level;
                        if (channelLevel === "B") {
                            urlUpgrade = "https://crm.nobox.ai/services/category/6/professional";
                        } else if (channelLevel === "P") {
                            urlUpgrade = "https://crm.nobox.ai/services/category/7/unlimited";
                        } else {
                            urlUpgrade = "https://crm.nobox.ai/services/category/5/basic";
                        }
                    }

                    return `<div class="chat-msg ${clrBubble}" style="max-width: 300px;">
                                ${this.reply(m, 1)}
                                <div class="row no-gutters text-center ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                    <i class="col-2 ni ni-cross-circle" style="font-size: 40px;"></i>
                                    <div class="col pl-1 pr-2" style="margin: auto;">
                                        <div class="fw-light ff-italic text-left">${Q.text('Site.Inbox.LimitMsg')}</div>
                                    </div>
                                </div>
                                <div class="row rowInv text-center gx-1">
                                    <div class="col-6">
                                        <a target="_blank" href="https://crm.nobox.ai/knowledge-base/article/berlangganan" 
                                           class="py-1 text-primary fw-bold btn-interactive" 
                                           style="border-radius: 4px; margin-top: 3px; width: 100%; display: block;" 
                                           title="${Q.text("Site.Inbox.Guide")}">
                                            <i class="fas fa-book"></i>&nbsp;${Q.text("Site.Inbox.Guide")}
                                        </a>
                                    </div>
                                    <div class="col-6">
                                        <a target="_blank" href="${urlUpgrade}" 
                                           class="py-1 text-primary fw-bold btn-interactive" 
                                           style="border-radius: 4px; margin-top: 3px; width: 100%; display: block;" 
                                           title="${Q.text("Site.Inbox.Upgrade")}">
                                            <i class="fas fa-share"></i>&nbsp;${Q.text("Site.Inbox.Upgrade")}
                                        </a>
                                    </div>
                                </div>
                            </div>`
                },
                interactiveList: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let isJson = Inbox.Function.isValidJson(m.Msg);
                    if (isJson.err) return;

                    let jsonList = isJson.data;
                    let hasilMsg = ``;

                    if (jsonList?.header?.text) {
                        hasilMsg += `<b>${jsonList.header.text}</b><br><br>`;
                    }
                    if (jsonList?.footer?.text) {
                        hasilMsg += `${jsonList?.body?.text}<br><br>`;
                        hasilMsg += `<p class="fw-light ff-italic">${jsonList.footer.text}</p>`;
                    } else {
                        hasilMsg += jsonList?.body?.text;
                    }

                    return `<div class="chat-msg ${clrBubble}" style="max-width: 300px;">
                                ${this.reply(m, 1)}
                                <div class="row no-gutters text-center ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                    <div class="col pl-1 pr-2" style="margin: auto;">
                                        <div class="text-left">${Inbox.Function.text2Url(hasilMsg)}</div>
                                    </div>
                                </div>
                                <div class="row rowInv text-center gx-1">
                                    <div class="col-12">
                                        <div class="py-1 text-primary fw-bold btn-interactive listMenu" 
                                             data-menu='${JSON.stringify(jsonList.action.sections)}' 
                                             style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;" 
                                             title="${jsonList?.action?.button}">
                                            <i class="fas fa-bars text-primary"></i>&nbsp;${jsonList?.action?.button}
                                        </div>
                                    </div>
                                </div>
                            </div>`
                },
                interactiveButton: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let isJson = Inbox.Function.isValidJson(m.Msg);
                    if (isJson.err) return;

                    let jsonBtn = isJson.data;
                    let contentMsg = ``;

                    let fileMsg = {};
                    try {
                        if (m.File)
                            fileMsg = JSON.parse(m.File);
                        else
                            fileMsg = { Filename: "" }
                    } catch (e) {
                        fileMsg = { Filename: "" }
                    }
                    let urlInBtn = fileMsg.Filename.includes("https") || fileMsg.Filename.includes("http") ? fileMsg.Filename : Q.resolveUrl("~/upload/") + fileMsg.Filename;
                    if (jsonBtn?.header?.type === "image") {
                        contentMsg = `<a class="imgphotos${m.RoomId}" href="${urlInBtn}">
                                        <img src="${urlInBtn}" alt="" style="max-width:265px; max-height:265px; border-radius:5px;">
                                    </a>`;
                    } else if (jsonBtn?.header?.type === "video") {
                        contentMsg = `<video controls src="${urlInBtn}" style="max-width:265px; max-height:265px; border-radius:5px;"></video>`;
                    } else if (jsonBtn?.header?.type === "document") {
                        const fileName = fileMsg.OriginalName.length > 25 ? `${fileMsg.OriginalName.substr(0, 24)}...` : fileMsg.OriginalName;
                        const fileSizeInfo = fileMsg.FileSize ? `${fileMsg.FileSize} â€¢ ${fileMsg.Filename.split(".").pop().toUpperCase()}` : "";

                        contentMsg = `<a style="cursor: pointer;" onclick="window.open('${urlInBtn}', '_blank')">
                                        <div class="icon-file p-1" style="min-width:250px;max-width:265px;">
                                            <div class="user-lkavatar" style="margin-left:3px;">
                                                <i class="fa fa-file-alt" style="font-size:30px;"></i>
                                            </div>
                                            <div class="col-10 pl-0 pr-1 ml-1 user-info text-left" style="width:max-content;">
                                                <span class="text">${fileName}</span><br>
                                                <span style="font-size:10px;">${fileSizeInfo}</span>
                                            </div>
                                        </div>
                                    </a>`;
                    }

                    // Building the message content
                    let hasilMsg = '';
                    if (jsonBtn?.header?.text) {
                        hasilMsg += `<b>${jsonBtn.header.text}</b><br><br>`;
                    }
                    if (jsonBtn?.footer?.text) {
                        hasilMsg += `${jsonBtn?.body?.text}<br><br>`;
                        hasilMsg += `<p class="fw-light ff-italic">${jsonBtn.footer.text}</p>`;
                    } else {
                        hasilMsg += jsonBtn?.body?.text;
                    }
                    hasilMsg = Inbox.Function.text2Url(hasilMsg);
                    contentMsg += `<div class="row no-gutters text-center">
                                        <div class="col p-1" style="margin: auto;">
                                            <div class="text-left">${hasilMsg}</div>
                                        </div>
                                    </div>`;

                    // Building the button content
                    let btns = '';
                    let btnArray = jsonBtn?.action?.buttons;
                    if (btnArray) {
                        btnArray.forEach(b => {
                            btns += `<div class="col-12">
                                        <div class="py-1 text-primary fw-bold btn-interactive" 
                                                style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                            ${b?.reply?.title}
                                        </div>
                                    </div>`;
                        });
                        contentMsg += `<div class="row rowInv text-center gx-1">${btns}</div>`;
                    }

                    return `<div class="chat-msg text-center ${clrBubble}" style="max-width: 275px;">
                                ${this.reply(m, 1, 1)}
                                ${contentMsg}
                            </div>`;

                },
                post: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let isJson = Inbox.Function.isValidJson(m.Msg);
                    if (isJson.err)
                        return
                    let jsonList = isJson.data;
                    return `<div class="chat-msg ${clrBubble}" onclick="window.open('${jsonList.Link}')" style="${(jsonList.Link.includes('/stories/') ? 'max-width: 220px;' : 'max-width: 370px;')}">
                                ${this.reply(m, 1, 1)}
                                <div class="row no-gutters text-center" style="width: min-content;">
                                    ${(Q.isEmptyOrNull(jsonList.Username) ? `` : `<div class="col-12 px-1 pt-1 pb-0" style="margin:auto;">
                                        <div class="user-lkcard mb-1"><div class="user-lkavatar bg-transparent" style="background-image: url(${jsonList.UserImage});background-size: cover;background-position: center;width: 35px;height: 35px;"></div><div class="pl-0 ml-2 user-info"><span class="lead-text" style="font-size: 1.1rem;">${jsonList.Username}</span></div></div>
                                    </div>`)}
                                    <div class="col-12 p-1" style="margin:auto;display: flex;justify-content: center;align-items: center;min-width:200px;">
                                        <img src="${jsonList.Image}" style="border-radius: 5px;max-width: 270px;max-height: 270px;${(jsonList.Link.includes('/stories/') ? 'min-width:150px' : '')}">
                                        ${jsonList.Link.includes("/reel/") ? `<i class="ni ni-play-fill" style="font-size: 3rem;position: absolute;color: white;"></i>` : ``}
                                    </div>
                                    ${Q.isEmptyOrNull(jsonList.Caption) ? "" : `<div class="col-12 pl-1 pr-2" style="margin:auto;">
                                        <div class="text-left" style="white-space:pre-line;"><strong class="fw-bold">${(jsonList.Link.includes('/stories/') ? '' : Q.isEmptyOrNull(jsonList.Username) ? "" : jsonList.Username)}</strong> ${jsonList.Caption}</div>
                                    </div>`}
                                </div>
                            </div>`;
                },
                profile: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    let isJson = Inbox.Function.isValidJson(m.Msg);
                    if (isJson.err)
                        return
                    let jsonList = isJson.data;
                    return `<div class="chat-msg ${clrBubble}" onclick="window.open('${jsonList.Link}')">
                                ${this.reply(m, 1, 1)}
                                <div class="row no-gutters text-center">
                                    <div class="col-12 px-1 pt-1 pb-0" style="margin:auto;">
                                        <div class="user-lkcard mb-1">
                                            <div class="user-lkavatar bg-transparent" style="background-image: url(${jsonList.Image});background-size: cover;background-position: center;"></div>
                                            <div class="pl-0 user-info text-left ml-2">
                                                <span class="lead-text" style="font-size: 1.1rem;line-height: normal;">${jsonList.Username}</span>
                                                <span style="white-space:pre-line;">${jsonList.Displayname}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                ${jsonList.Caption}
                            </div>`;
                },
                stickerNotSupport: function (m) {
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);
                    return `<div class="chat-msg ${clrBubble}" style="max-width:300px;">
                                ${this.reply(m, 1)}
                                <div class="row no-gutters text-center ${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}">
                                    <i class="col-2 ni ni-cross-circle" style="font-size: 40px;"></i>
                                    <div class="col pl-1 pr-2" style="margin:auto;">
                                        <div class="fw-light ff-italic text-left">${Q.text("Site.Inbox.NoSupportIgSticker")}</div>         
                                    </div>
                                </div>
                            </div>`
                },
                template: function (m) {
                    let obj = JSON.parse(m.Msg);
                    let template = JSON.parse(obj.template);
                    let data = JSON.parse(obj.data);
                    let clrBubble = this.Part.bubbleColor(m.From, m.AgentId);

                    let contentMsg = ``;
                    template?.components.forEach(co => {
                        if (co.type) {
                            if (co.type == "HEADER") {
                                let header = data?.template?.components.filter(c => c.type == "header");
                                if (header.length > 0) {
                                    let headParam = header[0].parameters;
                                    if (headParam.length > 0) {
                                        let parameter = headParam[0];
                                        let type = parameter.type;
                                        switch (type) {
                                            case "text":
                                                contentMsg += `<p class="p-1 text-left mb-0 fw-bold">${parameter.text}</p>`
                                                break;
                                            case "image":
                                                parameter.image.link = Inbox.Function.isValidUrl(parameter.image.link) ? parameter.image.link : `/upload/${parameter.image.link}`
                                                contentMsg += `<a class="imgphotos${m.RoomId}" href="${parameter.image.link}">
                                                                    <img src="${parameter.image.link}" alt="" style="max-width:265px; max-height:265px; border-radius:5px;">
                                                                </a>`
                                                break;
                                            case "video":
                                                parameter.video.link = Inbox.Function.isValidUrl(parameter.video.link) ? parameter.video.link : `/upload/${parameter.video.link}`
                                                contentMsg += `<video controls src="${parameter.video.link}" style="max-width:265px; max-height:265px; border-radius:5px;"></video>`
                                                break;
                                            case "document":
                                                let url = Inbox.Function.isValidUrl(parameter.document.link) ? parameter.document.link : `/upload/${parameter.document.link}`;
                                                contentMsg += `<a style="cursor: pointer;" onclick="window.open('${url}', '_blank')">
                                                                <div class="icon-file p-1" style="min-width:250px;max-width:265px;">
                                                                    <div class="user-lkavatar" style="margin-left:3px;">
                                                                        <i class="fa fa-file-alt" style="font-size:30px;"></i>
                                                                    </div>
                                                                    <div class="col-10 pl-0 pr-1 ml-1 user-info text-left" style="width:max-content;">
                                                                        <span class="text">${url.substring(url.lastIndexOf('/') + 1)}</span>
                                                                    </div>
                                                                </div>
                                                            </a>`
                                                break;
                                            case "location":
                                                let location = parameter.location;
                                                let urlLocation = `https://www.google.com/maps?q=${location.latitude || ""},${location.longitude || ""}`;
                                                if (!Q.isEmptyOrNull(location.name)) {
                                                    urlLocation = `https://www.google.com/maps/search/${location.name || ""}/@${location.latitude || ""},${location.longitude || ""}`;
                                                }
                                                contentMsg += `<a title="Go to Google Maps" href="${urlLocation}" target="_blank" style="cursor:pointer;">
                                                                <img class="${(Q.isEmptyOrNull(m.ReplyId) ? "" : "mt-1")}" src="/Inbox/img/map.jpg" alt="" style="max-width:165px;max-height:165px;border-radius:5px;">
                                                            </a>`
                                                break;
                                        }
                                    }
                                } else {
                                    if (co.format) {
                                        if (co.format == "TEXT") {
                                            contentMsg += `<div class="row no-gutters">
                                                            <img src="/Inbox/img/product-not-found.png" class="col-2" style="border-radius: 5px;">
                                                            <div class="col-10 row no-gutters" style="align-items:center;">
                                                                <p class="col-12 p-1 text-left mb-0 fw-bold">${co.text}</p>
                                                            </div>
                                                        </div>`
                                        }
                                    }
                                }
                            }
                            else if (co.type == "BODY") {
                                let body = data?.template?.components.filter(c => c.type == "body");
                                if (body.length > 0) {
                                    let strBody = co.text.replace(/{{(\d+)}}/g, (match, index) => {
                                        return body[0].parameters[index - 1].text || match;
                                    });
                                    strBody = Inbox.Function.text2Url(strBody)
                                    contentMsg += `<p class="text-left mb-0 p-1">${strBody}</p>`;
                                } else {
                                    contentMsg += `<p class="text-left mb-0 p-1">${Inbox.Function.text2Url(co.text)}</p>`;
                                }
                            }
                            else if (co.type == "FOOTER") {
                                let strFooter = co.text;
                                if (strFooter)
                                    contentMsg += `<p class="fw-light ff-italic text-left p-1 mb-0">${strFooter}</p>`
                            }
                            else if (co.type == "BUTTONS") {
                                let btns = co.buttons;
                                const getValue = (sub_type, index) => {
                                    let btnsData = data?.template?.components.filter(c => c.type == "button" && c.sub_type == sub_type.toLowerCase() && c.index == index);
                                    let hasil = "";
                                    if (btnsData.length > 0) {
                                        let sub_type = btnsData[0].sub_type;
                                        let btnParam = btnsData[0].parameters[0];
                                        switch (sub_type) {
                                            case "url":
                                            case "text":
                                                hasil = btnParam.text
                                                break;
                                            case "copy_code":
                                                hasil = btnParam.coupon_code
                                                break;
                                        }
                                    }
                                    return hasil;
                                }
                                let elmBtns = ``;
                                btns.forEach((b, i) => {
                                    let type = b.type;
                                    switch (type) {
                                        case "URL":
                                            if (b.url.includes("otp_type=COPY_CODE") || b.url.includes("otp_type=ZERO_TAP") || b.url.includes("otp_type=ONE_TAP")) {
                                                if (b.example) {
                                                    elmBtns += `<div class="col-12">
                                                    <div onclick="navigator.clipboard.writeText('${getValue(type, i)}').then(() => {Q.notifySuccess('Text copied to clipboard!')})" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-copy"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                                } else {
                                                    elmBtns += `<div class="col-12">
                                                    <div onclick="Q.alert('No action!')" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-copy"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                                }
                                            } else {
                                                if (b.example) {
                                                    elmBtns += `<div class="col-12">
                                                    <div onclick="window.open('${b.url.replace(/{{(\d+)}}/g, getValue(type, i))}')" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-external-alt"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                                } else {
                                                    elmBtns += `<div class="col-12">
                                                    <div onclick="window.open('${b.url}')" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-external-alt"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                                }
                                            }
                                            break;
                                        case "PHONE_NUMBER":
                                            if (b.example) {
                                                elmBtns += `<div class="col-12">
                                                    <a href="tel:${b.phone_number.replace(/{{(\d+)}}/g, getValue(type, i))}" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-call"></i> ${b.text}
                                                    </a>
                                                </div>`;
                                            } else {
                                                elmBtns += `<div class="col-12">
                                                    <a href="tel:${b.phone_number}" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-call"></i> ${b.text}
                                                    </a>
                                                </div>`;
                                            }
                                            break;
                                        case "COPY_CODE":
                                            if (b.example) {
                                                elmBtns += `<div class="col-12">
                                                    <div onclick="navigator.clipboard.writeText('${getValue(type, i)}').then(() => {Q.notifySuccess('Text copied to clipboard!')})" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-copy"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                            } else {
                                                elmBtns += `<div class="col-12">
                                                    <div onclick="Q.alert('No action!')" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-copy"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                            }
                                            break;
                                        case "QUICK_REPLY":
                                            elmBtns += `<div class="col-12">
                                                    <div class="py-1 text-primary fw-bold btn-interactive btnReplyTextMsg" data-msg='${JSON.stringify({ text: b.text, idMsg: m.Id })}' style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                        <i class="ni ni-reply"></i> ${b.text}
                                                    </div>
                                                </div>`;
                                            break;
                                        case "CATALOG":
                                            elmBtns += `<div class="col-12">
                                                    <div onclick="Q.alert(&quot;Can't display the product yet!&quot;)" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                         ${b.text}
                                                    </div>
                                                </div>`;
                                            break;
                                        case "MPM":
                                            elmBtns += `<div class="col-12">
                                                    <div onclick="Q.alert(&quot;Can't display the product yet!&quot;)" class="py-1 text-primary fw-bold btn-interactive" style="cursor: pointer; border-radius: 4px; margin-top: 3px; width: 100%; display: block;">
                                                         ${b.text}
                                                    </div>
                                                </div>`;
                                            break;
                                    }
                                });
                                contentMsg += `<div class="row rowInv text-center gx-1">${elmBtns}</div>`;
                            }
                        }
                    })
                    return `<div class="chat-msg text-center ${clrBubble}" style="max-width: 275px;">
                                ${this.reply(m, 1, 1)}
                                ${contentMsg}
                            </div>`;
                },
                msg: function (m, selector, isMsgAction = true) {
                    if (m.Type == 6) {
                        return this.sap(m);
                    } else {
                        let strElm = ``;
                        switch (parseInt(m.Type)) {
                            case 1:
                                strElm = this.text(m);
                                break;
                            case 2:
                                strElm = this.audio(m);
                                break;
                            case 3:
                                strElm = this.image(m);
                                break;
                            case 4:
                                strElm = this.video(m);
                                break;
                            case 5:
                                strElm = this.document(m);
                                break;
                            case 7:
                                strElm = this.sticker(m);
                                break;
                            case 9:
                                strElm = this.location(m);
                                break;
                            case 10:
                                strElm = this.order(m);
                                break;
                            case 11:
                                strElm = this.catalog(m);
                                break;
                            case 12:
                                strElm = this.contact(m);
                                break;
                            case 13:
                                strElm = this.contactMulti(m);
                                break;
                            case 14:
                                strElm = this.interactiveOrder(m);
                                break;
                            case 15:
                                m.Msg = null;
                                strElm = this.unsupport(m);
                                break;
                            case 16:
                                strElm = this.unsupport(m);
                                break;
                            case 17:
                                strElm = this.limitStorage(m);
                                break;
                            case 18:
                                strElm = this.limitChannel(m);
                                break;
                            case 19:
                                strElm = this.interactiveList(m);
                                break;
                            case 21:
                                strElm = this.interactiveButton(m);
                                break;
                            case 24:
                                strElm = this.post(m);
                                break;
                            case 25:
                                strElm = this.profile(m);
                                break;
                            case 26:
                                strElm = this.stickerNotSupport(m);
                                break;
                            case 27:
                                strElm = this.template(m);
                                break;
                            default:
                                strElm = this.text(m);
                                break;
                        }

                        if (Q.isEmptyOrNull(strElm))
                            return null;

                        if (Inbox.Default.Acccounts.filter((d) => d.Id == m.From).length > 0) {
                            return `<div class="chat ${this.Part.isMe(m.From)} bubbleChat" id="chatid${selector.replace("#", "")}${m.Id}" style="width: 100%;">
                                <div class="chat-content" style="width: inherit;">
                                    <div class="chat-bubbles">
                                        <div class="chat-bubble">
                                            ${strElm}
                                            ${this.Part.chatAction(m.Id, isMsgAction)}
                                        </div>
                                    </div>
                                    ${this.Part.chatMeta(m)}
                                </div>
                                <div class="chat-lkavatar">
                                    ${this.Part.chatProfile(m)}
                                </div>
                            </div>`
                        }
                        else {
                            return `<div class="chat ${this.Part.isMe(m.From)} bubbleChat" id="chatid${selector.replace("#", "")}${m.Id}" style="width: 100%;">
                                <div class="chat-lkavatar">
                                    ${this.Part.chatProfile(m)}
                                </div>
                                <div class="chat-content" style="width: inherit;">
                                    <div class="chat-bubbles">
                                        <div class="chat-bubble">
                                            ${strElm}
                                            ${this.Part.chatAction(m.Id, isMsgAction)}
                                        </div>
                                    </div>
                                    ${this.Part.chatMeta(m, false)}
                                </div>
                            </div>`
                        }
                    }
                },
                showMsg(m, isAppend = false, withAnimation = false, selector = "#chat-container", isLoadMore = false, isMsgAction = true) {
                    if ($(`#chatid${selector}${m.Id}`).length == 0) {
                        let msg2Push = { ...m };
                        if (isAppend) {
                            if (withAnimation) {
                                $(this.msg(m, selector, isMsgAction)).hide().appendTo(selector).fadeIn(500);
                            } else {
                                $(selector).append(this.msg(m, selector, isMsgAction))
                            }
                        } else {
                            if (withAnimation) {
                                $(this.msg(m, selector, isMsgAction)).hide().prependTo(selector).fadeIn(500);
                            } else {
                                $(selector).prepend(this.msg(m, selector, isMsgAction))
                            }
                        }
                        if (!isLoadMore)
                            Inbox.Function.goToBottom(selector);
                        Inbox.Function.eventChatBubble(m, selector);
                        Inbox.ListMessages.push(msg2Push);
                    }
                }
            },
        },
        Info: {
            settingDefault: JSON.parse($("#ScriptDefault").html()),
            data: JSON.parse($("#inboxData").attr("data")),
            currentUser: function () {
                return this.data.userDefinition;
            },
            // getChannels: function () {
            //     return this.data.channels;
            // },
            isTrial: function () {
                return this.data.IsTrial;
            }
        }
    };

    //register serviceworker js (N O T I F I K A S I)
    if (window.history && window.history.pushState && window.orientation !== undefined) {
        $(window).on("popstate", function (e) {
            if (Q.isEmptyOrNull(window.location.hash)) {
                Inbox.IsBack = true;
                e.preventDefault();
                if ($("#chatselected").hasClass("show-chat"))
                    $("#chatselected").removeClass("show-chat");
            }
        });
    }

    //(C O N V E R S A T I O N)
    let Step = 0; //deklarasi messagehub untuk realtime menggunakan signalr
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/messagehub")
        .configureLogging(signalR.LogLevel.Information)
        .build();

    Step = 3; //deklarasi untuk membuka chat yang telah terbuka sebelumnya(sehabis browser direload)
    let IsPertamaLoad = true;

    Step = 4; //mengkonekkan ke server
    async function StartSignalR() {
        try {
            if (!connection.connectionStarted)
                await connection.start();

            Step = 6; //Klik Tab
            $("#allTab").on("click", function () {
                skeletonchat("all");
            });
            $("#unassignedTab").on("click", function () {
                skeletonchat("unassigned");
            });
            $("#assignedTab").on("click", function () {
                skeletonchat("assigned");
            });
            $("#resolvedTab").on("click", function () {
                skeletonchat("resolved");
            });

            Step = 7; //Klik tab agent
            $("#allTabAgent").on("click", function () {
                skeletonchatAgent("allAgent");
                $(".overflowchat").show();
                $(".noconversation").hide();
            });
            $("#assignedTabAgent").on("click", function () {
                skeletonchatAgent("ongoingAgent");
                $(".overflowchat").show();
                $(".noconversation").hide();
            });
            $("#resolvedTabAgent").on("click", function () {
                skeletonchatAgent("resolvedAgent");
                $(".overflowchat").show();
                $(".noconversation").hide();
            });

            //deklarasi emoji dan quick reply
            $("#emoji").emojioneArea({
                events: {
                    keypress: function (editor, evn) {
                        if (evn.which == 13) {
                            if (evn.shiftKey) {
                                // thruthy
                                // new line
                            } else {
                                evn.preventDefault();
                                $(".chat-send").click();
                            }
                            // return false;
                        }
                    },
                    ready: function () {
                        let i = 1;
                        $(".emojionearea-editor").each(function () {
                            let customID = "emojiEditor" + String(i);
                            $(this).attr("id", customID);
                            i++;
                        });
                        //Chat Template

                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/getDataDefault",
                            onSuccess: (response) => {
                                if (!response.IsError) {
                                    //Templates
                                    Inbox.Default.QuickReply = response.Data.Templates;

                                    //Accounts
                                    Inbox.Default.Acccounts = response.Data.Accounts;

                                    //Funnels
                                    let arrFns = [];
                                    if (response.Data.Funnels) {
                                        Inbox.Data.Funnels = response.Data.Funnels;
                                        if (Inbox.Data.Funnels.length > 0) {
                                            response.Data.Funnels.forEach(function (e, u) {
                                                arrFns.push({
                                                    id: e.Id,
                                                    text: e.Nm,
                                                    selected: false,
                                                });
                                                if (u == response.Data.Funnels.length - 1) {
                                                    $("#funnelskanan").lkselect2({
                                                        data: arrFns,
                                                        allowClear: true,
                                                    });
                                                }
                                            });
                                        } else {
                                            $("#funnelskanan").lkselect2({
                                                allowClear: true,
                                            });
                                        }
                                    }

                                    //Tags
                                    let arrTags = [];
                                    if (response.Data.Tags) {
                                        Inbox.Data.Tags = response.Data.Tags;
                                        if (Inbox.Data.Tags.length > 0) {
                                            response.Data.Tags.forEach(function (e, u) {
                                                arrTags.push({
                                                    id: e.Id,
                                                    text: e.Nm,
                                                    selected: false,
                                                });
                                                if (u == response.Data.Tags.length - 1) {
                                                    $("#tagskanan").lkselect2({
                                                        data: arrTags,
                                                    });
                                                }
                                            });
                                        } else {
                                            $("#tagskanan").lkselect2();
                                        }
                                    }

                                    //User Pada Tenant
                                    if (response.Data.Users) {
                                        Inbox.Default.Users = response.Data.Users;
                                    }

                                    //Ada data Unassigned dan Archived jika role user = Supervisor
                                    if (Q.Authorization.hasPermission("Role:Supervisor")) {
                                        //Archive Count
                                        //$("#countArchived").text(response.Data.Archived)

                                        //Unassigned Count
                                        $("#countUnassigned").html(
                                            "<b class='text-danger'>" +
                                            response.Data.Unassigned +
                                            "</b>"
                                        );
                                    }
                                }
                            },
                        });
                    },
                },
            });

            let initialTab = "";
            let inisialskeleton = false;

            Step = 8; //jalankan fungsi viewinbox
            ViewInbox();

            Step = 10; //buat fungsi inbox ini adalah tampilan agent atau supervisor
            async function ViewInbox() {
                if (!Q.Authorization.hasPermission("Role:Supervisor")) {
                    try {
                        const crUser = Inbox.Info.currentUser();
                        await connection.invoke(
                            "SubscribeUserAgent" /*, `${authBrowser}`*/,
                            `${crUser.UserId}`,
                            `${crUser.TenantId}`
                        );
                    } catch (error) {
                        console.error(error);
                    }
                    Step = 11; //jika agent tampilkan tampilan agent dan sembunyikan tampilan supervisor
                    $("#conversationAgent").show();
                    $("#HapusKetikaAgent").hide();
                    $("#conversationNonAgent").hide();

                    Step = 12; //set menjadi true
                    Inbox.IsAgentView = true;

                    Step = 13; //ambil room yang terdapat agent/user yang login saaat ini
                    if (inisialskeleton == false) {
                        let url = new URL(window.location.href);
                        let St =
                            url.searchParams.get("St") == null ||
                                url.searchParams.get("St") == "unassigned"
                                ? "all"
                                : url.searchParams.get("St");
                        $("#" + St + "TabAgent").click();
                        $("#" + St + "Agentchatlist").show();
                        inisialskeleton = true;
                        initialTab = St + "Agent";
                    }
                } else {
                    try {
                        await connection.invoke(
                            "SubscribeUserSpv",
                            `${Inbox.Info.currentUser().TenantId}`
                        );
                    } catch (error) {
                        console.error(error);
                    }
                    Step = 15; //tampikan tampilan supervisor dan sembuy=nyikan tampilan agent
                    $("#conversationNonAgent").show();
                    $("#HapusKetikaAgent").show();
                    $("#conversationAgent").hide();

                    Step = 16; //set jadi false
                    Inbox.IsAgentView = false;
                    if (inisialskeleton == false) {
                        let url = new URL(window.location.href);
                        let St =
                            url.searchParams.get("St") == null
                                ? "all"
                                : url.searchParams.get("St");
                        if (St == "archived") {
                            setTimeout(function () {
                                $("#cntAr").click();
                            }, 500);
                            St = "all";
                        }
                        $("#" + St + "Tab").click();
                        $("#" + St + "chatlist").show();
                        //BuatListConversation(St)
                        inisialskeleton = true;
                        initialTab = St;
                    }
                }
            }

            Step = 17; //buat fungsi untuk ambil setingan dari cookie
            function getCookie(val, name, format) {
                let tz = $.cookie(name);
                //console.log(val, name, format, tz)
                if (format == "Time") {
                    return moment(val).tz(tz).format("DD MMM YYYY, HH:mm");
                } else if (format == "TimeOnly") {
                    return moment.utc(val).tz(tz).format("HH:mm");
                } else if (format == "Date") {
                    return moment(val).tz(tz).format("DD MMM YYYY");
                } else if (format == "DateSap") {
                    return moment(val).tz(tz).format("YYYY-MM-DD");
                } else if (format == "DateAndDay") {
                    return moment(val).tz(tz).format("dddd, DD MMMM YYYY");
                }
            }

            function msgTranslator(msg) {
                return String(msg)
                    //.replace(/&/g, "&amp;")
                    //.replace(/</g, "&lt;")
                    //.replace(/>/g, "&gt;")
                    //.replace(/"/g, "&quot;")
                    .replace("Site.Inbox.PaymentPaid", Q.text("Site.Inbox.PaymentPaid"))
                    .replace("Site.Inbox.PaymentPending", Q.text("Site.Inbox.PaymentPending"))
                    .replace("Site.Inbox.StatusPreparing", Q.text("Site.Inbox.StatusPreparing"))
                    .replace("Site.Inbox.StatusPayRequest", Q.text("Site.Inbox.StatusPayRequest"))
                    .replace("Site.Inbox.StatusShipped", Q.text("Site.Inbox.StatusShipped"))
                    .replace("Site.Inbox.StatusDelivered", Q.text("Site.Inbox.StatusDelivered"))
                    .replace("Site.Inbox.StatusCanceled", Q.text("Site.Inbox.StatusCanceled"))
                    .replace("Site.Inbox.OrderConfirm", Q.text("Site.Inbox.OrderConfirm"))
                    .replace("Site.Inbox.OrderReject", Q.text("Site.Inbox.OrderReject"))
                    .replace("Site.Inbox.DeletedMessage", Q.text("Site.Inbox.DeletedMessage"));
            }

            Step = 19; //buat fungsi jika hari ini
            const isToday = (someDate) => {
                const today = new Date();
                return (
                    someDate.getDate() == today.getDate() &&
                    someDate.getMonth() == today.getMonth() &&
                    someDate.getFullYear() == today.getFullYear()
                );
            };

            Step = 20; //buat fungsi jika kemarin
            function isYesterday(date) {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                if (yesterday.toDateString() === date.toDateString()) {
                    return true;
                }

                return false;
            }

            Step = 21; //buat fungsi skeleteon
            function skeletonchat(par, src) {
                $("#" + par + "chatlist").show();
                if (IsPertamaLoad == true) {
                    let q = Q.parseQueryString();
                    if (q["Ag"]) {
                        BuatListConversation(
                            par,
                            src,
                            `{"ags":"${q["Ag"]}","tags":"","fn":"","chs":"","cp":"","dl":""}`
                        );
                        IsPertamaLoad = false;
                    } else {
                        BuatListConversation(par, src);
                    }

                    if (q["FResultId"]) {
                        if (q["RoomId"] && q["FTemplateId"]) {
                            let dlg = new Nobox.Nobox.SelectFormDialog();
                            dlg.onDialogClose = () => {
                                TampilMenuKanan();
                            };
                            dlg.callback = async (templateId, resultId) => {
                                TampilMenuKanan();
                                try {
                                    await connection.invoke(
                                        "MkForm",
                                        q["RoomId"],
                                        resultId,
                                        templateId
                                    );
                                    Q.notifySuccess(Q.text("Site.Inbox.AddedForm"));
                                } catch (error) {
                                    console.error(`MkForm Step = ${Step}, Msg = ${error}`);
                                }
                            };
                            dlg.IdRoom = q["RoomId"];
                            dlg.loadEntityAndOpenDialog({
                                FormResultId: q["FResultId"],
                                FormTemplateId: q["FTemplateId"],
                            });
                        } else if (q["LinkId"] && q["FTemplateId"]) {
                            let dlg = new Nobox.ChatroomsCreateDialog();
                            dlg.callback = (res) => {
                                if (!Q.isEmptyOrNull(res.Manual)) {
                                    let fisrtLater = res.Manual.charAt(0);
                                    let noHp = res.Manual;
                                    if (fisrtLater == "0")
                                        res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                                }
                                CreateNewConversation({
                                    AccId: Number(res.AccId),
                                    ChId: Number(res.ChId),
                                    LinkId: Q.isEmptyOrNull(res.LinkId)
                                        ? null
                                        : Number(res.LinkId),
                                    GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                                    Chat: Number(res.Chat),
                                    CtId: Q.isEmptyOrNull(res.Contact)
                                        ? null
                                        : Number(res.Contact),
                                    Manual: res.Manual,
                                    To: Number(res.To),
                                    FormTemplateId: Q.isEmptyOrNull(res.FormTemplateId)
                                        ? null
                                        : Number(res.FormTemplateId),
                                    FormResultId: Q.isEmptyOrNull(res.FormResultId)
                                        ? null
                                        : Number(res.FormResultId),
                                });
                            };
                            dlg.loadEntityAndOpenDialog({
                                FormResultId: q["FResultId"],
                                FormTemplateId: q["FTemplateId"],
                                To: 2,
                                Link: q["LinkId"],
                            });
                        } else if (q["IdExt"] && q["FTemplateId"]) {
                            let dlg = new Nobox.ChatroomsCreateDialog();
                            dlg.callback = (res) => {
                                if (!Q.isEmptyOrNull(res.Manual)) {
                                    let fisrtLater = res.Manual.charAt(0);
                                    let noHp = res.Manual;
                                    if (fisrtLater == "0")
                                        res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                                }
                                CreateNewConversation({
                                    AccId: Number(res.AccId),
                                    ChId: Number(res.ChId),
                                    LinkId: Q.isEmptyOrNull(res.LinkId)
                                        ? null
                                        : Number(res.LinkId),
                                    GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                                    Chat: Number(res.Chat),
                                    CtId: Q.isEmptyOrNull(res.Contact)
                                        ? null
                                        : Number(res.Contact),
                                    Manual: res.Manual,
                                    To: Number(res.To),
                                    FormTemplateId: Q.isEmptyOrNull(res.FormTemplateId)
                                        ? null
                                        : Number(res.FormTemplateId),
                                    FormResultId: Q.isEmptyOrNull(res.FormResultId)
                                        ? null
                                        : Number(res.FormResultId),
                                });
                            };
                            dlg.loadEntityAndOpenDialog({
                                FormResultId: q["FResultId"],
                                FormTemplateId: q["FTemplateId"],
                                To: 3,
                                Manual: q["IdExt"],
                            });
                        } else {
                            let dlg = new Nobox.ChatroomsCreateDialog();
                            dlg.callback = (res) => {
                                if (!Q.isEmptyOrNull(res.Manual)) {
                                    let fisrtLater = res.Manual.charAt(0);
                                    let noHp = res.Manual;
                                    if (fisrtLater == "0")
                                        res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                                }
                                CreateNewConversation({
                                    AccId: Number(res.AccId),
                                    ChId: Number(res.ChId),
                                    LinkId: Q.isEmptyOrNull(res.LinkId)
                                        ? null
                                        : Number(res.LinkId),
                                    GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                                    Chat: Number(res.Chat),
                                    CtId: Q.isEmptyOrNull(res.Contact)
                                        ? null
                                        : Number(res.Contact),
                                    Manual: res.Manual,
                                    To: Number(res.To),
                                    FormTemplateId: Q.isEmptyOrNull(res.FormTemplateId)
                                        ? null
                                        : Number(res.FormTemplateId),
                                    FormResultId: Q.isEmptyOrNull(res.FormResultId)
                                        ? null
                                        : Number(res.FormResultId),
                                });
                            };
                            dlg.loadEntityAndOpenDialog({
                                FormResultId: q["FResultId"],
                                FormTemplateId: q["FTemplateId"],
                                To: 3,
                                Manual: q["IdExt"],
                            });
                        }
                    } else if (q["LinkId"]) {
                        let dlg = new Nobox.ChatroomsCreateDialog();
                        dlg.callback = (res) => {
                            if (!Q.isEmptyOrNull(res.Manual)) {
                                let fisrtLater = res.Manual.charAt(0);
                                let noHp = res.Manual;
                                if (fisrtLater == "0")
                                    res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                            }
                            CreateNewConversation({
                                AccId: Number(res.AccId),
                                ChId: Number(res.ChId),
                                LinkId: Q.isEmptyOrNull(res.LinkId) ? null : Number(res.LinkId),
                                GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                                Chat: Number(res.Chat),
                                CtId: Q.isEmptyOrNull(res.Contact) ? null : Number(res.Contact),
                                Manual: res.Manual,
                                To: Number(res.To),
                            });
                        };
                        dlg.loadEntityAndOpenDialog({ To: 2, Link: q["LinkId"] });
                    } else if (q["IdExt"]) {
                        let dlg = new Nobox.ChatroomsCreateDialog();
                        dlg.callback = (res) => {
                            if (!Q.isEmptyOrNull(res.Manual)) {
                                let fisrtLater = res.Manual.charAt(0);
                                let noHp = res.Manual;
                                if (fisrtLater == "0")
                                    res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                            }
                            CreateNewConversation({
                                AccId: Number(res.AccId),
                                ChId: Number(res.ChId),
                                LinkId: Q.isEmptyOrNull(res.LinkId) ? null : Number(res.LinkId),
                                GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                                Chat: Number(res.Chat),
                                CtId: Q.isEmptyOrNull(res.Contact) ? null : Number(res.Contact),
                                Manual: res.Manual,
                                To: Number(res.To),
                            });
                        };
                        dlg.loadEntityAndOpenDialog({ To: 3, Manual: q["IdExt"] });
                    }
                } else {
                    BuatListConversation(par, src);
                }
                initialTab = par;
                initialFilter = "before";
            }

            Step = 22; //buat fungsi skeleteon tampilan agent
            function skeletonchatAgent(par, src) {
                $("#" + par + "chatlist").show();
                BuatListConversation(
                    par,
                    src,
                    `{"ags":"","tags":"","fn":"","chs":"","cp":"","dl":""}`
                );
                initialTab = par;
                initialFilter = "before";
            }

            function isValidUrl(string) {
                try {
                    new URL(string);
                    return true;
                } catch (err) {
                    return false;
                }
            }

            Step = 23; //buat list conversation di sebelah kiri
            function BuatListConversation(params, search, objFil, initFil, AgOrNon) {
                let profil = "",
                    jmlRead = "",
                    iconkontak = "",
                    tags = "",
                    funnel = "",
                    pin = "",
                    muteBotELm = "",
                    pinned = "",
                    block = "",
                    statuschat = "";
                let skipRoom = 0;
                let skipRoomAr = 0;
                let initScroll = false,
                    initScrollAr = false;

                //Buat list non archive
                function createAllItem(evn, idElm) {
                    let resolvedAgent = "";
                    if ($("#roomId" + evn.Id).length < 1) {
                        if (evn.Uc == null) {
                            jmlRead = ``;
                        } else {
                            let notifBaru = evn.Uc == null ? 0 : evn.Uc;
                            let countNotif = notifBaru > 99 ? "99+" : notifBaru;
                            if (notifBaru == 0) {
                                jmlRead = ``;
                            } else {
                                jmlRead = `<span class="lkbadge lkbadge-pill lkbadge-primary">${countNotif}</span>`;
                            }
                        }

                        if (evn.IsGrp == 1) {
                            profil = `data-room-img-group="${evn.GrpId}" style="background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;"`;
                        } else {
                            if (!Q.isEmptyOrNull(evn.CtImg)) {
                                profil = `data-room-img-link="${evn.CtId}" style="background-image: url('${evn.CtImg}');background-size: cover;background-position: center;"`;
                                if (!isValidUrl(evn.CtImg)) {
                                    profil = `data-room-img-link="${evn.CtId}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                                }
                            } else if (!Q.isEmptyOrNull(evn.LinkImg)) {
                                profil = `data-room-img-link="${evn.CtId}" style="background-image: url('${evn.LinkImg}');background-size: cover;background-position: center;"`;
                                if (!isValidUrl(evn.LinkImg)) {
                                    profil = `data-room-img-link="${evn.LinkImg}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                                }
                            } else {
                                profil = `data-room-img-link="${evn.CtId}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                            }
                        }

                        if (
                            evn.TagsIds == "" ||
                            evn.TagsIds === null ||
                            evn.TagsIds == "[]"
                        ) {
                            tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}"></div>`
                        } else {
                            tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-tags" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Tags}">${evn.Tags}</span></div>
                                                </div>`;
                        }
                        if (Q.isEmptyOrNull(evn.FnId)) {
                            funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}"></div>`
                        } else {
                            funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-filter" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Fn}">${evn.Fn}</span></div>
                                                </div>`;
                        }

                        iconkontak = Inbox.Function.renderChannelInListConversation(evn.ChId);

                        if (evn.St == 2) {
                            statuschat =
                                Inbox.IsAgentView == true
                                    ? ""
                                    : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-primary">${Q.text("Site.Inbox.Assigned")}</span>`;
                            //AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>Mark as Resolved</a></li>`
                        } else if (evn.St == 1) {
                            statuschat =
                                Inbox.IsAgentView == true
                                    ? ""
                                    : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-danger">${Q.text("Site.Inbox.Unassigned")}</span>`;
                            //AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>Mark as Resolved</a></li>`
                        } else if (evn.St == 3) {
                            resolvedAgent =
                                Inbox.IsAgentView == true
                                    ? `<i class="fas fa-check-circle ml-1 text-success" style="font-size:16px;"></i>`
                                    : "";
                            statuschat =
                                Inbox.IsAgentView == true
                                    ? ""
                                    : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-success">${Q.text("Site.Inbox.Resolved")}</span>`;
                        }

                        if (evn.IsMuteBot == 1) {
                            muteBotELm = `<i data-mutebot-id="mutebot${evn.Id}" class="fas fa-robot ml-1 text-danger" style="font-size:16px;"></i>`;
                        } else {
                            muteBotELm = ``;
                        }

                        if (evn.IsPin == 2) {
                            pin = `<i data-pin-id="pin${evn.Id}" class="fas fa-thumbtack ml-1" style="font-size:16px;"></i>`;
                            pinned = "pinned";
                        } else {
                            pin = ``;
                            pinned = "";
                        }

                        if (evn.CtIsBlock == 1) {
                            block = `<i data-block-id="block${evn.CtRealId}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`;
                        } else {
                            block = ``;
                        }
                        let sdr =
                            evn.SdrMsg == "me" ? '<i class="fas fa-reply"></i>' : "";
                        let iconMsg = "";
                        if (evn.LastMsg != null) {
                            if (evn.LastMsg.includes('<i class="fa fa-image"></i>')) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    '<i class="fa fa-image"></i> ',
                                    ""
                                );
                                iconMsg = '<i class="fa fa-image"></i>';
                            } else if (
                                evn.LastMsg.includes("<i class='fa fa-image'></i>")
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    "<i class='fa fa-image'></i> ",
                                    ""
                                );
                                iconMsg = '<i class="fa fa-image"></i>';
                            } else if (evn.LastMsg.includes('<i class="fa fa-file"></i>')) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    '<i class="fa fa-file"></i> ',
                                    ""
                                );
                                iconMsg = '<i class="fa fa-file"></i>';
                            } else if (evn.LastMsg.includes("<i class='fa fa-file'></i>")) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    "<i class='fa fa-file'></i> ",
                                    ""
                                );
                                iconMsg = '<i class="fa fa-file"></i>';
                            } else if (
                                evn.LastMsg.includes('<i class="fa fa-microphone"></i>')
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    '<i class="fa fa-microphone"></i>',
                                    ""
                                );
                                iconMsg = '<i class="fa fa-microphone"></i>';
                            } else if (
                                evn.LastMsg.includes("<i class='fa fa-microphone'></i>")
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    "<i class='fa fa-microphone'></i> ",
                                    ""
                                );
                                iconMsg = '<i class="fa fa-microphone"></i>';
                            } else if (
                                evn.LastMsg.includes('<i class="fa fa-video"></i>')
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    '<i class="fa fa-video"></i>',
                                    ""
                                );
                                iconMsg = '<i class="fa fa-video"></i>';
                            } else if (
                                evn.LastMsg.includes("<i class='fa fa-video'></i>")
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    "<i class='fa fa-video'></i> ",
                                    ""
                                );
                                iconMsg = '<i class="fa fa-video"></i>';
                            } else if (
                                evn.LastMsg.includes("<i class='fa fa-sticky-note'></i>")
                            ) {
                                evn.LastMsg = evn.LastMsg.replace(
                                    "<i class='fa fa-sticky-note'></i> ",
                                    ""
                                );
                                iconMsg = '<i class="fa fa-sticky-note"></i>';
                            }
                        }
                        if (evn.TimeMsg == null) {
                            evn.TimeMsg = "";
                        } else if (isToday(new Date(evn.TimeMsg))) {
                            //evn.TimeMsg = "Today at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                            evn.TimeMsg = getCookie(evn.TimeMsg, "timezone", "TimeOnly");
                        } else if (isYesterday(new Date(evn.TimeMsg))) {
                            //evn.TimeMsg = "Yesterday at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                            evn.TimeMsg = Q.text("Site.Inbox.Yesterday");
                        } else {
                            evn.TimeMsg = getCookie(
                                evn.TimeMsg,
                                "timezone",
                                "Date"
                            ) /* + " at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly')*/;
                        }
                        const template = `<li id="roomId${evn.Id}" class="showChatClass chat-item border-bottom disabledLink ///// ${pinned} ${Inbox.IdRoomAktif == evn.Id ? "current" : ""}">
                                                <div class="chat-item-all"><div class="chat-link chat-open">
                                                <div class="chat-media user-lkavatar" ${profil}></div>
                                                <div class="chat-info">
                                                <div class="chat-from">
                                                <div class="name" data-room-link="${evn.CtId}" data-room-name="roomNm${evn.Id}">${evn.IsGrp == 1 ? evn.Grp : evn.CtRealNm == null ? evn.Ct : evn.CtRealNm}</div >
                                                <span class="time"><span id="time${evn.Id}">${evn.TimeMsg}</span> 
                                                <span data-act-id="act${evn.Id}" data-act-ct-id="${evn.CtRealId}">${pin} ${block} ${muteBotELm} ${resolvedAgent}</span></span>
                                                </div>
                                                <div class="chat-context"><div class="text ${evn.SdrMsg == "you" && evn.IsNeedReply == 1 ? "text-danger" : ""}" title="${evn.LastMsg == null || evn.LastMsg == "null" ? "" : msgTranslator(evn.LastMsg)}" id="msg${evn.Id}">
                                                ${sdr} 
                                                ${iconMsg} 
                                                ${Q.isEmptyOrNull(evn.UserLastMsg) ? "" : (`<b>${evn.UserLastMsg.length > 12 ? evn.UserLastMsg.substring(0, 12) + "..." : evn.UserLastMsg}: </b>`)}
                                                ${evn.LastMsg == null || evn.LastMsg == "null" ? "" : msgTranslator(evn.LastMsg)}</div>
                                                <div class="status unread" data-read="read${evn.Id}" data-count="${evn.Uc == null ? 0 : evn.Uc}">${jmlRead}</div>
                                                </div>
                                                <div class="chat-context">
                                                <div class="text">${iconkontak}
                                                <span class="text mr-2">${evn.ChAcc}</span></div>
                                                ${statuschat}
                                                </div>
                                                ${tags}
                                                ${funnel}
                                                </div>
                                                </div>
                                                </div>
                                            </li>`;
                        $(idElm).append(template);
                    }
                }

                //Buat list archive
                function createArchiveItem(evn, idElm) {
                    if (evn.Uc == null) {
                        jmlRead = ``;
                    } else {
                        jmlRead = `<div class="status unread">
                                                    <span class="lkbadge lkbadge-pill lkbadge-primary">${evn.Uc}</span>
                                                    </div>`;
                    }
                    if (evn.TagsIds == "" || evn.TagsIds === null) {
                        tags = "";
                    } else {
                        tags = "";
                    }

                    iconkontak = Inbox.Function.renderChannelInListConversation(evn.ChId);

                    if (evn.St == 2) {
                        statuschat = `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-primary">${Q.text("Site.Inbox.Assigned")}</span>`;
                        AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>${Q.text(
                            "Site.Inbox.MarkResolved"
                        )}</a></li>`;
                    } else if (evn.St == 1) {
                        statuschat = `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-danger">${Q.text("Site.Inbox.Unassigned")}</span>`;
                        AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>${Q.text(
                            "Site.Inbox.MarkResolved"
                        )}</a></li>`;
                    } else if (evn.St == 3) {
                        statuschat = `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-success">${Q.text("Site.Inbox.Resolved")}</span>`;
                    }

                    if (evn.IsPin == 2) {
                        pin = `<i data-pin-id="pin${evn.Id}" class="fas fa-thumbtack ml-1" style="font-size:16px;"></i>`;
                        pinned = "pinned";
                    } else {
                        pin = ``;
                        pinned = "";
                    }

                    if (evn.CtIsBlock == 1) {
                        block = `<i data-block-id="block${evn.CtRealId}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`;
                    } else {
                        block = ``;
                    }

                    if (
                        evn.TagsIds == "" ||
                        evn.TagsIds === null ||
                        evn.TagsIds == "[]"
                    ) {
                        tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}"></div>`
                    } else {
                        tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-tags" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Tags}">${evn.Tags}</span></div>
                                                </div>`;
                    }
                    if (Q.isEmptyOrNull(evn.FnId)) {
                        funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}"></div>`
                    } else {
                        funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-filter" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Fn}">${evn.Fn}</span></div>
                                                </div>`;
                    }

                    let sdr = evn.SdrMsg == "me" ? '<i class="fas fa-reply"></i>' : "";
                    let iconMsg = "";
                    if (evn.LastMsg != null) {
                        if (evn.LastMsg.includes('<i class="fa fa-image"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-image"></i> ',
                                ""
                            );
                            iconMsg = '<i class="fa fa-image"></i>';
                        } else if (evn.LastMsg.includes('<i class="fa fa-file"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-file"></i> ',
                                ""
                            );
                            iconMsg = '<i class="fa fa-file"></i>';
                        } else if (
                            evn.LastMsg.includes('<i class="fa fa-microphone"></i>')
                        ) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-microphone"></i>',
                                ""
                            );
                            iconMsg = '<i class="fa fa-microphone"></i>';
                        } else if (evn.LastMsg.includes('<i class="fa fa-video"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-video"></i>',
                                ""
                            );
                            iconMsg = '<i class="fa fa-video"></i>';
                        } else if (evn.LastMsg.includes("<i class='fa fa-video'></i>")) {
                            evn.LastMsg = evn.LastMsg.replace(
                                "<i class='fa fa-video'></i> ",
                                ""
                            );
                            iconMsg = '<i class="fa fa-video"></i>';
                        } else if (
                            evn.LastMsg.includes("<i class='fa fa-sticky-note'></i>")
                        ) {
                            evn.LastMsg = evn.LastMsg.replace(
                                "<i class='fa fa-sticky-note'></i> ",
                                ""
                            );
                            iconMsg = '<i class="fa fa-sticky-note"></i>';
                        }
                    }
                    if (evn.TimeMsg == null) {
                        evn.TimeMsg = "";
                    } else if (isToday(new Date(evn.TimeMsg))) {
                        //evn.Up = "Today at " + getCookie(evn.Up, "timezone", 'TimeOnly');
                        evn.TimeMsg = getCookie(evn.TimeMsg, "timezone", "TimeOnly");
                    } else if (isYesterday(new Date(evn.TimeMsg))) {
                        //evn.Up = "Yesterday at " + getCookie(evn.Up, "timezone", 'TimeOnly');
                        evn.TimeMsg = Q.text("Site.Inbox.Yesterday");
                    } else {
                        evn.TimeMsg = getCookie(
                            evn.TimeMsg,
                            "timezone",
                            "Date"
                        ) /* + " at " + getCookie(evn.Up, "timezone", 'TimeOnly')*/;
                    }

                    if (evn.IsGrp == 1) {
                        profil = `data-room-img-group="${evn.GrpId}" style="background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;"`;
                    } else {
                        if (!Q.isEmptyOrNull(evn.CtImg)) {
                            profil = `style="background-image: url('${evn.CtImg}');background-size: cover;background-position: center;"`;
                            if (!isValidUrl(evn.CtImg)) {
                                profil = `data-room-img-link="${evn.CtId}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                            }
                        } else if (!Q.isEmptyOrNull(evn.LinkImg)) {
                            profil = `style="background-image: url('${evn.LinkImg}');background-size: cover;background-position: center;"`;
                            if (!isValidUrl(evn.LinkImg)) {
                                profil = `data-room-img-link="${evn.CtId}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                            }
                        } else {
                            profil = `style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                        }
                    }

                    const template = `<li id="roomArId${evn.Id
                        }" class="ShowChatAr chat-item border-bottom disabledLink ///// ${pinned} ${Inbox.IdRoomAktif == evn.Id ? "current" : ""
                        }">
                                                <div class="chat-item-all"><div class="chat-link chat-open">
                                                <div class="chat-media user-lkavatar" ${profil}>
                                                </div>
                                                <div class="chat-info">
                                                <div class="chat-from">
                                                <div class="name" data-room-name="roomNm${evn.Id
                        }">${evn.IsGrp == 1
                            ? evn.Grp
                            : evn.CtRealNm == null
                                ? evn.Ct
                                : evn.CtRealNm
                        }</div>
                                                <span class="time" data-id-time="time${evn.Id
                        }">${evn.TimeMsg}
                                                <span data-act-id="act${evn.Id
                        }" data-act-ct-id="${evn.CtRealId
                        }">${pin} ${block}</span></span>
                                                </div>
                                                <div class="chat-context"><div class="text ${evn.SdrMsg == "you" && evn.IsNeedReply == 1 ? "text-danger" : ""}" data-id-msg="msg${evn.Id
                        }"> ${sdr} 
                            ${iconMsg} 
                            ${Q.isEmptyOrNull(evn.UserLastMsg) ? "" : `<b>${(evn.UserLastMsg.length > 12 ? evn.UserLastMsg.substring(0, 12) + "..." : evn.UserLastMsg)}: </b>`}
                            ${evn.LastMsg == null || evn.LastMsg == "null"
                            ? ""
                            : msgTranslator(evn.LastMsg)
                        }</div>
                                                </div>
                                                <div class="chat-context">
                                                <div class="text">${iconkontak}
                                                <span>${evn.ChAcc
                        }</span></div>
                                                <span class="lkbadge lkbadge-outline-secondary">${Q.text("Site.Inbox.Archived")}</span>
                                                </div>
                                                ${tags}
                                                ${funnel}
                                                </div>
                                                </div>
                                                </div>
                                            </li>`;
                    $(idElm).append(template);
                    //jQuery("span.timeago").timeago();
                }

                //untuk list dan infinity scroll archive conversation
                function nextHandlerArchive() {
                    $("#overflowchatAr").css("display", "block");
                    $(".lds-spinner-" + params).show();
                    let url = new URL(window.location.href);
                    let RmId = url.searchParams.get("RoomId");
                    Q.serviceCall({
                        blockUI: false,
                        url: "/Services/Chat/Chatrooms/List",
                        request: {
                            Take: 20,
                            Skip: skipRoomAr,
                            ContainsText: search,
                            EqualityFilter: { St: 4, ChId: "" },
                            RoomId: IsPertamaLoad == true && RmId != null ? RmId : null,
                            IsArchived: true,
                            Sort: ["Up DESC"],
                        },
                        onSuccess: async (res) => {
                            skipRoomAr = skipRoomAr + res.Entities.length;
                            $(".lds-spinner-" + params).hide();

                            Inbox.ListRoomNotif = [];
                            res.Entities.forEach(function (e, j) {
                                Inbox.ListRoomNotif.push("Notifikasi" + e.Id);
                                Inbox.ListRoomNotifAll.push("Notifikasi" + e.Id);
                                createArchiveItem(e, "#archivechatlist");
                            });
                            $(".ShowChatAr").unbind("click");
                            $(".ShowChatAr").on("click", function () {
                                showChatAr($(this).attr("id").replace("roomArId", ""));
                            });
                            let url = new URL(window.location.href);
                            let RmId = url.searchParams.get("RoomId");
                            if (IsPertamaLoad == true && RmId != null) {
                                $("#roomArId" + RmId).click();
                                IsPertamaLoad = false;
                            }
                            await connection.invoke("Subscribe", Inbox.ListRoomNotif);
                        },
                    });
                    $("#scroll" + params).scroll(function (e) {
                        //harus e 130
                        if (
                            $("#scroll" + params)[0].scrollHeight -
                            $("#scroll" + params).scrollTop() -
                            200 <=
                            $("#scroll" + params).outerHeight()
                        ) {
                            if (initScrollAr == false) {
                                initScrollAr = true;
                                $(".lds-spinner-" + params).show();
                                Q.serviceCall({
                                    blockUI: false,
                                    url: "/Services/Chat/Chatrooms/List",
                                    request: {
                                        Take: 20,
                                        Skip: skipRoomAr,
                                        ContainsText: search,
                                        EqualityFilter: { St: 4 },
                                        Sort: ["Up DESC"],
                                    },
                                    onSuccess: (res) => {
                                        $(".lds-spinner-" + params).hide();
                                        skipRoomAr = skipRoomAr + res.Entities.length;
                                        //if (res.Entities.length > 0) {
                                        //} else {
                                        //    initScrollAr = true;
                                        //}
                                        res.Entities.forEach(function (e, ei) {
                                            createArchiveItem(e, "#archivechatlist");
                                            if (ei == res.Entities.length - 1) {
                                                initScrollAr = false;
                                            }
                                        });
                                        $(".ShowChatAr").unbind("click");
                                        $(".ShowChatAr").on("click", function () {
                                            showChatAr($(this).attr("id").replace("roomArId", ""));
                                        });
                                    },
                                });
                            } else {
                                initScrollAr = true;
                                setTimeout(function () {
                                    initScrollAr = false;
                                }, 500);
                            }
                        }
                    });
                }

                //Filter And All -> Template nya ada di createAllItem()
                function nextHandlerFilter() {
                    let getFilterOption = localStorage.getItem("filterConversation");
                    if (Inbox.IsAgentView) {
                        getFilterOption = localStorage.getItem("filterConversationAgent");
                    }
                    $("#filterroom").html("");
                    $("#filterroomAgent").html("");
                    if (
                        Q.isEmptyOrNull(getFilterOption) ||
                        getFilterOption ==
                        `{"tags":"","fn":"","chs":"","cp":"","dl":"","ac":"","ct":"","lk":"","chat":"","grp":"","ismute":"","readst":"","st":"","ags":""}` ||
                        getFilterOption ==
                        `{"tags":"","fn":"","chs":"","cp":"","dl":"","ac":"","ct":"","lk":"","chat":"","grp":"","ismute":"","readst":""}`
                    ) {
                    } else {
                        initFil = "filter";
                        objFil = getFilterOption;
                        $("#filterroom").append(
                            `<div style="position: absolute;width: 7px;height: 7px;display: inline-block;border-radius: 50%;background-color: #2c76ed;margin-left: -7px;"></div>`
                        );
                        $("#filterroomAgent").append(
                            `<div style="position: absolute;width: 7px;height: 7px;display: inline-block;border-radius: 50%;background-color: #2c76ed;margin-left: -7px;"></div>`
                        );
                    }
                    let filterSt = "";
                    if (params == "all" || params == "allAgent") {
                        filterSt = ["1", "2", "3"];
                    } else if (params == "unassigned") {
                        filterSt = ["1"];
                    } else if (params == "assigned" || params == "ongoingAgent") {
                        filterSt = ["2"];
                    } else if (params == "resolved" || params == "resolvedAgent") {
                        filterSt = ["3"];
                    }

                    if (objFil == undefined) {
                        let objFilIfNull = { "tags": "", "fn": "", "chs": "", "cp": "", "dl": "", "ac": "", "ct": "", "lk": "", "chat": "", "grp": "", "ismute": "", "st": "", "ags": "" };
                        objFil = JSON.stringify(objFilIfNull);
                    }
                    let Filters = JSON.parse(objFil);
                    if (Inbox.IsAgentView) {
                        //belum tau dipake apa ngga
                        Filters.ags = "";
                    }

                    $(".lds-spinner-" + params).show();
                    //Request Room
                    function createList() {
                        let url = new URL(window.location.href);
                        let RmId = url.searchParams.get("RoomId");
                        let IsArchived = url.searchParams.get("Archived");
                        let finalfilter = {
                            St: filterSt,
                            FnId: Q.isEmptyOrNull(Filters.fn) ? "" : Filters.fn,
                            GrpId: Q.isEmptyOrNull(Filters.grp) ? "" : Filters.grp,
                            ChId: Q.isEmptyOrNull(Filters.chs) ? "" : Filters.chs,
                            DealId: Q.isEmptyOrNull(Filters.dl) ? "" : Filters.dl,
                            CampaignId: Q.isEmptyOrNull(Filters.cp) ? "" : Filters.cp,
                            CtId: Q.isEmptyOrNull(Filters.lk) ? "" : Filters.lk,
                            CtRealId: Q.isEmptyOrNull(Filters.ct) ? "" : Filters.ct,
                            ChAccId: Q.isEmptyOrNull(Filters.ac) ? "" : Filters.ac,
                            IsMuteBot: Q.isEmptyOrNull(Filters.ismute) ? "" : Filters.ismute,
                            ReadStatus: Q.isEmptyOrNull(Filters.readst) ? "" : Filters.readst,
                        };
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/List",
                            request: {
                                Take: 20,
                                Skip: skipRoom,
                                Sort: ["IsPin DESC", "TimeMsg DESC" /*, "St"*/],
                                ContainsText: search,
                                EqualityFilter: finalfilter,
                                RoomId: IsPertamaLoad == true && RmId != null ? RmId : null,
                                Status: Inbox.IsAgentView
                                    ? null
                                    : Q.isEmptyOrNull(Filters.st)
                                        ? ""
                                        : Filters.st,
                                //Criteria: filterCreated,
                                Chat: Q.isEmptyOrNull(Filters.chat)
                                    ? null
                                    : parseInt(Filters.chat),
                                TagsIds: Filters.tags == "" ? "" : Filters.tags.split(","),
                                UserIds: Filters.ags == "" ? "" : Filters.ags.split(","),
                            },
                            onSuccess: async (res) => {
                                if (res.Entities.length == 0 && skipRoom == 0) {
                                    $(".noconversation").show();
                                    $(".overflowchat").hide();
                                } else {
                                    $(".noconversation").hide();
                                    $(".overflowchat").show();
                                }
                                if (res.Entities.length > 0) {
                                    setTimeout(function () {
                                        initScroll = false;
                                    }, 500);
                                } else {
                                    initScroll = true;
                                    setTimeout(function () {
                                        initScroll = false;
                                    }, 500);
                                    //initScroll = true;
                                }
                                skipRoom = skipRoom + res.Entities.length;
                                $(".lds-spinner-" + params).hide();
                                Inbox.ListRoomNotif = [];
                                res.Entities.forEach(function (e, j) {
                                    Inbox.ListRoomNotif.push("Notifikasi" + e.Id);
                                    Inbox.ListRoomNotifAll.push("Notifikasi" + e.Id);
                                    createAllItem(e, "#" + params + "chatlist");
                                });
                                //yang ini harusnya diatas
                                $(".showChatClass").unbind("click");
                                $(".showChatClass").on("click", function () {
                                    showChat($(this).attr("id").replace("roomId", ""));
                                });
                                try {
                                    await connection.invoke("Subscribe", Inbox.ListRoomNotif);
                                    // KirimPesanPending();
                                    if (IsPertamaLoad == true && RmId != null) {
                                        if (
                                            Inbox.ListRoomNotif.includes("Notifikasi" + RmId) == true
                                        ) {
                                            $("#roomId" + RmId).click();
                                            IsPertamaLoad = false;
                                        } else if (IsArchived == 1) {
                                            if (!Inbox.IsAgentView) {
                                                $("#cntAr").click();
                                            } else {
                                                $("#cntArAgent").click();
                                            }
                                        }
                                    }
                                } catch (error) {
                                    console.error(`Subscribe Step = ${Step}, Msg = ${error}`);
                                }
                            },
                        });
                    }
                    createList();

                    //Inbox.IsAgentView == true ? IsAg = "Agent" : IsAg = "";
                    $("#scroll" + params).scroll(function (e) {
                        if (
                            $("#scroll" + params)[0].scrollHeight -
                            $("#scroll" + params).scrollTop() -
                            130 <=
                            $("#scroll" + params).outerHeight()
                        ) {
                            if (initScroll == false) {
                                $(".lds-spinner-" + params).show();
                                nextHandlerFilter();
                                initScroll = true;
                            }
                        }
                    });
                }
                if (params == "archive") {
                    $("#archivechatlist").html("");
                    nextHandlerArchive();
                } else {
                    $("#allchatlist").html("");
                    $("#unassignedchatlist").html("");
                    $("#assignedchatlist").html("");
                    $("#resolvedchatlist").html("");
                    $("#allAgentchatlist").html("");
                    $("#ongoingAgentchatlist").html("");
                    $("#resolvedAgentchatlist").html("");
                    if (objFil) {
                        skipRoomAr = 0;
                        nextHandlerFilter();
                    } else {
                        nextHandlerFilter();
                    }
                }
            }

            function generateMessageId() {
                // Get current datetime in milliseconds
                let timestamp = Date.now().toString(); // Timestamp in milliseconds since 1970
                // Use the first 9 digits of the timestamp
                let timestampPart = timestamp.slice(0, 9);

                // Generate a random number with up to 6 digits
                let randomPart = Math.floor(Math.random() * 900000) + 100000; // Ensures a 6-digit random number

                // Combine the timestamp part and random part to make a 15-digit ID
                let uniqueID = timestampPart + randomPart.toString();

                return uniqueID;
            }

            function showSelectLocation(lat, lng) {
                let dlg = new Nobox.SelectLocationDialog();
                if (lat != null && lng != null)
                    dlg.latlng = [lat, lng];

                dlg.callbackMap = (lat, lng, place) => {
                    dlg.dialogClose();
                    let dataMsg = {
                        Room: {
                            IdLink: Inbox.DataRoomActive.Link == null ? null : Inbox.DataRoomActive.Link.Id,
                            IdGroup: Inbox.DataRoomActive.Group == null ? null : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {
                            Type: "9",
                            Msg: `${lat}[-{=||=}-]${lng}[-{=||=}-]`,
                            File: null,
                            Files: null,
                        },
                    };
                    if (!Q.isEmptyOrNull(place))
                        dataMsg.Msg.Msg = `${lat}[-{=||=}-]${lng}[-{=||=}-]${place}`;

                    if (
                        Inbox.DataRoomActive.Agents.filter(
                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                        ).length < 1
                    ) {
                        InsertAgentYgLogin(dataMsg);
                    } else {
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                    }
                };
                //dlg.InitMap();
                dlg.dialogOpen();
            }

            $("#mapContainer").on("click", () => {
                if ("geolocation" in navigator) {
                    // Get the current position
                    navigator.geolocation.getCurrentPosition(function (position) {
                        // Extract latitude and longitude from the position object
                        const latitude = position.coords.latitude;
                        const longitude = position.coords.longitude;
                        showSelectLocation(latitude, longitude);
                    }, function (error) {
                        //Q.notifyError(error.message, Q.text("Site.ValidationError.Title"))
                        showSelectLocation(null, null);
                    });
                } else {
                    //console.error("Geolocation is not supported by this browser.");
                    showSelectLocation(null, null);
                }
            });

            $("#contactContainer").on("click", () => {
                let dlgContactPicker = new Nobox.Nobox.LinkPickerDialog({ channelId: Inbox.DataRoomActive.Room.ChId });
                dlgContactPicker.callback = (res) => {
                    let listIdLink = res.split(",");
                    let dataMsg = {
                        Room: {
                            IdLink:
                                Inbox.DataRoomActive.Link == null
                                    ? null
                                    : Inbox.DataRoomActive.Link.Id,
                            IdGroup:
                                Inbox.DataRoomActive.Group == null
                                    ? null
                                    : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {
                            Type: listIdLink.length == 1 ? "12" : "13",
                            Msg: res,
                            File: null,
                            Files: null,
                        },
                    };
                    if (
                        Inbox.DataRoomActive.Agents.filter(
                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                        ).length < 1
                    ) {
                        InsertAgentYgLogin(dataMsg);
                    } else {
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                    }
                }
                dlgContactPicker.dialogOpen();
            });

            $("#stickerContainer").on("click", () => {
                let dlgStickerPicker = new Nobox.SelectStickerDialog();
                dlgStickerPicker.callback = (urlSticker) => {
                    let dataMsg = {
                        Room: {
                            IdLink:
                                Inbox.DataRoomActive.Link == null
                                    ? null
                                    : Inbox.DataRoomActive.Link.Id,
                            IdGroup:
                                Inbox.DataRoomActive.Group == null
                                    ? null
                                    : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {
                            Type: "7",
                            Msg: null,
                            File: JSON.stringify([{ Filename: urlSticker, OriginalName: null }]),
                            Files: null,
                        },
                    };
                    if (
                        Inbox.DataRoomActive.Agents.filter(
                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                        ).length < 1
                    ) {
                        InsertAgentYgLogin(dataMsg);
                    } else {
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                    }
                }
                dlgStickerPicker.dialogOpen();
            })

            //Voice Note (Rekam dan kirim pesan)
            const recorder = new MicRecorder({
                bitRate: 128,
            });
            let vnDetik = 0;
            let vnTimerInterval;
            function vnStartTimer() {
                vnTimerInterval = setInterval(updateTimer, 1000); // Update timer every second (1000 milliseconds)
            }
            function vnStopTimer() {
                clearInterval(vnTimerInterval); // Stop the timer
                vnDetik = 0;
                $('#vnWaktu').text("00:00");
            }
            function updateTimer() {
                vnDetik++;
                $('#vnWaktu').text(vnFormatTime(vnDetik)); // Display the formatted time in a HTML element with id 'timer'
            }
            function vnFormatTime(seconds) {
                let minutes = Math.floor(seconds / 60);
                let remainingSeconds = seconds % 60;
                return vnPad(minutes) + ":" + vnPad(remainingSeconds);
            }
            function vnPad(val) {
                let valString = val + "";
                if (valString.length < 2) {
                    return "0" + valString;
                } else {
                    return valString;
                }
            }
            $("#vnStartBtn").on("click", () => {
                recorder
                    .start()
                    .then(() => {
                        $("#vnElement").slideToggle(200);
                        $("#editorChat").slideToggle(0);
                        $(".toggle-opt").removeClass(" active");
                        $(".chat-upload-option").removeClass(" expanded");

                        vnStartTimer();
                    })
                    .catch((e) => {
                        console.error(e);
                    });
            });
            $("#vnBatal").on("click", () => {
                recorder.stop();

                $("#vnElement").slideToggle(0);
                $("#editorChat").slideToggle(200);

                vnStopTimer();
            });
            $("#vnSimpan").on("click", () => {
                recorder
                    .stop()
                    .getMp3()
                    .then(([buffer, blob]) => {
                        vnStopTimer();

                        let reader = new FileReader();
                        reader.readAsDataURL(blob);
                        reader.onloadend = function () {
                            let base64data = reader.result;
                            $("#previewAudio").attr("data-basenampat", base64data);
                        };
                        const file = new File(buffer, "recorder.mp3", {
                            type: blob.type,
                            lastModified: Date.now(),
                        });

                        const player = new Audio(URL.createObjectURL(file));
                        player.controls = true;
                        $("#previewAudio").html(player);

                        $("#vnElement").slideToggle(0);
                        $("#editorChat").slideToggle(200);
                        $("#btnmodalvoicecamera").click();
                    })
                    .catch((e) => {
                        console.error(e);
                    });
            });
            $("#sendVoice").on("click", () => {
                Q.serviceCall({
                    blockUI: true,
                    url: "/Inbox/UploadFile/ConvertBase64ToFile",
                    request: {
                        media: {
                            data: $("#previewAudio").attr("data-basenampat").split(',')[1],
                            mimetype: "audio/mp3",
                            filename: "",
                        },
                    },
                    onSuccess: async (hasil) => {
                        if (!hasil.IsError) {
                            let dataMsg = {
                                Room: {
                                    IdLink:
                                        Inbox.DataRoomActive.Link == null
                                            ? null
                                            : Inbox.DataRoomActive.Link.Id,
                                    IdGroup:
                                        Inbox.DataRoomActive.Group == null
                                            ? null
                                            : Inbox.DataRoomActive.Group.Id,
                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                },
                                Msg: {
                                    Type: "2",
                                    Msg: null,
                                    File: JSON.stringify([hasil.Data]),
                                    Files: null,
                                },
                            };
                            if (
                                Inbox.DataRoomActive.Agents.filter(
                                    (b) => b.UserId == Inbox.Info.currentUser().UserId
                                ).length < 1
                            ) {
                                InsertAgentYgLogin(dataMsg);
                            } else {
                                KirimPesan(
                                    JSON.stringify(dataMsg),
                                    `${Inbox.DataRoomActive.Room.Id}`
                                );
                            }
                            $("#closevoicecamera").click();
                            $("#msgVoice").val("");
                        }
                    },
                });
            });

            Step = 26; //Btn Tambah funnel
            $("#btnaddfunnels").on("click", function () {
                addFunnel();
            });
            Step = 27; //Btn Tambah tags
            $("#btnaddtags").on("click", function () {
                addTags();
            });

            Step = 28; //template untuk buat object pesan
            function BuatObjPesan(type, msg, file, reply) {
                return {
                    //Id:id,
                    RoomId: $(".nk-chat-body").attr("data-id"),
                    Ack: 2,
                    From: $(".nk-chat-body").attr("data-user-from"),
                    To: $(".nk-chat-body").attr("data-user-to"),
                    AgentId: $(".nk-chat-body").attr("data-ag-id"),
                    Type: type.toString(),
                    Msg: msg,
                    Files: file,
                    ReplyId: reply,
                    In: new Date().toISOString(),
                    InBy: $(".nk-chat-body").attr("data-ag-id"),
                    Up: new Date().toISOString(),
                    UpBy: $(".nk-chat-body").attr("data-ag-id"),
                };
            }

            function BuatElementAgent() {
                $("#agentname").text(Inbox.DataRoomActive.Agents.length + ` ${Q.text("Site.Inbox.Agent")}`);
                if (Inbox.DataRoomActive.Agents.length) {
                    $("#agentSelected").addClass("mt-2");
                    $("#agentSelected").html(
                        Inbox.DataRoomActive.Agents.map(function (element) {
                            let img = "",
                                agDel = "";
                            if (element.UserImage) {
                                img = `style="background-image: url(${Q.resolveUrl(
                                    "~/upload/" + element.UserImage
                                )});background-size: cover;background-position: center;"`;
                            } else {
                                img = `style="background-image: url(/Inbox/img/agent.png);background-size: cover;background-position: center;"`;
                            }
                            if (
                                Inbox.IsAgentView == false ||
                                Inbox.Info.currentUser().UserId == element.UserId
                            )
                                agDel =
                                    '<i data-id-ag="' +
                                    element.Id +
                                    '" data-id-user="' +
                                    element.UserId +
                                    '" data-nm-ag="' +
                                    element.DisplayName +
                                    '" class="DeleteAgent fa fa-close text-danger" style="cursor:pointer;"></i>';

                            return (
                                '<div class="user-lkcard mb-1">' +
                                '<div class="user-lkavatar bg-transparent"' +
                                img +
                                ">" +
                                "</div>" +
                                '<div class="col-9 pl-0 ml-2 user-info">' +
                                '<span class="lead-text">' +
                                element.DisplayName +
                                "</span>" +
                                "</div>" +
                                '<div class="user-panel">' +
                                agDel +
                                "</div>" +
                                "</div>"
                            );
                            //'<div onclick="deleteAgent(' + element.UserId + ')" class="lkbtn lkbtn-round lkbtn-outline-danger lkbtn-icon"><em class="icon ni ni-trash-empty"></em></div>' +
                        }).join("\n")
                    );
                    $(".DeleteAgent").on("click", function () {
                        deleteAgent(
                            $(this).attr("data-id-ag"),
                            $(this).attr("data-id-user"),
                            $(this).attr("data-nm-ag")
                        );
                    });
                } else {
                    $("#agentSelected").removeClass("mt-2");
                    $("#agentSelected").html(
                        `<div class="text-danger" id="NSAgents" style="cursor: pointer;">${Q.text(
                            "Site.Inbox.NotSet"
                        )}</div>`
                    );
                    $("#NSAgents").on("click", function (e) {
                        e.stopPropagation();
                        $("#addAgents").lkdropdown("toggle");
                        setTimeout(() => {
                            $("#cariagent").focus();
                        }, 100);
                    });
                }
            }

            function updateConversationElm(evn) {
                //jika room sedang dibuka oleh agent

                try {
                    //set jika user profilenya berubah
                    let profileUrl = $(`div.user-lkavatar[data-room-img-link="${evn.CtId}"]`)
                    if (!Q.isEmptyOrNull(profileUrl))
                        profileUrl.css("background-image").replace(/^url\(["']?/, '').replace(/["']?\)$/, '')
                    if (!Q.isEmptyOrNull(evn.CtImg) && profileUrl != evn.CtImg) {
                        $(`div.user-lkavatar[data-room-img-link="${evn.CtId}"]`).css("background-image", `url(${evn.CtImg})`);
                    } else if (!Q.isEmptyOrNull(evn.LinkImg) && profileUrl != evn.LinkImg) {
                        $(`div.user-lkavatar[data-room-img-link="${evn.CtId}"]`).css("background-image", `url(${evn.LinkImg})`);
                    }

                    //set jika nama user berubah
                    let roomName = $(`div.name[data-room-link="${evn.CtId}"]`).text();
                    if (!Q.isEmptyOrNull(evn.CtRealNm) && roomName != evn.CtRealNm) {
                        $(`div.name[data-room-link="${evn.CtId}"]`).text(evn.CtRealNm)
                    } else if (!Q.isEmptyOrNull(evn.Ct) && roomName != evn.Ct) {
                        $(`div.name[data-room-link="${evn.CtId}"]`).text(evn.Ct)
                    }
                } catch (e) {
                    console.error(e, "Profile/Name")
                }

                try {
                    if (evn.Id == Inbox.IdRoomAktif) {
                        $('[data-read="read' + evn.Id + '"]')
                            .attr("data-count", "0")
                            .html("");
                    } //jika tidak dibuka agent
                    else {
                        // let notifBaru =
                        //     parseInt(
                        //         $('[data-read="read' + evn.Id + '"]').attr("data-count")
                        //     ) + evn.Uc;
                        let notifBaru = evn.Uc;
                        if (notifBaru == 0) {
                            $('[data-read="read' + evn.Id + '"]').attr(
                                "data-count",
                                notifBaru
                            );
                        } else {
                            $('[data-read="read' + evn.Id + '"]')
                                .attr("data-count", notifBaru)
                                .html(
                                    `<span class="lkbadge lkbadge-pill lkbadge-primary">${(notifBaru + 1) > 99 ? "99+" : (notifBaru + 1)}</span>`
                                );
                        }
                    }
                } catch (e) {
                    console.error(e, "UnreadCount")
                }

                try {
                    //taruh roomlist kebagian atas
                    if ($("#roomId" + evn.Id).hasClass("pinned")) {
                        $("#roomId" + evn.Id).insertBefore("#" + initialTab + " li:eq(0)");
                    } else {
                        $("#roomId" + evn.Id).insertBefore(
                            "#" + initialTab + " li:eq(" + $(".pinned").length + ")"
                        );
                    }
                } catch (e) {
                    console.error(e, "Pinned Conversation")
                }

                try {
                    //set info pesan terbaru dan jam terkirimnya
                    if (evn.SdrMsg == "me") {
                        $(`#msg${evn.Id}`).html(
                            '<i class="fas fa-reply"></i> ' + (Q.isEmptyOrNull(evn.UserLastMsg) ? "" : (`<b>${evn.UserLastMsg.length > 12 ? evn.UserLastMsg.substring(0, 12) + "..." : evn.UserLastMsg}: </b>`)) + evn.LastMsg
                        );
                        $(`#msg${evn.Id}`).removeClass("text-danger");
                    } else {
                        $(`#msg${evn.Id}`).html(msgTranslator(evn.LastMsg));
                        $(`#msg${evn.Id}`).addClass("text-danger");
                    }
                } catch (e) {
                    console.error(e, "LastMsg")
                }

                try {
                    if (evn.St == 1) {
                        $("span[data-st-id='ST" + evn.Id + "']").text(Q.text("Site.Inbox.Unassigned"));
                        $("span[data-st-id='ST" + evn.Id + "']").attr(
                            "class",
                            "lkbadge lkbadge-outline-danger"
                        );
                    }
                    if (evn.St == 2) {
                        $("span[data-st-id='ST" + evn.Id + "']").text(Q.text("Site.Inbox.Assigned"));
                        $("span[data-st-id='ST" + evn.Id + "']").attr(
                            "class",
                            "lkbadge lkbadge-outline-primary"
                        );
                    }
                    if (evn.St == 3) {
                        $("span[data-st-id='ST" + evn.Id + "']").text(Q.text("Site.Inbox.Resolved"));
                        $("span[data-st-id='ST" + evn.Id + "']").attr(
                            "class",
                            "lkbadge lkbadge-outline-success"
                        );
                    }
                } catch (e) {
                    console.error(e, "Status Conversation")
                }

                $(`#msg${evn.Id}`).attr("title", msgTranslator(evn.LastMsg));
                $("#time" + evn.Id).text(
          /*"Today at " + */ getCookie(evn.TimeMsg, "timezone", "TimeOnly")
                );
                if (Inbox.DataRoomActive.Room.Id == evn.Id)
                    $("#elmNeedReply").prop("checked", evn.SdrMsg == "you" && evn.IsNeedReply == 1 ? true : false);
            }

            //fungsi buat element room list
            let BuatRoomList = async function (evn, isClick) {
                if ($("#roomId" + evn.Id).length < 1) {
                    $(".noconversation").css("display", "none");
                    $(".overflowchat").css("display", "block");
                    let resolvedAgent = "",
                        profil = "",
                        online = "",
                        read = "",
                        jmlRead = "",
                        lstmessage = "",
                        iconkontak = "",
                        tags = "",
                        funnel = "",
                        pin = "",
                        pinned = "",
                        sess = "",
                        block = "",
                        statuschat = "",
                        agentofUser = "",
                        viewUserChat = "",
                        muteBotELm = "",
                        AsResolved = "";
                    if (evn.Uc == null) {
                        jmlRead = ``;
                    } else {
                        let notifBaru = evn.Uc == null ? 0 : evn.Uc;
                        let countNotif = notifBaru > 99 ? "99+" : notifBaru;
                        if (notifBaru == 0) {
                            jmlRead = ``;
                        } else {
                            jmlRead = `<span class="lkbadge lkbadge-pill lkbadge-primary">${countNotif}</span>`;
                        }
                    }

                    if (evn.IsGrp == 1) {
                        profil = `data-room-img-group="${evn.GrpId}" style="background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;"`;
                    } else {
                        if (!Q.isEmptyOrNull(evn.CtImg)) {
                            profil = `data-room-img-link="${evn.CtId}" style="background-image: url('${evn.CtImg}');background-size: cover;background-position: center;"`;
                        } else if (!Q.isEmptyOrNull(evn.LinkImg)) {
                            profil = `data-room-img-link="${evn.CtId}" style="background-image: url('${evn.LinkImg}');background-size: cover;background-position: center;"`;
                        } else {
                            profil = `data-room-img-link="${evn.CtId}" style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                        }
                    }

                    if (evn.Sess == 1) {
                        sess = `primary`;
                    } else if (evn.Sess == 2) {
                        sess = `warning`;
                    } else {
                        sess = `danger`;
                    }
                    if (
                        evn.TagsIds == "" ||
                        evn.TagsIds === null ||
                        evn.TagsIds == undefined
                    ) {
                        tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}"></div>`
                    } else {
                        tags = `<div class="chat-context" id="tagConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-tags" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Tags}">${evn.Tags}</span></div>
                                                </div>`;
                    }

                    if (Q.isEmptyOrNull(evn.FnId)) {
                        funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}"></div>`
                    } else {
                        funnel = `<div class="chat-context" id="funnelConversationElm-${evn.Id}">
                                                <div class="text"><i class="fas fa-filter" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Fn}">${evn.Fn}</span></div>
                                                </div>`;
                    }

                    iconkontak = Inbox.Function.renderChannelInListConversation(evn.ChId);

                    if (evn.St == 2) {
                        statuschat =
                            Inbox.IsAgentView == true
                                ? ""
                                : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-primary">${Q.text("Site.Inbox.Assigned")}</span>`;
                        //AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>Mark as Resolved</a></li>`
                    } else if (evn.St == 1) {
                        statuschat =
                            Inbox.IsAgentView == true
                                ? ""
                                : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-danger">${Q.text("Site.Inbox.Unassigned")}</span>`;
                        //AsResolved = `<li onclick="MarkResolved(${evn.Id})"><a>Mark as Resolved</a></li>`
                    } else if (evn.St == 3) {
                        resolvedAgent =
                            Inbox.IsAgentView == true
                                ? `<i class="fas fa-check-circle ml-1 text-success" style="font-size:16px;"></i>`
                                : "";
                        statuschat =
                            Inbox.IsAgentView == true
                                ? ""
                                : `<span data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-success">${Q.text("Site.Inbox.Resolved")}</span>`;
                    }

                    if (evn.IsPin == 2) {
                        pin = `<i data-pin-id="pin${evn.Id}" class="fas fa-thumbtack ml-1" style="font-size:16px;"></i>`;
                        pinned = "pinned";
                    } else {
                        pin = ``;
                        pinned = "";
                    }

                    if (evn.CtIsBlock == 1) {
                        block = `<i data-block-id="block${evn.CtRealId}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`;
                    } else {
                        block = ``;
                    }
                    if (evn.IsMuteBot == 1) {
                        muteBotELm = `<i data-mutebot-id="mutebot${evn.Id}" class="fas fa-robot ml-1 text-danger" style="font-size:16px;"></i>`;
                    } else {
                        muteBotELm = ``;
                    }
                    let sdr = evn.SdrMsg == "me" ? '<i class="fas fa-reply"></i>' : "";
                    let iconMsg = "";
                    if (evn.LastMsg != null) {
                        if (evn.LastMsg.includes('<i class="fa fa-image"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-image"></i> ',
                                ""
                            );
                            iconMsg = '<i class="fa fa-image"></i>';
                        } else if (evn.LastMsg.includes('<i class="fa fa-file"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-file"></i> ',
                                ""
                            );
                            iconMsg = '<i class="fa fa-file"></i>';
                        } else if (
                            evn.LastMsg.includes('<i class="fa fa-microphone"></i>')
                        ) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-microphone"></i>',
                                ""
                            );
                            iconMsg = '<i class="fa fa-microphone"></i>';
                        } else if (evn.LastMsg.includes('<i class="fa fa-video"></i>')) {
                            evn.LastMsg = evn.LastMsg.replace(
                                '<i class="fa fa-video"></i>',
                                ""
                            );
                            iconMsg = '<i class="fa fa-video"></i>';
                        } else if (evn.LastMsg.includes("<i class='fa fa-video'></i>")) {
                            evn.LastMsg = evn.LastMsg.replace(
                                "<i class='fa fa-video'></i> ",
                                ""
                            );
                            iconMsg = '<i class="fa fa-video"></i>';
                        } else if (
                            evn.LastMsg.includes("<i class='fa fa-sticky-note'></i>")
                        ) {
                            evn.LastMsg = evn.LastMsg.replace(
                                "<i class='fa fa-sticky-note'></i> ",
                                ""
                            );
                            iconMsg = '<i class="fa fa-sticky-note"></i>';
                        }
                    }
                    if (evn.TimeMsg == null) {
                        evn.TimeMsg = "";
                    } else if (isToday(new Date(evn.TimeMsg))) {
                        //evn.TimeMsg = "Today at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                        evn.TimeMsg = getCookie(evn.TimeMsg, "timezone", "TimeOnly");
                    } else if (isYesterday(new Date(evn.TimeMsg))) {
                        //evn.TimeMsg = "Yesterday at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                        evn.TimeMsg = Q.text("Site.Inbox.Yesterday");
                    } else {
                        evn.TimeMsg = getCookie(
                            evn.TimeMsg,
                            "timezone",
                            "Date"
                        ) /* + " at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly')*/;
                    }
                    const template = `<li id="roomId${evn.Id
                        }" class="showChatClass chat-item border-bottom disabledLink ///// ${pinned}">
                                        <div class="chat-item-all"><div class="chat-link chat-open">
                                        <div class="chat-media user-lkavatar" ${profil}>
                                        </div>
                                        <div class="chat-info">
                                        <div class="chat-from">
                                        <div class="name" data-room-link="${evn.CtId
                        }" data-room-name="roomNm${evn.Id}">${evn.IsGrp == 1
                            ? evn.Grp
                            : evn.CtRealNm == null
                                ? evn.Ct
                                : evn.CtRealNm
                        }</div>
                                        <span class="time"><span id="time${evn.Id
                        }">${evn.TimeMsg}
                                        </span> <span data-act-id="act${evn.Id
                        }" data-act-ct-id="${evn.CtRealId
                        }">${pin} ${block} ${muteBotELm} ${resolvedAgent}</span></span >
                                        </div>
                                        <div class="chat-context"><div class="text ${evn.SdrMsg == "you" && evn.IsNeedReply == 1 ? "text-danger" : ""}" title="${evn.LastMsg == null ||
                            evn.LastMsg == "null"
                            ? ""
                            : msgTranslator(evn.LastMsg)
                        }" id="msg${evn.Id
                        }"> ${sdr} 
                            ${iconMsg} 
                            ${Q.isEmptyOrNull(evn.UserLastMsg) ? "" : (`<b>${evn.UserLastMsg.length > 12 ? evn.UserLastMsg.substring(0, 12) + "..." : evn.UserLastMsg}: </b>`)}
                            ${evn.LastMsg == null || evn.LastMsg == "null"
                            ? ""
                            : msgTranslator(evn.LastMsg)
                        }</div><div class="status unread" data-read="read${evn.Id
                        }" data-count="${evn.Uc == null ? 0 : evn.Uc}">${jmlRead}</div>
                                        </div>
                                        <div class="chat-context">
                                        <div class="text">${iconkontak}
                                        <span class="text mr-2">${evn.ChAcc
                        }</span></div>
                                        ${statuschat}
                                        </div>
                                        ${tags}
                                        ${funnel}
                                        </div>
                                        </div>
                                        </div>
                                    </li>`;
                    if ($(".pinned").length == 0) {
                        $(`#${initialTab}chatlist`).prepend(template);
                    } else {
                        $(template).insertBefore(
                            "#" + initialTab + " li:eq(" + $(".pinned").length + ")"
                        );
                    }
                    $(".showChatClass").unbind("click");
                    try {
                        await connection.invoke("Subscribe", ["Notifikasi" + evn.Id]);
                        //console.log(`Subscribe Step = ${Step}, Msg = Berhasil gabung ke conversation baru`)
                    } catch (error) {
                        console.error(`Subscribe Step = ${Step}, Msg = ${error}`);
                    }
                    $(".showChatClass").on("click", function () {
                        showChat($(this).attr("id").replace("roomId", ""));
                    });
                    if (isClick) {
                        $(`#roomId${evn.Id}`).click();
                    }
                }
            };
            connection.on("TerimaSubSpv", function (room, obj) {
                let evn = JSON.parse(obj);
                if (
                    $("#roomId" + evn.Id).length < 1 &&
                    (initialTab == "all" || (initialTab == "unassigned" || evn.St == 1) || (initialTab == "assigned" || evn.St == 2) || (initialTab == "resolved" || evn.St == 3))
                ) {
                    let isValid = true;
                    let getFilterOption = localStorage.getItem("filterConversation");

                    if (Inbox.IsAgentView) {
                        getFilterOption = localStorage.getItem("filterConversationAgent");
                    }

                    if (
                        !Q.isEmptyOrNull(getFilterOption) &&
                        getFilterOption != `{"tags":"","fn":"","chs":"","cp":"","dl":"","ac":"","ct":"","lk":"","chat":"","grp":"","ismute":"","readst":"","st":"","ags":""}` &&
                        getFilterOption != `{"tags":"","fn":"","chs":"","cp":"","dl":"","ac":"","ct":"","lk":"","chat":"","grp":"","ismute":"","readst":""}`
                    ) {
                        let filters = JSON.parse(getFilterOption);
                        try {
                            if (evn.Uc == null)
                                evn.Uc = 0;
                            if (filters.readst && filters.readst != evn.Uc) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (evn.IsMuteBot == null)
                                evn.IsMuteBot = 2;
                            if (filters.ismute && filters.ismute != evn.IsMuteBot) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.cp && filters.cp != evn.CampaignId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.ac && filters.ac != evn.ChAccId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.fn && filters.fn != evn.FnId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.st && filters.st != evn.St) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.chs && filters.chs != evn.ChId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.ct && filters.ct != evn.CtRealId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.dl && filters.dl != evn.DealId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.lk && filters.lk != evn.CtId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.grp && filters.grp != evn.GrpId) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.tags && !evn.TagsIds.includes(filters.tags)) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.ags && evn.RoomAgent.filter(ra => filters.ags.includes(ra.UserId)).length == 0) {
                                isValid = false;
                            }
                        } catch (e) { }

                        try {
                            if (filters.chat && (
                                (filters.chat == 0 && !(Q.isEmptyOrNull(evn.IsGrp) || evn.IsGrp == 0)) ||
                                (filters.chat == 1 && evn.IsGrp != 1)
                            )) {
                                isValid = false;
                            }
                        } catch (e) { }

                    }

                    if (isValid)
                        BuatRoomList(evn);

                    let unassignedRoom = evn.St == 1 ? 1 : 0;
                    let jml = Q.isEmptyOrNull($("#countUnassigned>b").text())
                        ? unassignedRoom
                        : Number($("#countUnassigned>b").text()) + unassignedRoom;
                    $("#countUnassigned>b").text(jml);
                } else {
                    updateConversationElm(evn);
                }
            });

            connection.on("TerimaSubAgent", function (room, obj) {
                //console.log(room, obj, "TerimaSubAgent", initialTab);
                let evn = JSON.parse(obj);
                if ($("#roomId" + evn.Id).length < 1) {
                    BuatRoomList(evn);
                    let jml = Q.isEmptyOrNull($("#countUnassigned>b").text())
                        ? 1
                        : Number($("#countUnassigned>b").text()) + 1;
                    $("#countUnassigned>b").text(jml);
                } else {
                    updateConversationElm(evn);
                }
            });

            connection.on("TerimaAck", function (roomId, msgId, status, error, isEdited, editedMsg, objMsg) {
                if (roomId == Inbox.DataRoomActive.Room.Id) {
                    if (isEdited) {
                        let selector = `#chatidchat-container${msgId}`;
                        $(selector).find(".chat-msg-text").text(editedMsg);
                        if ($(selector).find(".chat-meta .fw-bold").length == 0) {
                            $(selector).find(".chat-meta").append(`<li class="fw-bold">${Q.text("Site.Inbox.EditedMsg")}</li>`)
                        }
                    } else {
                        if (status == 2) {
                            $(`#ack${msgId}`).html(`<i class="fas fa-check"></i>`);
                            /*$(`#chatidchat-container${objMsg.Id}`).find("img").attr("src", urlUpload + objFile.Filename);*/
                            objMsg = JSON.parse(objMsg);
                            if (objMsg.Type == "7" || objMsg.Type == "3") {
                                let objFile = JSON.parse(objMsg.File);
                                let urlUpload = objFile.Filename.includes("https") || objFile.Filename.includes("http") ? "" : Q.resolveUrl("~/upload/");
                                $(`#chatidchat-container${objMsg.Id}`).find("a").attr("src", urlUpload + objFile.Filename);
                            } else if (objMsg.Type == "4") {
                                let objFile = JSON.parse(objMsg.File);
                                let urlUpload = objFile.Filename.includes("https") || objFile.Filename.includes("http") ? "" : Q.resolveUrl("~/upload/");
                                $(`#chatidchat-container${objMsg.Id}`).find("video").attr("src", urlUpload + objFile.Filename);
                            } else if (objMsg.Type == "2") {
                                let objFile = JSON.parse(objMsg.File);
                                let urlUpload = objFile.Filename.includes("https") || objFile.Filename.includes("http") ? "" : Q.resolveUrl("~/upload/");
                                $(`#chatidchat-container${objMsg.Id}`).find("audio").attr("src", urlUpload + objFile.Filename);
                            } else if (objMsg.Type == "5") {
                                let objFile = JSON.parse(objMsg.File);
                                let urlUpload = objFile.Filename.includes("https") || objFile.Filename.includes("http") ? "" : Q.resolveUrl("~/upload/");
                                $(`#chatidchat-container${objMsg.Id}`).find("a").attr("onclick", `window.open('${urlUpload + objFile.Filename}','_blank')`);
                            }
                        } else if (status == 3) {
                            $(`#ack${msgId}`).html(`<i class="fas fa-check-double"></i>`);
                        } else if (status == 5) {
                            $(`#ack${msgId}`).html(`<i class="fas fa-check-double text-primary"></i>`);
                        } else if (status == 4) {
                            $(`#ack${msgId}`).html(
                                `<i style="cursor:pointer;" class="fas fa-exclamation-circle text-danger"></i>`
                            );
                            $(`#ack${msgId}`).attr(`data-error`, error);
                            $(`#ack${msgId}`).attr(`data-error-id`, msgId);
                            $(`[data-error-id=${msgId}]`).unbind(`click`);
                            $(`[data-error-id=${msgId}]`).on("click", function () {
                                let dlgErr = new Nobox.DialogErrorDialog();
                                dlgErr.loadEntityAndOpenDialog({
                                    ErrorMessage: $(this).attr("data-error"),
                                });
                            });
                        } else if (status == 1) {
                            $(`#ack${msgId}`).html(`<i class="fas fa-clock"></i>`);
                        }
                    }

                    connection.invoke("ReadMsgCount", Inbox.DataRoomActive.Room.Id);
                }
            });

            //Terima Pesan (terbaru) buat chat bubble (untuk info nantinya bisa lihat "messageReceived")
            connection.on("TerimaPesan", function (room, obj, isAutoResolve, strObjLink) {
                //cek jika roomnya dibuka
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    let arrObj = JSON.parse(obj);
                    if (strObjLink) {
                        if (Inbox.DataRoomActive.Link != null && Inbox.DataRoomActive.ContactReal == null) {
                            let objLink = JSON.parse(strObjLink);
                            if (!Q.isEmptyOrNull(objLink.Name) && Inbox.DataRoomActive.Link.Name != objLink.Name) {
                                Inbox.DataRoomActive.Link.Name = objLink.Name;
                                $(".contactNameExternal").text(Inbox.DataRoomActive.Link.Name)
                                $("#namauser").text(Inbox.DataRoomActive.Link.Name)
                            }
                            if (!Q.isEmptyOrNull(objLink.Photo) && Inbox.DataRoomActive.Link.Photo != objLink.Photo) {
                                Inbox.DataRoomActive.Link.Photo = Inbox.Function.isValidUrl(objLink.Photo) ? objLink.Photo : "/upload/" + objLink.Photo;
                                $(".contactProfileExternal").css("background-image", `url("${Inbox.DataRoomActive.Link.Photo}")`)
                                $("#profiluser").css("background-image", `url("${Inbox.DataRoomActive.Link.Photo}")`)
                                $("#profiluser").attr("data-img", `${Inbox.DataRoomActive.Link.Photo}`)
                            }
                        }
                    }
                    if (arrObj.From != $(".nk-chat-body").attr("data-user-from")) {
                        //tampilkan element dan sembunyikan element
                        $(".isnonresolved").hide();
                        $("#archiveResolved").hide();
                        $(".isnonarchived").hide();
                        $(".isresolvedtool").show();
                        $(".isexpired").hide();
                        $(".isblockedandisresolved").show();
                    }
                    Inbox.Function.TemplateElmMsg.showMsg(arrObj, true, true);

                    connection.invoke("ReadMsgCount", Inbox.DataRoomActive.Room.Id);
                }
            });

            //Terima room baru (terbaru) buat room list baru (untuk info nantinya bisa lihat "tenantReceived")
            connection.on("TerimaRoomBaru", function (TnId, obj) {
                if (TnId.replace("RoomBaru", "") == Inbox.Info.currentUser().TenantId.toString()) {
                    //jika user bukan agent
                    if (Q.Authorization.hasPermission("Role:Supervisor")) {
                        //jika di tab all atau unasiigned
                        if (initialTab == "all" || initialTab == "unassigned") {
                            let evn = JSON.parse(obj);
                            //antisipasi jika element double
                            if ($("#roomId" + evn.Id).length < 1) {
                                BuatRoomList(evn);
                                let jml = Q.isEmptyOrNull($("#countUnassigned>b").text())
                                    ? 1
                                    : Number($("#countUnassigned>b").text()) + 1;
                                $("#countUnassigned>b").text(jml);
                            }
                        }
                    }
                }
            });

            //Terima room baru (terbaru) buat room list baru (untuk info nantinya bisa lihat "tenantReceived")
            connection.on("TerimaRoomBaruAgent", function (TnId, obj, idUser) {
                //console.log("TerimaRoomBaruAgent==>", TnId, obj, idUser)
                if (TnId == Inbox.Info.currentUser().TenantId) {
                    //jika user agent
                    if (!Q.Authorization.hasPermission("Role:Supervisor") && idUser == Inbox.Info.currentUser().UserId) {
                        //jika di tab all atau unasiigned
                        if (initialTab == "allAgent" || initialTab == "ongoingAgent") {
                            let evn = JSON.parse(obj);
                            if (evn.Mode == "Add") {
                                //antisipasi jika element double
                                if ($("#roomId" + evn.Data.Id).length < 1) {
                                    BuatRoomList(evn.Data);
                                }
                            } else if (evn.Mode == "Delete") {
                                $("#roomId" + evn.Data).remove();
                                if (
                                    evn.Data == $(".nk-chat-body").attr("data-id") &&
                                    evn.IdUserDel == Inbox.Info.currentUser().UserId
                                ) {
                                    //window.history.replaceState(null, null, null);
                                    $("#roomId" + evn.Data).remove();
                                    $("#chatnotselected").show();
                                    $("#chatselected").hide();
                                }
                            }
                        }
                    }
                }
            });

            //Terima data kontak (terbaru)
            connection.on("TerimaKontak", function (room, obj) {
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    let objKontak = JSON.parse(obj);
                    $(".contactfound").show();
                    $(".contactnotfound").hide();
                    $("#upProf").attr("data-ctreal-id", objKontak.Id);
                    let nm = ``,
                        pri = ``,
                        eml = ``,
                        adrs = ``,
                        cmp = ``,
                        zcode = ``;
                    if (objKontak.Name) {
                        nm = `<div class="row pt-1 pl-3 pr-3">
                        <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Name")}</b>
                        <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewContact")}" style="cursor:pointer;" id="MkCtName" data-id-ct="${objKontak.Id}">${objKontak.Name}</div>
                    </div>`;
                    }
                    if (objKontak.Country) {
                        pri = `<div class="row pt-1 pl-3 pr-3">
                        <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Country")}</b>
                        <div class="col-8">${objKontak.Country}</div>
                    </div>`;
                    }
                    if (objKontak.State) {
                        eml = `<div class="row pt-1 pl-3 pr-3">
                        <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.State")}</b>
                        <div class="col-8">${objKontak.State}</div>
                    </div>`;
                    }
                    if (objKontak.City) {
                        cmp = `<div class="row pt-1 pl-3 pr-3">
                        <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.City")}</b>
                        <div class="col-8">${objKontak.City}</div>
                    </div>`;
                    }
                    if (objKontak.Address) {
                        adrs = `<div class="row pt-1 pl-3 pr-3">
                            <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Address")}</b>
                            <div class="col-8">${objKontak.Address}</div>
                        </div>`;
                    }
                    if (objKontak.ZipCode) {
                        zcode = `<div class="row pt-1 pl-3 pr-3">
                            <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Postal")}</b>
                            <div class="col-8">${objKontak.ZipCode}</div>
                        </div>`;
                    }
                    if (objKontak.IsBlock == true) {
                        if ($(`[data-block-id="block${objKontak.Id}"]`).length < 1) {
                            $("#unblockCtBtn").show();
                            $("#blockCtBtn").hide();
                            $(`[data-act-ct-id="${objKontak.Id}"]`).append(
                                `<i data-block-id="block${objKontak.Id}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`
                            );
                            $(".isblockedandisresolved").hide();
                            $(".isblocked").hide();
                            $(".isnonblocked").show();
                        }
                        //$(".isnonresolved").hide()
                        $(".isnonarchived").hide();
                    } else {
                        $("#unblockCtBtn").hide();
                        $("#blockCtBtn").show();
                        $(`[data-block-id="block${objKontak.Id}"]`).remove();
                        $(".isblockedandisresolved").show();
                        $(".isblocked").show();
                        $(".isnonblocked").hide();
                        $(".isnonarchived").hide();
                        //$(".isnonresolved").show()
                    }

                    $("div[data-room-link='" + objKontak.LinkId + "']").text(
                        objKontak.Name
                    );
                    $("#namauser").text(objKontak.Name);
                    if (!Q.isEmptyOrNull(objKontak.Profil)) {
                        $("#profiluser").attr(
                            "style",
                            "background-image: url('" +
                            objKontak.Profil +
                            "');background-size: cover;background-position: center;cursor: pointer;"
                        );
                        $("div[data-room-img-link='" + objKontak.LinkId + "']").attr(
                            "style",
                            "background-image: url('" +
                            objKontak.Profil +
                            "');background-size: cover;background-position: center;"
                        );
                    } else {
                        $("#profiluser").attr(
                            "style",
                            "background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;cursor: pointer;"
                        );
                        $("div[data-room-img-link='" + objKontak.LinkId + "']").attr(
                            "style",
                            "background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"
                        );
                    }

                    if (Inbox.DataRoomActive.Room.Sess == 2) {
                        $("#editorChat").hide();
                    }

                    $("#profinfo").html(nm + pri + eml + cmp + adrs + zcode);
                    $("#MkCtName").unbind("click");
                    $("#MkCtName").on("click", function () {
                        let dlg = new Nobox.Nobox.LeadDialog();
                        dlg.isReadonly = true;
                        dlg.loadByIdAndOpenDialog(Number($(this).attr("data-id-ct")));
                    });
                }
            });

            //Terima data campaign (terbaru)
            connection.on("TerimaCampaign", function (room, obj) {
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    let objCampaign = JSON.parse(obj);
                    if (objCampaign == null) {
                        $("#campaignF").hide();
                        $("#campaignNF").show();
                    } else {
                        $("#campaignF").show();
                        $("#campaignNF").hide();
                        let elm = ``;
                        if (objCampaign.Name) {
                            elm =
                                elm +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkCampaignName" data-id-campaign="${objCampaign.Id}">${objCampaign.Name}</div>
                                            </div>`;
                        }
                        if (objCampaign.Status) {
                            let stCampaign = `<span class="lkbadge lkbadge-danger lkbadge-dim">CANCEL</span>`;
                            if (objCampaign.Status == 1) {
                                stCampaign = `<span class="lkbadge lkbadge-secondary lkbadge-dim">DRAFT</span>`;
                            } else if (objCampaign.Status == 2) {
                                stCampaign = `<span class="lkbadge lkbadge-warning lkbadge-dim">PROCESS</span>`;
                            } else if (objCampaign.Status == 3) {
                                stCampaign = `<span class="lkbadge lkbadge-success lkbadge-dim">DONE</span>`;
                            }
                            elm =
                                elm +
                                `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">Status</b>
                                                                    <div class="col-8">${stCampaign}</div>
                                                                </div>`;
                        }
                        $("#campaignF").html(elm);
                        $("#MkCampaignName").unbind("click");
                        $("#MkCampaignName").on("click", function () {
                            let dlg = new Nobox.Nobox.CampaignDialog();
                            dlg.isReadonly = true;
                            dlg.loadByIdAndOpenDialog($(this).attr("data-id-campaign"));
                        });
                    }
                }
            });

            //Terima data form (terbaru)
            connection.on("TerimaFormTemplate", function (room, strObj) {
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    try {
                        let obj = JSON.parse(strObj);
                        $("#FormTemplateF").show();
                        $("#FormResultF").show();
                        $("#FormTemplateNF").hide();
                        $("#FormResultNF").hide();
                        let elmT = ``;
                        let elmR = ``;
                        if (obj.FormTemplateName) {
                            elmT =
                                elmT +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkFormTName" data-id="${obj.FormTemplateId}">${obj.FormTemplateName}</div>
                                            </div>`;
                        }
                        if (obj.FormResultName) {
                            elmR =
                                elmR +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Sender Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkFormRName" data-id="${obj.FormResultId}">${obj.FormResultName}</div>
                                            </div>`;
                        }
                        $("#FormTemplateF").html(elmT);
                        $("#FormResultF").html(elmR);
                        $("#MkFormTName").unbind("click");
                        $("#MkFormTName").on("click", function () {
                            let dlg = new Nobox.NoBoxCRM.FormDialog();
                            dlg.isReadonly = true;
                            dlg.loadByIdAndOpenDialog($(this).attr("data-id"));
                        });
                        $("#MkFormRName").unbind("click");
                        $("#MkFormRName").on("click", function () {
                            let dlg = new Nobox.NoBoxCRM.FormresultsDialog();
                            dlg.isReadonly = true;
                            dlg.loadByIdAndOpenDialog($(this).attr("data-id"));
                        });
                    } catch (e) {
                        $("#FormTemplateF").hide();
                        $("#FormResultF").hide();
                        $("#FormTemplateNF").show();
                        $("#FormResultNF").show();
                    }
                }
            });

            //Terima data Deal (terbaru)
            connection.on("TerimaDeal", function (room, obj) {
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    let objDeal = JSON.parse(obj);
                    if (objDeal == null) {
                        $("#dealF").hide();
                        $("#dealNF").show();
                    } else {
                        $("#dealF").show();
                        $("#dealNF").hide();
                        let elm = ``;
                        if (objDeal.Name) {
                            elm =
                                elm +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewDeal")}" style="cursor:pointer;" id="MkDealName" data-id-deal="${objDeal.Id}">${objDeal.Name}</div>
                                            </div>`;
                        }
                        if (objDeal.Pipeline) {
                            elm =
                                elm +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Pipeline</b>
                                                <div class="col-8">${objDeal.Pipeline}</div>
                                            </div>`;
                        }
                        if (objDeal.Stage) {
                            elm =
                                elm +
                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Stage</b>
                                                <div class="col-8">${objDeal.Stage}</div>
                                            </div>`;
                        }

                        $("#dealF").html(elm);
                        $("#MkDealName").unbind("click");
                        $("#MkDealName").on("click", function () {
                            let dlg = new Nobox.CRM.DealsDialog();
                            dlg.isReadonly = true;
                            dlg.loadByIdAndOpenDialog($(this).attr("data-id-deal"));
                        });
                    }
                }
            });

            //Terima data Note (terbaru)
            connection.on("TerimaNote", function (room, obj) {
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    let objNote = JSON.parse(obj);
                    if (objNote.Mode == "Add") {
                        Inbox.DataRoomActive.Notes.push({ Id: objNote.Id, Cnt: objNote.Cnt });
                    }
                    if (objNote.Mode == "Edit") {
                        let i = Inbox.DataRoomActive.Notes.findIndex(function (z) {
                            return z.Id == objNote.Id;
                        });
                        Inbox.DataRoomActive.Notes[i].Cnt = objNote.Cnt;
                    }
                    if (objNote.Mode == "Delete") {
                        let i = Inbox.DataRoomActive.Notes.findIndex(function (z) {
                            return z.Id == objNote.Id;
                        });
                        Inbox.DataRoomActive.Notes.splice(i, 1);
                    }
                    if (Inbox.DataRoomActive.Notes.length > 0) {
                        $("#notesarr").addClass("mt-1");
                        document.getElementById("notesarr").innerHTML = Inbox.DataRoomActive.Notes
                            .map(function (e) {
                                return (
                                    '<div class="row pb-1 pt-1" style="margin-top:-10px;">' +
                                    '<div class="text col-9 pl-3">' +
                                    e.Cnt +
                                    "</div>" +
                                    '<i class="fa fa-edit mt-1 col-1 editnote" style="right:0;cursor:pointer;" data-note="' +
                                    e.Id +
                                    '"></i>' +
                                    '<i class="fa fa-trash text-danger mt-1 col-1 deletenote" style="right:0;cursor:pointer;" data-note="' +
                                    e.Id +
                                    '"></i>' +
                                    "</div>"
                                );
                            })
                            .join("\n");
                        $(".editnote").unbind("click");
                        $(".editnote").on("click", function () {
                            let dlg = new Nobox.ChatnotesDialog();
                            dlg.userLogin = Inbox.Info.currentUser();
                            dlg.ObjAccount = Inbox.DataRoomActive.Account;
                            dlg.ObjLink = Inbox.DataRoomActive.Link;
                            dlg.callback = async (data) => {
                                try {
                                    await connection.invoke(
                                        "MkNote",
                                        $(".nk-chat-body").attr("data-id"),
                                        JSON.stringify(data)
                                    );
                                    Q.notifySuccess(Q.text("Site.Inbox.EditNote"));
                                } catch (error) {
                                    console.error(`MkNote Step = ${Step}, Msg = ${error}`);
                                }
                            };
                            dlg.applyChangesButton.remove();
                            dlg.loadByIdAndOpenDialog($(this).attr("data-note"));
                        });
                        $(".deletenote").unbind("click");
                        $(".deletenote").on("click", function () {
                            Q.confirm(
                                Q.text("Site.Inbox.ConfirmDelNote"),
                                () => {
                                    Q.serviceCall({
                                        blockUI: false,
                                        url: "/Services/Chat/Chatnotes/Delete",
                                        request: {
                                            EntityId: $(this).attr("data-note"),
                                        },
                                        onSuccess: async (res) => {
                                            try {
                                                let objNote = {
                                                    Id: $(this).attr("data-note"),
                                                    Mode: "Delete",
                                                };
                                                await connection.invoke(
                                                    "MkNote",
                                                    $(".nk-chat-body").attr("data-id"),
                                                    JSON.stringify(objNote)
                                                );
                                                Q.notifySuccess(Q.text("Site.Inbox.DelNote"));
                                            } catch (error) {
                                                console.error(`MkNote Step = ${Step}, Msg = ${error}`);
                                            }
                                        },
                                    });
                                },
                                {
                                    onNo: () => {
                                        Q.notifyInfo(`${Q.text("Site.Inbox.Del")} Failed.`);
                                    },
                                    //title: "Delete note",
                                }
                            );
                        });
                    } else {
                        $("#notesarr").removeClass("mt-1");
                        $("#notesarr").html(
                            `<span class='text-danger' onclick="$('#addnote').click()" style="cursor: pointer;">${Q.text("Site.Inbox.NotSet")}</span>`
                        );
                    }
                }
            });

            //Terima data agent (terbaru)
            connection.on("TerimaAgent", function (room, objAgent, objMsg, jmlUnassigned) {
                objAgent = JSON.parse(objAgent);
                objMsg = JSON.parse(objMsg);
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    if (objAgent.Mode == "Add") {
                        objAgent.Data.UserId = Number(objAgent.Data.UserId);
                        objAgent.Data.Id = Number(objAgent.Data.Id);
                        Inbox.DataRoomActive.Agents.push(objAgent.Data);
                        BuatElementAgent();
                    } else if (objAgent.Mode == "Delete") {
                        const index = Inbox.DataRoomActive.Agents.findIndex((object) => {
                            return object.Id == Number(objAgent.Data);
                        });
                        Inbox.DataRoomActive.Agents.splice(index, 1);
                        BuatElementAgent();
                    } else if (objAgent.Mode == "Edit") {
                        const index = Inbox.DataRoomActive.Agents.findIndex((object) => {
                            return object.UserId == Number(objAgent.IdUserDel);
                        });
                        Inbox.DataRoomActive.Agents.splice(index, 1);
                        objAgent.Data.UserId = Number(objAgent.Data.UserId);
                        objAgent.Data.Id = Number(objAgent.Data.Id);
                        Inbox.DataRoomActive.Agents.push(objAgent.Data);
                        BuatElementAgent();
                        if (Inbox.Info.currentUser().UserId == Number(objAgent.IdUserDel)) {
                            $("#chatnotselected").show();
                            $("#chatselected").hide();
                            $("#roomId" + $(".nk-chat-body").attr("data-id")).remove();
                        }
                    }
                    Inbox.Function.TemplateElmMsg.showMsg(objMsg, true, true);
                    //if (parseInt($("#chat-container")[0].scrollHeight) - parseInt($("#chatBox").scrollTop()) + 5 <= parseInt($("#chatBox").outerHeight())) {
                    //    createChatMessage(
                    //        objMsg,
                    //        "#chat-container",
                    //        $("#upProf").attr("data-ct-nm"),
                    //        "append"
                    //    );
                    //} else {
                    //    createChatMessage(
                    //        objMsg,
                    //        "#chat-container",
                    //        $("#upProf").attr("data-ct-nm"),
                    //        "append",
                    //        "Bawah"
                    //    );
                    //}
                }
                if (jmlUnassigned != null) {
                    $("#countUnassigned").html(
                        "<b class='text-danger'>" + jmlUnassigned + "</b>"
                    );
                }
                if (Inbox.DataRoomActive.Agents.length > 0) {
                    $('[data-st-id="ST' + room.replace("RoomId", "") + '"]')
                        .attr("class", "lkbadge lkbadge-outline-primary")
                        .text(Q.text("Site.Inbox.Assigned"));
                } else {
                    $('[data-st-id="ST' + room.replace("RoomId", "") + '"]')
                        .attr("class", "lkbadge lkbadge-outline-danger")
                        .text(Q.text("Site.Inbox.Unassigned"));
                }
            }
            );

            //Terima data Funnel (terbaru)
            connection.on("TerimaFunnel", function (room, obj) {
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    let objFunnel = JSON.parse(obj);
                    Inbox.Data.FunnelCanChange = false;
                    if (objFunnel.Mode == "Add") {
                        Inbox.Data.Funnels.push({ Id: objFunnel.Id, Nm: objFunnel.Nm });
                        if ($("#funnelskanan").find("option[value='" + objFunnel.Id + "']").length) {
                            $("#funnelskanan").val(objFunnelIid).trigger("change");
                        } else {
                            // Create a DOM Option and pre-select by default
                            let newOption = new Option(
                                objFunnel.Nm,
                                objFunnel.Id,
                                true,
                                true
                            );
                            // Append it to the select
                            $("#funnelskanan").append(newOption).trigger("change");
                        }
                    } else if (objFunnel.Mode == "Select") {
                        $("#funnelskanan").val(objFunnel.Id);
                        $("#funnelskanan").trigger("change");
                    }
                    let strFunnel = "";
                    let valFunnelId = $("#funnelskanan").val();
                    if (valFunnelId) {
                        const result = Inbox.Data.Funnels.find(d => d.Id == valFunnelId);
                        if (result != null)
                            strFunnel = `<div class="text">
                                        <i class="fas fa-filter" style="font-size:initial;"></i>
                                        <span style="font-size:11px;" title="${result.Nm}">${result.Nm}</span>
                                    </div>`
                    }
                    $(`#funnelConversationElm-${Inbox.DataRoomActive.Room.Id}`).html(strFunnel)
                }
            });

            //Terima data Funnel (terbaru)
            connection.on("TerimaNeedReply", function (room, needReply) {
                let elm = $(`#msg${room}`);
                if (needReply == 1 && !elm.hasClass("text-danger")) {
                    elm.addClass("text-danger");
                } else {
                    elm.removeClass("text-danger");
                }
            })
            connection.on("TerimaDataBaruSpv", function (strDt) {
                Inbox.Function.updateData(strDt)
            })
            connection.on("TerimaDataBaruAgent", function (strDt) {
                Inbox.Function.updateData(strDt)
            })

            //Terima data Funnel (terbaru)
            connection.on("TerimaTag", function (room, obj) {
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    let objTag = JSON.parse(obj);
                    Inbox.Data.TagCanChange = false;
                    if (objTag.Mode == "Add") {
                        if (Inbox.Data.Tags.findIndex(t => t.Id == objTag.Id) == -1)
                            Inbox.Data.Tags.push({ Id: objTag.Id, Nm: objTag.Nm });

                        if ($("#tagskanan").find("option[value='" + objTag.Id + "']").length) {
                            let currentVal = $("#tagskanan").val()
                            currentVal.push(objTag.Id);
                            $("#tagskanan").val(currentVal).trigger("change");
                        } else {
                            // Create a DOM Option and pre-select by default
                            let newOption = new Option(objTag.Nm, objTag.Id, true, true);
                            // Append it to the select
                            $("#tagskanan").append(newOption).trigger("change");
                        }
                    } else if (objTag.Mode == "Select") {
                        $("#tagskanan").val(objTag.Id);
                        $("#tagskanan").trigger("change");
                    }

                    let strTags = "";
                    let valTagIds = $("#tagskanan").val();
                    if (valTagIds.length) {
                        const result = valTagIds
                            .map(id => {
                                const item = Inbox.Data.Tags.find(d => d.Id == id);
                                return item ? item.Nm : null; // Mengambil Nm jika ada, null jika tidak ditemukan
                            })
                            .filter(nm => nm !== null) // Menghapus nilai null jika ada id yang tidak ditemukan
                            .join(", ");
                        strTags = `<div class="text">
                                        <i class="fas fa-tags" style="font-size:initial;"></i>
                                        <span style="font-size:11px;" title="${result}">${result}</span>
                                    </div>`
                    }
                    $(`#tagConversationElm-${Inbox.DataRoomActive.Room.Id}`).html(strTags)
                }
            });

            //menerima resolved message
            connection.on("TerimaUpdateResolve", function (id, pesan /*, archive*/, unassigned) {
                if (id == Inbox.DataRoomActive.Room.Id) {
                    pesan = JSON.parse(pesan);
                    let dataSap = isValidJson(pesan.Msg);
                    if (!dataSap.err) {
                        let objSap = dataSap.data;
                        let objUserHandle = Inbox.Default.Users.filter(xy => xy.UserId == objSap.userHandle);
                        if (objUserHandle.length > 0) {
                            pesan.Msg = objSap.msg.search("HasResolveBy") != -1 || objSap.msg.search("HasArchiveBy") != -1 || objSap.msg.search("HasRestoreBy") != -1 ? `${Q.text(objSap.msg)} <b>${objUserHandle[0].DisplayName}</b>` : `<b>${objUserHandle[0].DisplayName}</b> ${Q.text(objSap.msg)}`;
                            let objUser = Inbox.Default.Users.filter(xy => xy.UserId == objSap.user);
                            if (objUser.length > 0)
                                e.Msg = objSap.msg != "Site.Inbox.TransferTo" ? `<b>${objUserHandle[0].DisplayName}</b> ${Q.text(objSap.msg)} <b>${objUser[0].DisplayName}</b>` : `<b>${objUser[0].DisplayName}</b> ${Q.text(objSap.msg)} <b>${objUserHandle[0].DisplayName}</b>`;
                        } else {
                            e.Msg = Q.text(objSap.msg);
                        }
                    }
                    $(`#roomId${id}`).removeClass(" pinned");
                    $("#chat-container").append(`<div class="chat-sap ml-4 mr-4">
                                    <div class="chat-sap-meta"><span>${isToday(new Date(pesan.In))
                            ? Q.text("Site.Inbox.TodayAt") + " " +
                            getCookie(
                                pesan.in,
                                "timezone",
                                "TimeOnly"
                            )
                            : isYesterday(new Date(pesan.In))
                                ? Q.text("Site.Inbox.YesterdayAt") + " " +
                                getCookie(
                                    pesan.in,
                                    "timezone",
                                    "TimeOnly"
                                )
                                : getCookie(
                                    pesan.In,
                                    "timezone",
                                    "Date"
                                ) +
                                " at " +
                                getCookie(
                                    pesan.in,
                                    "timezone",
                                    "TimeOnly"
                                )
                        }  - ${pesan.Msg}</span></div>
                                </div>`);
                    $("#archiveResolved").show();
                    $("#funnelskanan").prop("disabled", true);
                    $("#tagskanan").prop("disabled", true);
                    $(".isnonresolved").show();
                    $(".isresolvedtool").hide();
                    $(".isblockedandisresolved").hide();
                    $("#btnaddtags").hide();
                    $("#btnaddfunnels").hide();
                    $("#DoNotresolvedBTN").hide();
                    $(".DoNotresolvedBTN").text("");
                    $("#showWhenArchiveAndResolved").show();
                }
                $(`#msg${id}`).removeClass("text-danger")
                if (Q.Authorization.hasPermission("Role:Supervisor")) {
                    $('[data-st-id="ST' + id + '"]')
                        .attr("class", "lkbadge lkbadge-outline-success")
                        .text(Q.text("Site.Inbox.Resolved"));
                } else {
                    $('[data-act-id="act' + id + '"]').html(
                        '<i class="fas fa-check-circle ml-1 text-success" style="font-size:16px;"></i>'
                    );
                }
                $('[data-pin-id="pin' + id + '"]').remove();
                //$("#roomId" + id).insertAfter(
                //    "#" + initialTab + " li:eq(" + $(".pinned").length + ")"
                //);
                $("#countUnassigned").html(
                    "<b class='text-danger'>" + unassigned + "</b>"
                );
            });

            //menerima archived message
            connection.on("TerimaArchive", function (id, unassign, archive) {
                if (id == $(".nk-chat-body").attr("data-id")) {
                    $("#chatnotselected").show();
                    $("#chatselected").hide();
                    //window.history.replaceState(null, null, null);
                }
                $("#roomId" + id).remove();
                //window.history.replaceState(null, null, null);
                if (Q.Authorization.hasPermission("Role:Supervisor")) {
                    //Archive Count
                    //$("#countArchived").text(archive)

                    if (unassign != null) {
                        //Unassigned Count
                        $("#countUnassigned").html(
                            "<b class='text-danger'>" + unassign + "</b>"
                        );
                    }
                }
            });

            //menerima expired message
            connection.on("TerimaExpired", function (roomId, time, msg, isNotExpired) {
                if (roomId == Inbox?.DataRoomActive?.Room?.Id) {
                    if (isNotExpired) {
                        $("#CTemplateElm").hide();
                        $("#editorChat").show();
                    } else {
                        $("#CTemplateElm").show();
                        $("#editorChat").hide();
                        $("#chat-container").append(`<div class="chat-sap ml-4 mr-4">
                                    <div class="chat-sap-meta"><span>${isToday(new Date(time))
                                ? Q.text("Site.Inbox.TodayAt") + " " +
                                getCookie(
                                    time,
                                    "timezone",
                                    "TimeOnly"
                                )
                                : isYesterday(new Date(time))
                                    ? Q.text("Site.Inbox.YesterdayAt") + " " +
                                    getCookie(
                                        time,
                                        "timezone",
                                        "TimeOnly"
                                    )
                                    : getCookie(
                                        time,
                                        "timezone",
                                        "Date"
                                    ) +
                                    " at " +
                                    getCookie(
                                        time,
                                        "timezone",
                                        "TimeOnly"
                                    )
                            }  - ${Q.text(msg)}</span></div>
                                </div>`);
                    }
                }
            });

            //menerima restore archived message
            connection.on("TerimaRestoreArchive", function (id, unassign, archive) {
                if (id == `${Inbox.DataRoomActive.Room.Id}`) {
                    $("#chatnotselected").show();
                    $("#chatselected").hide();
                }
                $("#roomArId" + id).remove();
                //window.history.replaceState(null, null, null);
                if (Q.Authorization.hasPermission("Role:Supervisor")) {
                    //Archive Count
                    //$("#countArchived").text(archive)

                    if (unassign != null) {
                        //Unassigned Count
                        $("#countUnassigned").html(
                            "<b class='text-danger'>" + unassign + "</b>"
                        );
                    }
                }
            });

            //menerima ketika ada pesan yang di hapus
            connection.on("TerimaDelMsg", function (room, id, isLastMsg) {
                if (room == "RoomId" + $(".nk-chat-body").attr("data-id")) {
                    $("#chatidchat-container" + id).remove();
                    if (isLastMsg) {
                        $(`#msg${Inbox.DataRoomActive.Room.Id}`).html(Q.text("Site.Inbox.DeletedMessage"));
                    }
                }
            });

            //menerima ketika pin/unpin conversation
            connection.on("TerimaPinUnpin", function (room, num) {
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    if (num == 2) {
                        $(
                            '[data-pin-id="pin' + Inbox.DataRoomActive.Room.Id + '"]'
                        ).remove();
                        $("#pinBTN").html(
                            `<a data-pin="1" class="PinnedRoom lkdropdown-item disabledLink" href="#"><span>Pin</span></a>`
                        );
                        $(`#roomId${Inbox.DataRoomActive.Room.Id}`).removeClass(" pinned");
                        $("#roomId" + Inbox.DataRoomActive.Room.Id).insertAfter(
                            "#" + initialTab + " li:eq(" + $(".pinned").length + ")"
                        );
                        //$("ul#allchatlist li:last-child").attr("class", "pinned").after($("#roomId" + $(".nk-chat-body").attr("data-id")).html())
                    } else {
                        $("#roomId" + Inbox.DataRoomActive.Room.Id).insertBefore(
                            "#" + initialTab + " li:eq(" + $(".pinned").length + ")"
                        );
                        $(
                            '[data-act-id="act' + Inbox.DataRoomActive.Room.Id + '"]'
                        ).prepend(
                            `<i data-pin-id="pin${Inbox.DataRoomActive.Room.Id}" class="fas fa-thumbtack ml-1" style="font-size:16px;"></i>`
                        );
                        $("#pinBTN").html(
                            `<a data-pin="2" class="PinnedRoom lkdropdown-item disabledLink" href="#"><span>Unpin</span></a>`
                        );
                        $(`#roomId${Inbox.DataRoomActive.Room.Id}`).addClass(" pinned");
                    }
                    $(".PinnedRoom").unbind("click");
                    $(".PinnedRoom").on("click", function () {
                        pinnedroom($(this).attr("data-pin"));
                    });
                }
            });

            //menerima ketika block/unblock contact
            connection.on("TerimaBlockUnblock", function (room, st, ctId, num) {
                if (num == 1) {
                    $("#unblockCtBtn").show();
                    $("#blockCtBtn").hide();
                    $(`[data-act-ct-id="${ctId}"]`).append(
                        `<i data-block-id="block${ctId}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`
                    );
                } else {
                    $("#unblockCtBtn").hide();
                    $("#blockCtBtn").show();
                    $(`[data-block-id="block${ctId}"]`).remove();
                }
                if (room == "RoomId" + Inbox.DataRoomActive.Room.Id) {
                    if (num == 1) {
                        $(".isblockedandisresolved").hide();
                        $(".isblocked").hide();
                        $(".isnonblocked").show();
                        //$(".isnonresolved").hide()
                        $(".isnonarchived").hide();
                        $(".isnonresolved").hide();
                    } else {
                        $(".isblockedandisresolved").show();
                        $(".isblocked").show();
                        $(".isnonblocked").hide();
                        $(".isnonarchived").hide();
                        //$(".isnonresolved").show();
                    }

                    if (st == 3) {
                        if (num == 1) {
                            $(".isnonresolved").hide();
                        } else {
                            $(".isnonresolved").show();
                        }
                        $(".isblockedandisresolved").hide();
                    }
                }
            });

            //menerima ketika bot dimute/diunmute
            connection.on("TerimaMuteUnmuteBot", function (room, isMute) {
                if (room.replace("RoomId", "") == Inbox.DataRoomActive?.Room?.Id) {
                    if (isMute != $("#elmMuteBot").is(":checked"))
                        $("#elmMuteBot").prop('checked', isMute);

                    changeElmBotMutedIconListConversation(isMute)
                }
            })

            $("#btnSelectTemplate").on("click", () => {
                let dlg = new Nobox.SelectWaBusinessAPITemplateDialog();
                dlg.setFilter(Inbox?.DataRoomActive?.Room?.ChAccId);
                dlg.linkId = Inbox.DataRoomActive.Link.IdExt;
                dlg.callback = (template, dataTemplate, dataTemplateInbox) => {
                    let objMsg = {
                        Room: {
                            IdLink:
                                Inbox.DataRoomActive.Link == null
                                    ? null
                                    : Inbox.DataRoomActive.Link.Id,
                            IdGroup:
                                Inbox.DataRoomActive.Group == null
                                    ? null
                                    : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {},
                        Template: JSON.stringify({
                            template: template,
                            data: dataTemplate,
                            dataInbox: dataTemplateInbox
                        })
                    };
                    KirimPesan(
                        JSON.stringify(objMsg),
                        `${Inbox.DataRoomActive.Room.Id}`
                    );
                }
                dlg.dialogOpen();
            })

            function isValidJson(str) {
                try {
                    let data = JSON.parse(str);
                    return { err: false, data: data };
                } catch (e) {
                    return { err: true };
                }
            }

            $("#cancelReplyElm").on("click", () => {
                if ($("#previewReplyElm").is(":visible"))
                    $("#previewReplyElm").slideToggle(200);

                Inbox.ReplyIdMsg = null;
            })

            function TampilMenuKanan() {
                let locSto = localStorage.getItem("RightMenu");
                if (locSto == "Shown") {
                    $("#panelkananch").removeClass(" visible");
                    $("#panelkanandetail").removeClass(" visible");
                    $("#panelkanan").addClass(" visible");
                    $("#chatselected").addClass(" profile-shown");
                } else {
                    $("#panelkananch").removeClass(" visible");
                    $("#panelkanandetail").removeClass(" visible");
                    $("#panelkanan").removeClass(" visible");
                    $("#chatselected").removeClass(" profile-shown");
                }
            }

            //edit contact
            $("#upProf").on("click", function () {
                let dlg = new Nobox.Nobox.LeadDialog();
                //dlg.onDialogClose = () => {
                //    TampilMenuKanan();
                //}
                dlg.callback = async (response) => {
                    TampilMenuKanan();
                    try {
                        response.LinkId = Inbox.DataRoomActive.Link.Id;
                        await connection.invoke(
                            "MkKontak",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessEditContact"));
                    } catch (error) {
                        console.error(`MkKontak Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.loadByIdAndOpenDialog(Number($("#upProf").attr("data-ctreal-id")));
            });

            //mute bot
            function changeElmBotMutedIconListConversation(isMute) {
                if (isMute) {
                    $(`[data-act-id="act${Inbox.DataRoomActive.Room.Id}"]`).append(
                        `<i data-mutebot-id="mutebot${Inbox.DataRoomActive.Room.Id}" class="fas fa-robot ml-1 text-danger" style="font-size:16px;"></i>`
                    );
                } else {
                    $(`[data-mutebot-id="mutebot${Inbox.DataRoomActive.Room.Id}"]`).remove();
                }
            }
            $("#elmMuteBot").on("change", function () {
                // Ambil value dari checkbox (true jika checked, false jika tidak)
                var isChecked = $(this).is(":checked");

                if (Inbox.DataRoomActive?.Link) {
                    if (isChecked) {
                        let hsl = connection.invoke("MuteBot", Inbox.DataRoomActive.Room.Id, Inbox.DataRoomActive.Account.Id, Inbox.DataRoomActive.Link.IdExt, Inbox.DataRoomActive.Link.Id);
                        if (hsl) {
                            Q.notifySuccess("Success mute bot")
                        } else {
                            Q.notifyError("Failed mute bot")
                        }
                    } else {
                        let hsl = connection.invoke("UnmuteBot", Inbox.DataRoomActive.Room.Id, Inbox.DataRoomActive.Account.Id, Inbox.DataRoomActive.Link.IdExt, Inbox.DataRoomActive.Link.Id);
                        if (hsl) {
                            Q.notifySuccess("Success unmute bot")
                        } else {
                            Q.notifyError("Failed unmute bot")
                        }
                    }
                } else {
                    //grup
                }
            });
            $("#elmNeedReply").on("change", function () {
                // Ambil value dari checkbox (true jika checked, false jika tidak)
                var isChecked = $(this).is(":checked");

                if (Inbox.DataRoomActive?.Link) {
                    connection.invoke("MkNeedReply", Inbox.DataRoomActive.Room.Id, isChecked ? 1 : 0);
                } else {
                    //grup
                }
            });

            //buat contact baru
            $("#addContact").on("click", function () {
                let dlg = new Nobox.Nobox.LeadDialog();
                //dlg.onDialogClose = () => {
                //    TampilMenuKanan();
                //}
                dlg.callback = async (response) => {
                    TampilMenuKanan();
                    try {
                        response.LinkId = Inbox.DataRoomActive.Link.Id;
                        await connection.invoke(
                            "MkKontak",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddContact"));
                    } catch (error) {
                        console.error(`MkKontak Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.loadEntityAndOpenDialog({ LinkId: Inbox.DataRoomActive.Link.Id, Name: Inbox.DataRoomActive.Link.Name });
            });

            //join contact yg sudah ada
            $("#pickContact").on("click", function () {
                let dlg = new Nobox.Nobox.SelectLinkRoomDialog();
                dlg.onDialogClose = () => {
                    TampilMenuKanan();
                };
                dlg.callback = async (response) => {
                    TampilMenuKanan();
                    try {
                        response.LinkId = Inbox.DataRoomActive.Link.Id;
                        await connection.invoke(
                            "MkKontak",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddContact"));
                    } catch (error) {
                        console.error(`MkKontak Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.IdLink = Inbox.DataRoomActive.Link.Id;
                dlg.dialogOpen();
            });

            //join campaign
            $("#pickCampaign").on("click", function () {
                let dlg = new Nobox.Nobox.SelectCampignRoomDialog();
                dlg.onDialogClose = () => {
                    TampilMenuKanan();
                };
                dlg.callback = async (response) => {
                    TampilMenuKanan();
                    try {
                        await connection.invoke(
                            "MkCampaign",
                            Inbox.DataRoomActive.Room.Id,
                            Number(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddCampaign"));
                    } catch (error) {
                        console.error(`MkCampaign Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.IdRoom = Inbox.DataRoomActive.Room.Id;
                //dlg.loadNewAndOpenDialog();
                dlg.loadEntityAndOpenDialog({ ChId: Inbox.DataRoomActive.Room.ChId });
            });

            //join form
            $("#pickForm").on("click", function () {
                let dlg = new Nobox.Nobox.SelectFormDialog();
                dlg.onDialogClose = () => {
                    TampilMenuKanan();
                };
                dlg.callback = async (templateId, resultId) => {
                    TampilMenuKanan();
                    try {
                        await connection.invoke(
                            "MkForm",
                            $(".nk-chat-body").attr("data-id"),
                            `${resultId}`,
                            `${templateId}`
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddForm"));
                    } catch (error) {
                        console.error(`MkForm Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.IdRoom = Inbox.DataRoomActive.Room.Id;
                dlg.loadEntityAndOpenDialog({
                    FormResultId: Inbox.DataRoomActive.Room.FormResultId,
                    FormTemplateId: Inbox.DataRoomActive.Room.FormTemplateId,
                });
            });

            //buat deal
            $("#addDeal").on("click", function () {
                let dlg = new Nobox.CRM.DealsDialog();
                dlg.callback = async (response) => {
                    dlg.dialogClose();
                    TampilMenuKanan();
                    try {
                        await connection.invoke(
                            "MkDeal",
                            Inbox.DataRoomActive.Room.Id,
                            Number(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddDeal"));
                    } catch (error) {
                        console.error(`MkDeal Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.isFromConversation = true;
                dlg.idRoom = Inbox.DataRoomActive.Room.Id;
                dlg.loadNewAndOpenDialog();
            });

            //join ke deal yg sudah ada
            $("#pickDeal").on("click", function () {
                let dlg = new Nobox.Nobox.SelectDealRoomDialog();
                dlg.onDialogClose = () => {
                    TampilMenuKanan();
                };
                dlg.callback = async (response) => {
                    TampilMenuKanan();
                    try {
                        await connection.invoke(
                            "MkDeal",
                            Inbox.DataRoomActive.Room.Id,
                            Number(response)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddDeal"));
                    } catch (error) {
                        console.error(`MkDeal Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.IdRoom = Inbox.DataRoomActive.Room.Id;
                dlg.loadNewAndOpenDialog();
            });

            function addTags() {
                let dlg = new Nobox.ChattagsDialog();
                dlg.callback = async (res, tag) => {
                    try {
                        let objFunnel = {
                            Mode: "Add",
                            Id: `${res.EntityId}`,
                            Nm: tag,
                        };
                        await connection.invoke(
                            "MkTag",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(objFunnel),
                            JSON.stringify($("#tagskanan").val())
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddTag"));
                    } catch (error) {
                        console.error(`MkTag Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.applyChangesButton.remove();
                dlg.loadNewAndOpenDialog();
            }

            function addFunnel() {
                let dlg = new Nobox.ChatfunnelsDialog();
                dlg.callback = async (res, funnel) => {
                    try {
                        let objFunnel = {
                            Mode: "Add",
                            Id: `${res.EntityId}`,
                            Nm: funnel,
                        };
                        await connection.invoke(
                            "MkFunnel",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(objFunnel)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddFunnel"));
                    } catch (error) {
                        console.error(`MkFunnel Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.applyChangesButton.remove();
                dlg.loadNewAndOpenDialog();
            }

            let timeoutId;
            //cari conversation yang bukan agent
            $("#srcCtCon").on("input", function (e) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    skeletonchat(initialTab, $("#srcCtCon").val());
                }, 1500);
            });

            //cari conversation versi agent
            $("#srcCtConAgent").on("input", function (e) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    skeletonchat(initialTab, $("#srcCtConAgent").val());
                }, 1500);
            });

            //cari conversation archive
            $("#srcCtConAr").on("input", function (e) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    BuatListConversation("archive", $("#srcCtConAr").val());
                }, 1500);
            });

            //Pin conversation (belum dipaje)
            function pinnedroom(num) {
                let txt = "",
                    ispin = 1;
                if (num == 2) {
                    txt = "Unpin";
                    ispin = 1;
                } else {
                    txt = "Pin";
                    ispin = 2;
                }
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmPinRoom").replace("{0}", txt),
                    async () => {
                        await connection.invoke(
                            "RoomPinUnpin",
                            Inbox.DataRoomActive.Room.Id,
                            ispin
                        );
                        Q.notifySuccess(txt == "Pin" ? Q.text("Site.Inbox.SuccessPinRoom") : Q.text("Site.Inbox.SuccessUnPinRoom"));
                    },
                    {
                        onNo: () => { },
                        // title: txt + " conversation?"
                    }
                );
            }

            //Block conversation (belum dipake)
            function blockedroom(num) {
                let txt = "",
                    isblock = 1;
                if (num == 2) {
                    txt = "Unblock";
                    isblock = 1;
                } else {
                    txt = "Block";
                    isblock = 2;
                }
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmPinRoom").replace("{0}", txt),
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/Update",
                            request: {
                                EntityId: $(".nk-chat-body").attr("data-id"),
                                Entity: { IsBlock: isblock },
                            },
                            onSuccess: (res) => {
                                Q.notifySuccess(txt + Q.text("Site.Inbox.SuccessPinRoom"));
                                if (num == 2) {
                                    $(
                                        '[data-block-id="block' +
                                        $(".nk-chat-body").attr("data-id") +
                                        '"]'
                                    ).remove();
                                    $("#blockBTN").html(
                                        `<a data-block="1" class="BlockedRoom lkdropdown-item disabledLink" href="#"><span>Block</span></a>`
                                    );
                                    $(".isblockedandisresolved").show();
                                    $(".isblocked").show();
                                    $(".isnonblocked").hide();
                                } else {
                                    $(
                                        '[data-act-id="act' +
                                        $(".nk-chat-body").attr("data-id") +
                                        '"]'
                                    ).append(
                                        `<i data-block-id="block${$(".nk-chat-body").attr(
                                            "data-id"
                                        )}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`
                                    );
                                    $("#blockBTN").html(
                                        `<a data-block="2" class="BlockedRoom lkdropdown-item disabledLink" href="#"><span>Unblock</span></a>`
                                    );
                                    $(".isblockedandisresolved").hide();
                                    $(".isblocked").hide();
                                    $(".isnonblocked").show();
                                    //let dlg = new Nobox.ChatcontactsRsBlkDialog()
                                    //dlg.loadByIdAndOpenDialog($("#upProf").attr("data-ct-id"))
                                }
                                $(".BlockedRoom").on("click", function () {
                                    blockedroom($(this).attr("data-block"));
                                });
                            },
                        });
                    },
                    {
                        onNo: () => { },
                    }
                );
            }

            //block contact jika ada contantnya
            function blockedContact(isBlock) {
                if (Inbox.DataRoomActive.ContactReal != null) {
                    let txt = "Block";
                    if (isBlock == 1) txt = "Unblock";

                    Q.confirm(
                        Q.text("Site.Inbox.ConfirmBlockContact").replace("{0}", txt),
                        async () => {
                            await connection.invoke(
                                "ContactBlockUnblock",
                                Inbox.DataRoomActive.Room.Id,
                                Inbox.DataRoomActive.Room.St,
                                Inbox.DataRoomActive.ContactReal.Id,
                                isBlock == 1 ? 0 : 1
                            );
                            Q.notifySuccess(txt + " success.");
                            isBlock = isBlock == 1 ? 0 : 1;
                            if (Inbox.DataRoomActive.Room.St == 4) {
                                if (isBlock == 1) {
                                    $("#unblockCtBtn").show();
                                    $("#blockCtBtn").hide();
                                    $(".isnonblocked").show();
                                    $(".isnonarchived").hide();
                                    $(
                                        `[data-act-ct-id="${Inbox.DataRoomActive.ContactReal.Id}"]`
                                    ).append(
                                        `<i data-block-id="block${Inbox.DataRoomActive.ContactReal.Id}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`
                                    );
                                } else {
                                    $("#unblockCtBtn").hide();
                                    $("#blockCtBtn").show();
                                    $(".isnonblocked").hide();
                                    $(".isnonarchived").show();
                                    $(
                                        `[data-block-id="block${Inbox.DataRoomActive.ContactReal.Id}"]`
                                    ).remove();
                                }
                            }
                        }
                    );
                }
            }
            $("#blockCtBtn").on("click", () => {
                blockedContact(0);
            });
            $("#unblockCtBtn").on("click", () => {
                blockedContact(1);
            });

            //buka dialog untuk filter conversation
            $("#filterroom").on("click", function () {
                let bukaOption = new Nobox.ChatroomsFIlterDialog();
                bukaOption.isAgent = Inbox.IsAgentView;
                bukaOption.callback = (res) => {
                    BuatListConversation(initialTab, "", res, "filter");
                };
                bukaOption.dialogOpen();
            });

            $("#addroom").on("click", function () {
                let dlg = new Nobox.ChatroomsDialog();
                dlg.dialogOpen();
            });
            $("#addroomAgent").on("click", function () {
                let dlg = new Nobox.ChatroomsDialog();
                dlg.dialogOpen();
            });
            $("#filterroomAgent").on("click", function () {
                let bukaOption = new Nobox.ChatroomsFIlterDialog();
                bukaOption.isAgent = Inbox.IsAgentView;
                bukaOption.callback = (res) => {
                    BuatListConversation(initialTab, "", res, "filter");
                };
                bukaOption.dialogOpen();
            });

            //get list message conversation
            function getMsg(parId, okk, messages) {
                if (okk == "pertama") {
                    let resMsg = messages;
                    $(".lds-spinner-chatmsg1").hide();
                    if (resMsg.length > 0 /* && Inbox.DataRoomActive.Agents.length > 0*/) {
                        resMsg.forEach(async function (e, k) {
                            Inbox.Function.TemplateElmMsg.showMsg(e)
                        });
                    }
                    if (resMsg.length < 9) {
                        Inbox.Data.SkipInitMsg = true;
                    }
                    Inbox.Data.SkipMsg = Inbox.Data.SkipMsg + resMsg.length;
                } else {
                    Q.serviceCall({
                        blockUI: false,
                        url: "/Services/Chat/Chatmessages/List",
                        request: {
                            Take: 20,
                            EqualityFilter: { RoomId: parId },
                            Sort: ["In DESC", "Type DESC"],
                            Skip: Inbox.Data.SkipMsg,
                        },
                        onSuccess: (resMsg) => {
                            resMsg = resMsg.Entities;
                            $(".lds-spinner-chatmsg1").hide();
                            if (
                                resMsg.length > 0 /* && Inbox.DataRoomActive.Agents.length > 0*/
                            ) {
                                resMsg.forEach(async function (e, k) {
                                    Inbox.Function.TemplateElmMsg.showMsg(e, false, false, "#chat-container", true)
                                });
                            }
                            if (resMsg.length < 21) {
                                Inbox.Data.SkipInitMsg = true;
                            }
                            Inbox.Data.SkipMsg = Inbox.Data.SkipMsg + resMsg.length;
                        },
                    });
                }
            }

            //get list message conversdation history
            function getMsgHistory(parId, okk) {
                Q.serviceCall({
                    blockUI: false,
                    url: "/Services/Chat/Chatmessages/List",
                    request: {
                        Take: 20,
                        EqualityFilter: { RoomId: parId },
                        Sort: ["In DESC"],
                        Skip: Inbox.Data.SkipMsgHistory,
                    },
                    onSuccess: (resMsg) => {
                        resMsg = resMsg.Entities;
                        $(".lds-spinner-chatmsghistory").hide();
                        if (resMsg.length > 0 && Inbox.DataRoomActive.Agents.length > 0) {
                            resMsg.forEach(function (e, k) {
                                Inbox.Function.TemplateElmMsg.showMsg(e, false, false, "#chat-history-cnt", true, false);
                                //createChatMessage(e, "#chat-history-cnt", window.NmCt, "", okk);
                            });
                        }
                        if (resMsg.length < 9) {
                            Inbox.Data.SkipInitMsgHistory = true;
                        }
                        Inbox.Data.SkipMsgHistory = Inbox.Data.SkipMsgHistory + resMsg.length;
                    },
                });
            }

            //ke pesan paling bawah
            $(".GoBot").on("click", function () {
                $(this).hide();
                //gotoBottom();
            });

            //button navigasi ke pesan paling bawah
            function floatBtn(angka) {
                if (parseInt($("#chat-container")[0].scrollHeight) - parseInt($("#chatBox").scrollTop()) + 5 <= parseInt($("#chatBox").outerHeight())) {
                    $(".GoBot").hide();
                } else {
                    $(".GoBot").show();
                    if (angka != undefined) {
                        $(".UnReadMsg").show();
                        $(".UnReadMsg").text("...");
                    } else {
                        $(".UnReadMsg").hide();
                        $(".UnReadMsg").text(0);
                    }
                }
            }

            //toggle menau kanan
            $(".chat-profile-toggle").on("click", function () {
                setTimeout(function () {
                    floatBtn();
                }, 100);
            });

            //evn pas detail conversation di scroll(pesan)
            $("#chatBox").on("scroll", function (e) {
                floatBtn();
                //if ($("#chatBox").scrollTop() <= ($("#chatBox")[0].scrollHeight * 0.15)) {
                if ($("#chatBox").scrollTop() == 0) {
                    //alert("Atas sendiri");
                    $(".lds-spinner-chatmsg1").show();
                    let checkMsg = setInterval(function () {
                        if (
                            Inbox.Data.SkipInitMsg == false &&
                            Inbox.IdRoomAktif == $(".nk-chat-body").attr("data-id") &&
                            lebih1Detik == true
                        ) {
                            if (Inbox.Data.IsArchived == false) {
                                getMsg(Inbox.IdRoomAktif, "Bawah");
                                clearInterval(checkMsg);
                            } else {
                                setTimeout(function () {
                                    $(".lds-spinner-chatmsg1").hide();
                                }, 400);
                            }
                        } else {
                            setTimeout(function () {
                                $(".lds-spinner-chatmsg1").hide();
                                Inbox.Data.SkipInitMsg = false;
                            }, 400);
                        }
                    }, 100);
                }
            });

            //evn pas detail conversation history di scroll
            $("#chat-history-cnt").scroll(function (e) {
                floatBtn();
                if ($("#chat-history-cnt").scrollTop() == 0) {
                    $(".lds-spinner-chatmsghistory").show();
                    if (Inbox.Data.SkipInitMsgHistory == false) {
                        getMsgHistory(Inbox.Data.IdRoomHistory, "Bawah");
                        $(".lds-spinner-chatmsghistory").hide();
                    } else {
                        setTimeout(function () {
                            $(".lds-spinner-chatmsghistory").hide();
                            Inbox.Data.SkipInitMsgHistory = false;
                        }, 400);
                    }
                }
            });
            let lebih1Detik = true;
            //let sedangKonek = false;

            Step = 23; //buat fungsi ketika klik conversation untuk membuka tampilan chatting
            let bolehRenderMsg = true;
            function showChat(id) {
                if (bolehRenderMsg) {
                    bolehRenderMsg = false;
                    $("#chat-container").html("");
                    $("#historyConversation").show();
                    //$(".lds-spinner-chatmsg1").show();
                    $("#chatnotselected").hide();
                    $("#chatloading").show();
                    $("#chatselected").hide();
                    $("#showWhenArchive").hide();
                    $("#previewReplyElm").hide();
                    Step = 25; //ketika conversation beda atau pertama kali buka --> set conversation yg aktif & leave conversation supaya tidak dapat message baru
                    $(".showChatClass").removeClass("current");

                    Step = 26; //tambahkan class current pada conversation yang diklik & tambahkan id conversation pada url & kosongi elemnt chat-container
                    $("#roomId" + id).addClass(" current");
                    if (Inbox.IsBack) {
                        window.history.pushState(null, null, "?RoomId=" + id);
                        Inbox.IsBack = false;
                    } else {
                        window.history.replaceState(null, null, "?RoomId=" + id);
                    }

                    Inbox.Data.IsArchived = false;
                    Inbox.Data.SkipMsg = 0;
                    Inbox.Data.SkipInitMsg = false;
                    //$("#archiveResolved").hide();
                    Step = 27; //ambil detail data pada conversation & set jumlah notif jadi 0
                    $('[data-read="read' + id + '"]')
                        .attr("data-count", 0)
                        .html(``);
                    Q.serviceCall({
                        blockUI: true,
                        url: "/Services/Chat/Chatrooms/DetailRoom",
                        request: {
                            EntityId: id,
                        },
                        onSuccess: async (response) => {
                            if (!response.IsError) {
                                if (response.Data.Room.IsLock == 1) {
                                    Q.alert(Q.text("Site.Billing.Inbox.UpgradeMAU"));
                                    bolehRenderMsg = true;
                                    $("#chatloading").hide()
                                    $("#chatnotselected").show()
                                } else {
                                    Step = 28; //jika tidak error
                                    Inbox.DataRoomActive = response.Data;

                                    Step = 29; //join conversation yang diklik
                                    await connection.invoke(
                                        "JoinConversation",
                                        `${Inbox.DataRoomActive.Room.Id}`,
                                        `${Inbox.IdRoomAktif}`
                                    );
                                    Inbox.IdRoomAktif = id;
                                    Inbox.ListMessages = [];

                                    //mute bot
                                    if (Inbox.DataRoomActive.Room.IsMuteBot == 1) {
                                        $("#elmMuteBot").prop("checked", true);
                                    } else {
                                        $("#elmMuteBot").prop("checked", false);
                                    }

                                    //need reply
                                    if (Inbox.DataRoomActive.Room.IsNeedReply == 1) {
                                        $("#elmNeedReply").prop("checked", true);
                                    } else {
                                        $("#elmNeedReply").prop("checked", false);
                                    }

                                    Step = 30; //
                                    let isresolvedbtn = "block";
                                    $(".nk-chat-head-tools").show();
                                    let locSto = localStorage.getItem("RightMenu");
                                    if (locSto == "Shown") {
                                        $("#panelkananch").removeClass(" visible");
                                        $("#panelkanandetail").removeClass(" visible");
                                        $("#panelkanan").addClass(" visible");
                                        $("#chatselected").addClass(" profile-shown");
                                    } else {
                                        $("#panelkananch").removeClass(" visible");
                                        $("#panelkanandetail").removeClass(" visible");
                                        $("#panelkanan").removeClass(" visible");
                                        $("#chatselected").removeClass(" profile-shown");
                                    }

                                    if (
                                        Inbox.DataRoomActive.Room.ChId == 1 ||
                                        Inbox.DataRoomActive.Room.ChId == 2 ||
                                        Inbox.DataRoomActive.Room.ChId == 1557
                                    ) {
                                        $("#vnContainer").show();
                                        $("#mapContainer").show();
                                        $("#fileContainer").show();
                                        if (Inbox.DataRoomActive.Room.ChId == 1557) {
                                            $("#contactContainer").show();
                                            $("#stickerContainer").show();
                                        } else {
                                            $("#contactContainer").hide();
                                            $("#stickerContainer").hide();
                                        }
                                        $("#inputVideoContainer").hide();
                                    } else {
                                        if (Inbox.DataRoomActive.Room.ChId == 1532) {
                                            $("#vnContainer").show();
                                            $("#mapContainer").show();
                                        } else {
                                            $("#vnContainer").hide();
                                            $("#mapContainer").hide();
                                        }
                                        if (Inbox.DataRoomActive.Room.ChId == 3) {
                                            $("#inputVideoContainer").show();
                                        } else {
                                            $("#inputVideoContainer").hide();
                                        }
                                        $("#contactContainer").hide();
                                        $("#stickerContainer").hide();
                                        $("#fileContainer").hide();
                                    }

                                    Step = 31; //Id Akun
                                    $(".nk-chat-body").attr(
                                        "data-user-from",
                                        Inbox.DataRoomActive.Room.ChAccId
                                    );
                                    //Id Link
                                    $(".nk-chat-body").attr(
                                        "data-user-to",
                                        Inbox.DataRoomActive.Room.CtId
                                    );
                                    $(".nk-chat-body").attr("data-ag-id", Inbox.Info.currentUser().UserId);
                                    $(".nk-chat-body").attr("data-ag-nm", Inbox.Info.currentUser().DisplayName);
                                    $(".nk-chat-body").attr("data-ag-img", Inbox.Info.currentUser().UserImage);
                                    $(".nk-chat-body")
                                        .addClass("show-chat")
                                        .attr("data-id", Inbox.DataRoomActive.Room.Id);

                                    Step = 32; //Resolved
                                    $("#resolvedBTN").attr(
                                        "data-resolved",
                                        Inbox.DataRoomActive.Room.Id
                                    );
                                    $("#RnABtn").attr(
                                        "data-rna",
                                        Inbox.DataRoomActive.Room.Id
                                    );
                                    $("#archiveBTN").attr(
                                        "data-archive",
                                        Inbox.DataRoomActive.Room.Id
                                    );

                                    //Menu Tengah
                                    $(".nk-chat-aside").addClass("hide-aside");

                                    Step = 33; //Menu Samping
                                    $("#namauser").text(
                                        Inbox.DataRoomActive.Room.IsGrp == 1
                                            ? Inbox.DataRoomActive.Room.Grp
                                            : Inbox.DataRoomActive.Room.CtRealNm == null
                                                ? Inbox.DataRoomActive.Room.Ct
                                                : Inbox.DataRoomActive.Room.CtRealNm
                                    );
                                    if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                                        $("#profiluser").attr(
                                            "style",
                                            "background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;cursor: pointer;"
                                        );
                                        $("#profiluser").attr("data-img", "/Inbox/img/users.jpeg");
                                        $("elmMuteBot").hide()
                                        $("elmNeedReply").hide()
                                    } else {
                                        if (!Q.isEmptyOrNull(Inbox.DataRoomActive.Room.CtImg)) {
                                            $("#profiluser").attr(
                                                "style",
                                                "background-image: url('" +
                                                (isValidUrl(Inbox.DataRoomActive.Room.CtImg) ? Inbox.DataRoomActive.Room.CtImg : "/Inbox/img/user.jpeg") +
                                                "');background-size: cover;background-position: center;cursor: pointer;"
                                            );
                                            $("#profiluser").attr(
                                                "data-img",
                                                isValidUrl(Inbox.DataRoomActive.Room.CtImg) ? Inbox.DataRoomActive.Room.CtImg : "/Inbox/img/user.jpeg"
                                            );
                                        } else if (
                                            !Q.isEmptyOrNull(Inbox.DataRoomActive.Room.LinkImg)
                                        ) {
                                            $("#profiluser").attr(
                                                "style",
                                                "background-image: url('" +
                                                (isValidUrl(Inbox.DataRoomActive.Room.LinkImg) ? Inbox.DataRoomActive.Room.LinkImg : "/Inbox/img/user.jpeg") +
                                                "');background-size: cover;background-position: center;cursor: pointer;"
                                            );
                                            $("#profiluser").attr(
                                                "data-img",
                                                isValidUrl(Inbox.DataRoomActive.Room.LinkImg) ? Inbox.DataRoomActive.Room.LinkImg : "/Inbox/img/user.jpeg"
                                            );
                                        } else {
                                            $("#profiluser").attr(
                                                "style",
                                                "background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;cursor: pointer;"
                                            );
                                            $("#profiluser").attr("data-img", "/Inbox/img/user.jpeg");
                                        }
                                        $("elmMuteBot").show()
                                        $("elmNeedReply").show()
                                    }

                                    Step = 34; //isPin
                                    if (Inbox.DataRoomActive.Room.IsPin == 2) {
                                        $("#pinBTN").html(
                                            `<a data-pin="2" class="PinnedRoom lkdropdown-item disabledLink" href="#"><span>Unpin</span></a>`
                                        );
                                    } else {
                                        $("#pinBTN").html(
                                            `<a data-pin="1" class="PinnedRoom lkdropdown-item disabledLink" href="#"><span>Pin</span></a>`
                                        );
                                    }
                                    Step = 35; //isBlock
                                    if (Inbox.DataRoomActive.Room.CtIsBlock == 1) {
                                        $("#blockBTN").html(
                                            `<a data-block="2" class="BlockedRoom lkdropdown-item disabledLink" href="#"><span>Unblock</span></a>`
                                        );
                                        $(".isblockedandisresolved").hide();
                                        $(".isblocked").hide();
                                        $(".isnonblocked").show();
                                        $(".isnonresolved").hide();
                                        $(".isnonarchived").hide();
                                        $("#unblockCtBtn").show();
                                        $("#blockCtBtn").hide();
                                    } else {
                                        $("#blockBTN").html(
                                            `<a data-block="1" class="BlockedRoom lkdropdown-item disabledLink" href="#"><span>Block</span></a>`
                                        );
                                        $(".isblockedandisresolved").show();
                                        $(".isblocked").show();
                                        $(".isnonblocked").hide();
                                        $(".isnonarchived").hide();
                                        $(".isnonresolved").show();
                                        $("#unblockCtBtn").hide();
                                        $("#blockCtBtn").show();
                                    }
                                    Step = 36; //isResolved
                                    if (Inbox.DataRoomActive.Room.St == 3) {
                                        $("#funnelskanan").prop("disabled", true);
                                        $("#tagskanan").prop("disabled", true);
                                        if (Inbox.DataRoomActive.Room.CtIsBlock == 1) {
                                            $(".isnonresolved").hide();
                                            $(".isnonblocked").show();
                                        } else {
                                            $(".isnonresolved").show();
                                            $(".isnonblocked").hide();
                                        }
                                        $(".isresolvedtool").hide();
                                        $(".isblockedandisresolved").hide();
                                        $("#btnaddtags").hide();
                                        $("#archiveResolved").show();
                                        $("#btnaddfunnels").hide();
                                        $(".isnonarchived").hide();
                                        $(".isexpired").hide();
                                        $("#showWhenArchiveAndResolved").show();
                                        isresolvedbtn = "none";
                                        $("#CTemplateElm").hide();
                                    }
                                    else {
                                        if (
                                            Inbox.DataRoomActive.Room.St == 3 ||
                                            Inbox.DataRoomActive.Room.CtIsBlock == 1
                                        ) {
                                            $(".isblockedandisresolved").hide();
                                            $(".isresolvedtool").hide();
                                        } else {
                                            $(".isblockedandisresolved").show();
                                            $(".isresolvedtool").show();
                                        }
                                        $("#btnaddtags").show();
                                        $("#btnaddfunnels").show();
                                        $("#funnelskanan").prop("disabled", false);
                                        $("#tagskanan").prop("disabled", false);
                                        $(".isnonresolved").hide();
                                        $(".isnonarchived").hide();
                                        $("#archiveResolved").hide();
                                        $("#showWhenArchiveAndResolved").hide();
                                        isresolvedbtn = "block";

                                        if (Inbox.DataRoomActive.Room.Sess == 2) {
                                            $("#CTemplateElm").show();
                                            $("#editorChat").hide();
                                        } else {
                                            $("#CTemplateElm").hide();
                                        }
                                    }

                                    Step = 37;
                                    $('input#checkResolve[type="checkbox"][name="resolve"]').prop(
                                        "checked",
                                        Inbox.DataRoomActive.Room.IsAutoResolve == 1 ? true : false
                                    );
                                    if (
                                        Inbox.DataRoomActive.Room.St == 2 &&
                                        Inbox.DataRoomActive.SettingTenant.Resolve == 1
                                    ) {
                                        $("#DoNotresolvedBTN").show();
                                        $(".DoNotresolvedBTN").text(Q.text("Site.Inbox.AResolved"));
                                    } else {
                                        $("#DoNotresolvedBTN").hide();
                                        $(".DoNotresolvedBTN").text("");
                                    }
                                    $('input#checkArchive[type="checkbox"][name="archive"]').prop(
                                        "checked",
                                        Inbox.DataRoomActive.Room.IsAutoArchive == 1 ? true : false
                                    );
                                    if (
                                        Inbox.DataRoomActive.Room.St == 3 &&
                                        Inbox.DataRoomActive.SettingTenant.Archive == 1
                                    ) {
                                        $("#DoNotarchivedBTN").show();
                                        $(".DoNotarchivedBTN").text(Q.text("Site.Inbox.AArchived"));
                                    } else {
                                        $("#DoNotarchivedBTN").hide();
                                        $(".DoNotarchivedBTN").text("");
                                    }

                                    Step = 38; //Channel
                                    $("#channeluser").html(Inbox.Function.renderChannelInDetailConversation());

                                    Step = 39; //Info Room
                                    $("#accRoom").text(Inbox.DataRoomActive.Room.ChAcc);
                                    $("#accRoom").attr(
                                        "data-id-account",
                                        Inbox.DataRoomActive.Room.ChAccId
                                    );

                                    Step = 40;
                                    $("#accIdExtRoom").text(Inbox.DataRoomActive.Account.IdExt);
                                    $("#lsRoom").text(
                                        getCookie(Inbox.DataRoomActive.Room.Up, "timezone", "Time")
                                    );
                                    $("#creRoom").text(
                                        getCookie(Inbox.DataRoomActive.Room.In, "timezone", "Time")
                                    );

                                    Step = 41; //Note
                                    Inbox.DataRoomActive.Notes = Inbox.DataRoomActive.Notes;
                                    if (Inbox.DataRoomActive.Notes.length > 0) {
                                        $("#notesarr").addClass("mt-1");
                                        document.getElementById("notesarr").innerHTML =
                                            Inbox.DataRoomActive.Notes.map(function (e) {
                                                return (
                                                    '<div class="row pb-1 pt-1" style="margin-top:-10px;">' +
                                                    '<div class="text col-9 pl-3">' +
                                                    e.Cnt +
                                                    "</div>" +
                                                    '<i class="fa fa-edit mt-1 col-1 isresolvedtool editnote" style="right:0;cursor:pointer;display:' +
                                                    isresolvedbtn +
                                                    ';" data-note="' +
                                                    e.Id +
                                                    '"></i>' +
                                                    '<i class="fa fa-trash text-danger mt-1 col-1 isresolvedtool deletenote" style="right:0;cursor:pointer;display:' +
                                                    isresolvedbtn +
                                                    ';" data-note="' +
                                                    e.Id +
                                                    '"></i>' +
                                                    "</div>"
                                                );
                                            }).join("\n");
                                        $(".editnote").unbind("click");
                                        $(".editnote").on("click", function () {
                                            let dlg = new Nobox.ChatnotesDialog();
                                            dlg.userLogin = Inbox.Info.currentUser();
                                            dlg.ObjAccount = Inbox.DataRoomActive.Account;
                                            dlg.ObjLink = Inbox.DataRoomActive.Link;
                                            dlg.callback = async (data) => {
                                                try {
                                                    await connection.invoke(
                                                        "MkNote",
                                                        $(".nk-chat-body").attr("data-id"),
                                                        JSON.stringify(data)
                                                    );
                                                    Q.notifySuccess(Q.text("Site.Inbox.EditNote"));
                                                } catch (error) {
                                                    console.error(`MkNote Step = ${Step}, Msg = ${error}`);
                                                }
                                            };
                                            dlg.applyChangesButton.remove();
                                            dlg.loadByIdAndOpenDialog($(this).attr("data-note"));
                                        });
                                        $(".deletenote").unbind("click");
                                        $(".deletenote").on("click", function () {
                                            Q.confirm(
                                                Q.text("Site.Inbox.ConfirmDelNote"),
                                                () => {
                                                    Q.serviceCall({
                                                        blockUI: false,
                                                        url: "/Services/Chat/Chatnotes/Delete",
                                                        request: {
                                                            EntityId: $(this).attr("data-note"),
                                                        },
                                                        onSuccess: async (resNote) => {
                                                            try {
                                                                let objNote = {
                                                                    Id: $(this).attr("data-note"),
                                                                    Mode: "Delete",
                                                                };
                                                                await connection.invoke(
                                                                    "MkNote",
                                                                    $(".nk-chat-body").attr("data-id"),
                                                                    JSON.stringify(objNote)
                                                                );
                                                                Q.notifySuccess(Q.text("Site.Inbox.DelNote"));
                                                            } catch (error) {
                                                                console.error(
                                                                    `MkNote Step = ${Step}, Msg = ${error}`
                                                                );
                                                            }
                                                        },
                                                    });
                                                },
                                                {
                                                    // onNo: () => {
                                                    //     Q.notifyInfo("Delete Failed.");
                                                    // },
                                                    // title: "Delete note"
                                                }
                                            );
                                        });
                                    }
                                    else {
                                        $("#notesarr").removeClass("mt-1");
                                        $("#notesarr").html(
                                            `<span class='text-danger' onclick="$('#addnote').click()" style="cursor: pointer;">${Q.text(
                                                "Site.Inbox.NotSet"
                                            )}</span>`
                                        );
                                    }

                                    Step = 41; //Contact Information
                                    if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                                        $(".contactfound").hide();
                                        $(".contactnotfound").hide();
                                        $("#menuGrup").html(`
                                <label class="pl-3 pt-1 mb-0" style="font-weight: bolder;">
                                    Group
                                </label>
                                <div class="row pt-1 pl-3 pr-3">
                                    <b class="col-4" style="font-weight:500;">Name</b>
                                    <div class="col-8 text-primary" style="cursor:pointer;" id="grpRoom" title="${Q.text("Site.Inbox.ViewGroup")}">${Inbox.DataRoomActive.Group.Name
                                            }</div>
                                </div>
                                <div class="row pt-1 pl-3 pr-3">
                                    <b class="col-4" style="font-weight:500;">Description</b>
                                    <div class="col-8">${!Q.isEmptyOrNull(
                                                Inbox.DataRoomActive.Group.Desc
                                            )
                                                ? Inbox.DataRoomActive.Group.Desc
                                                : "-"
                                            }</div>
                                </div>`);
                                        $("#menuGrup").show();
                                        $("#grpRoom").unbind("click");
                                        $("#grpRoom").on("click", function () {
                                            let dlg = new Nobox.Nobox.GroupDialog();
                                            dlg.isReadonly = true;
                                            dlg.loadByIdAndOpenDialog(Inbox.DataRoomActive.Group.Id);
                                        });
                                    } else {
                                        $("#menuGrup").hide();
                                        if (Inbox.DataRoomActive.ContactReal != null) {
                                            $(".contactfound").show();
                                            $(".contactnotfound").hide();
                                            let nm = ``,
                                                pri = ``,
                                                eml = ``,
                                                adrs = ``,
                                                cmp = ``,
                                                zcode = ``;
                                            if (Inbox.DataRoomActive.ContactReal.Name) {
                                                nm = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Name")}</b>
                                                                    <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewContact")}" style="cursor:pointer;" id="MkCtName" data-id-ct="${Inbox.DataRoomActive.ContactReal.Id}">${Inbox.DataRoomActive.ContactReal.Name}</div>
                                                                </div>`;
                                            }
                                            if (Inbox.DataRoomActive.ContactReal.Country) {
                                                pri = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Country")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Country}</div>
                                                                </div>`;
                                            }
                                            if (Inbox.DataRoomActive.ContactReal.State) {
                                                eml = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.State")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.State}</div>
                                                                </div>`;
                                            }
                                            if (Inbox.DataRoomActive.ContactReal.City) {
                                                cmp = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.City")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.City}</div>
                                                                </div>`;
                                            }
                                            if (Inbox.DataRoomActive.ContactReal.Address) {
                                                adrs = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Address")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Address}</div>
                                                                </div>`;
                                            }
                                            if (Inbox.DataRoomActive.ContactReal.Postal) {
                                                zcode = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Postal")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Postal}</div>
                                                                </div>`;
                                            }
                                            $("#profinfo").html(nm + pri + eml + cmp + adrs + zcode);
                                            $("#MkCtName").unbind("click");
                                            $("#MkCtName").on("click", function () {
                                                let dlg = new Nobox.Nobox.LeadDialog();
                                                dlg.isReadonly = true;
                                                dlg.loadByIdAndOpenDialog($(this).attr("data-id-ct"));
                                            });
                                        } else {
                                            $(".contactfound").hide();
                                            $(".contactnotfound").show();
                                        }
                                    }

                                    Step = 42; //Profile Information
                                    $("#upProf").attr("data-ct-id", Inbox.DataRoomActive.Room.CtId);
                                    $("#upProf").attr(
                                        "data-ctreal-id",
                                        Inbox.DataRoomActive.Room.CtRealId
                                    );
                                    $("#upProf").attr(
                                        "data-ch-id",
                                        Inbox.DataRoomActive.Account.Channel
                                    );
                                    $("#upProf").attr(
                                        "data-ct-nm",
                                        Inbox.DataRoomActive.Room.CtRealNm == null
                                            ? Inbox.DataRoomActive.Room.Ct
                                            : Inbox.DataRoomActive.Room.CtRealNm
                                    );

                                    Step = 43; //Tags
                                    Inbox.Data.TagCanChange = false;
                                    if (Inbox.DataRoomActive.Tags == null) {
                                        $("#tagskanan").val(null).trigger("change");
                                    } else {
                                        let arrTags = [];
                                        Inbox.DataRoomActive.Tags.forEach(function (e, u) {
                                            arrTags.push(e.Id);
                                        });
                                        $("#tagskanan").val(arrTags).trigger("change");
                                    }

                                    Step = 44; //Funnels
                                    Inbox.Data.FunnelCanChange = false;
                                    $("#funnelskanan")
                                        .val(Inbox.DataRoomActive.Room.FnId)
                                        .trigger("change");

                                    Step = 45; //Agents
                                    Inbox.DataRoomActive.Agents = [];
                                    Inbox.DataRoomActive.RoomAgents.forEach((a) => {
                                        Inbox.DataRoomActive.Agents.push({
                                            Id: a.Id,
                                            UserId: a.UserId,
                                            DisplayName: a.DisplayName,
                                            UserImage: a.UserImage,
                                            //RoomId: a.RoomId
                                        });
                                    });

                                    Step = 46;
                                    $("#agentname").text(
                                        Inbox.DataRoomActive.RoomAgents.length + ` ${Q.text("Site.Inbox.Agent")}`
                                    );
                                    if (Inbox.DataRoomActive.RoomAgents.length) {
                                        $("#agentSelected").addClass("mt-2");
                                        $("#agentSelected").html(
                                            Inbox.DataRoomActive.RoomAgents.map(function (element) {
                                                let img = "",
                                                    btnDelAg = "";
                                                if (element.UserImage) {
                                                    img = `style="background-image: url(${Q.resolveUrl(
                                                        "~/upload/" + element.UserImage
                                                    )});background-size: cover;background-position: center;"`;
                                                } else {
                                                    img = `style="background-image: url(/Inbox/img/agent.png);background-size: cover;background-position: center;"`;
                                                }
                                                if (
                                                    Inbox.IsAgentView === false ||
                                                    Inbox.Info.currentUser().UserId == element.UserId
                                                ) {
                                                    btnDelAg =
                                                        '<div class="user-panel isresolvedtool" style="display:' +
                                                        isresolvedbtn +
                                                        ';">' +
                                                        '<i  data-id-ag="' +
                                                        element.Id +
                                                        '" data-id-user="' +
                                                        element.UserId +
                                                        '" data-nm-ag="' +
                                                        element.DisplayName +
                                                        '" class="DeleteAgent fa fa-close text-danger" style="cursor:pointer;"></i>' +
                                                        "</div>";
                                                }
                                                return (
                                                    '<div class="user-lkcard mb-1">' +
                                                    '<div class="user-lkavatar bg-transparent" ' +
                                                    img +
                                                    ">" +
                                                    "</div>" +
                                                    '<div class="col-9 pl-0 ml-2 user-info">' +
                                                    '<span class="lead-text">' +
                                                    element.DisplayName +
                                                    "</span>" +
                                                    "</div>" +
                                                    btnDelAg +
                                                    "</div>"
                                                );
                                            }).join("\n")
                                        );
                                        $(".DeleteAgent").on("click", function () {
                                            deleteAgent(
                                                $(this).attr("data-id-ag"),
                                                $(this).attr("data-id-user"),
                                                $(this).attr("data-nm-ag")
                                            );
                                        });
                                    }
                                    else {
                                        $("#agentSelected").removeClass("mt-2");
                                        $("#agentSelected").html(
                                            `<div class="text-danger" id="NSAgents" style="cursor: pointer;">${Q.text("Site.Inbox.NotSet")}</div>`
                                        );
                                        $("#NSAgents").on("click", function (e) {
                                            e.stopPropagation();
                                            $("#addAgents").lkdropdown("toggle");
                                            setTimeout(() => {
                                                $("#cariagent").focus();
                                            }, 100);
                                        });
                                    }
                                    Step = 47; //Messages
                                    $("#chatloading").hide();
                                    $("#chatselected").show();
                                    //$(".lds-spinner-chatmsg1").hide();
                                    if (!Q.isEmptyOrNull(Inbox.DataRoomActive.Room.CtId)) {
                                        if (
                                            Inbox.DataRoomActive.Room.CtId.toString() ==
                                            $(".nk-chat-body").attr("data-user-to")
                                        ) {
                                            getMsg(Inbox.IdRoomAktif, "pertama", response.Data.Messages);
                                            Inbox.Data.SkipInitMsg = true;
                                            lebih1Detik = true;
                                        }
                                    } else {
                                        getMsg(Inbox.IdRoomAktif, "pertama", response.Data.Messages);
                                        Inbox.Data.SkipInitMsg = true;
                                        lebih1Detik = true;
                                    }

                                    Step = 48; //Filter agent to assigned
                                    $("#listAgent").html("");
                                    Inbox.DataRoomActive.SelectAgents.forEach((a, u) => {
                                        let warna = "bg-success",
                                            eml = '</span><p class="text-primary fs-11 mb-0">' +
                                                a.JmlConversation +
                                                " " +
                                                Q.text("Site.Inbox.Conversations") +
                                                "</p>";

                                        if (a.Online == "Offline") {
                                            warna = "bg-secondary";
                                        }
                                        $("#listAgent").append(
                                            '<li data-id-agent="' +
                                            a.UserId +
                                            '" data-nm-agent="' +
                                            a.DisplayName +
                                            '" data-img-agent="' +
                                            a.UserImage +
                                            '" class="AddAgent border-bottom disabledLink"><a class="lkdropdown-item"><div class="d-flex"><div class="onlineIndikator ' +
                                            warna +
                                            ' mt-1"></div> <div class="ml-2"><p class="mb-0 text-black text-bold">' +
                                            a.DisplayName +
                                            "</p> " +
                                            eml +
                                            "</div></div></a></li>"
                                        );
                                        if (u == Inbox.DataRoomActive.SelectAgents.length - 1) {
                                            $(".AddAgent").unbind("click");
                                            $(".AddAgent").on("click", function () {
                                                addagent(
                                                    $(this).attr("data-id-agent"),
                                                    $(this).attr("data-nm-agent"),
                                                    $(this).attr("data-img-agent")
                                                );
                                            });
                                        }
                                    });

                                    Step = 49; //Campaign
                                    if (Inbox.DataRoomActive.Campaign == null) {
                                        $("#campaignF").hide();
                                        $("#campaignNF").show();
                                    }
                                    else {
                                        $("#campaignF").show();
                                        $("#campaignNF").hide();
                                        let elm = ``;
                                        if (Inbox.DataRoomActive.Campaign.Name) {
                                            elm = elm + `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkCampaignName" data-id-campaign="${Inbox.DataRoomActive.Campaign.Id}">${Inbox.DataRoomActive.Campaign.Name}</div>
                                            </div>`;
                                        }
                                        if (Inbox.DataRoomActive.Campaign.Status) {
                                            let stCampaign = `<span class="lkbadge lkbadge-danger lkbadge-dim">CANCEL</span>`;
                                            if (Inbox.DataRoomActive.Campaign.Status == 1) {
                                                stCampaign = `<span class="lkbadge lkbadge-secondary lkbadge-dim">DRAFT</span>`;
                                            } else if (Inbox.DataRoomActive.Campaign.Status == 2) {
                                                stCampaign = `<span class="lkbadge lkbadge-warning  lkbadge-dim">PROCESS</span>`;
                                            } else if (Inbox.DataRoomActive.Campaign.Status == 3) {
                                                stCampaign = `<span class="lkbadge lkbadge-success  lkbadge-dim">DONE</span>`;
                                            }
                                            elm = elm + `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Status</b>
                                                <div class="col-8">${stCampaign}</div>
                                            </div>`;
                                        }
                                        $("#campaignF").html(elm);
                                        $("#MkCampaignName").unbind("click");
                                        $("#MkCampaignName").on("click", function () {
                                            let dlg = new Nobox.Nobox.CampaignDialog();
                                            dlg.isReadonly = true;
                                            dlg.loadByIdAndOpenDialog($(this).attr("data-id-campaign"));
                                        });
                                    }
                                    if (Inbox.DataRoomActive.FormT == null) {
                                        $("#FormTemplateF").hide();
                                        $("#FormTemplateNF").show();
                                    } else {
                                        $("#FormTemplateF").show();
                                        $("#FormTemplateNF").hide();
                                        let elm = ``;
                                        if (Inbox.DataRoomActive.FormT.Name) {
                                            elm =
                                                elm +
                                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkFormTName" data-id="${Inbox.DataRoomActive.FormT.Id}">${Inbox.DataRoomActive.FormT.Name}</div>
                                            </div>`;
                                        }
                                        $("#FormTemplateF").html(elm);
                                        $("#MkFormTName").unbind("click");
                                        $("#MkFormTName").on("click", function () {
                                            let dlg = new Nobox.NoBoxCRM.FormDialog();
                                            dlg.isReadonly = true;
                                            dlg.loadByIdAndOpenDialog($(this).attr("data-id"));
                                        });
                                    }
                                    if (Inbox.DataRoomActive.FormR == null) {
                                        $("#FormResultF").hide();
                                        $("#FormResultNF").show();
                                    } else {
                                        $("#FormResultF").show();
                                        $("#FormResultNF").hide();
                                        let elm = ``;
                                        if (Inbox.DataRoomActive.FormR.SenderNm) {
                                            elm =
                                                elm +
                                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Sender Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkFormRName" data-id="${Inbox.DataRoomActive.FormR.Id}">${Inbox.DataRoomActive.FormR.SenderNm}</div>
                                            </div>`;
                                        }
                                        $("#FormResultF").html(elm);
                                        $("#MkFormRName").unbind("click");
                                        $("#MkFormRName").on("click", function () {
                                            let dlg = new Nobox.NoBoxCRM.FormresultsDialog();
                                            dlg.isReadonly = true;
                                            dlg.loadByIdAndOpenDialog($(this).attr("data-id"));
                                        });
                                    }

                                    Step = 50; //Deal
                                    if (Inbox.DataRoomActive.Deal == null) {
                                        $("#dealF").hide();
                                        $("#dealNF").show();
                                    } else {
                                        $("#dealF").show();
                                        $("#dealNF").hide();
                                        let elm = ``;
                                        if (Inbox.DataRoomActive.Deal.Name) {
                                            elm =
                                                elm +
                                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewDeal")}" style="cursor:pointer;" id="MkDealName" data-id-deal="${Inbox.DataRoomActive.Deal.Id}">${Inbox.DataRoomActive.Deal.Name}</div>
                                            </div>`;
                                        }
                                        if (Inbox.DataRoomActive.Deal.Pipeline) {
                                            elm =
                                                elm +
                                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Pipeline</b>
                                                <div class="col-8">${Inbox.DataRoomActive.Deal.Pipeline}</div>
                                            </div>`;
                                        }
                                        if (Inbox.DataRoomActive.Deal.Stage) {
                                            elm =
                                                elm +
                                                `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Stage</b>
                                                <div class="col-8">${Inbox.DataRoomActive.Deal.Stage}</div>
                                            </div>`;
                                        }

                                        $("#dealF").html(elm);
                                        $("#MkDealName").unbind("click");
                                        $("#MkDealName").on("click", function () {
                                            let dlg = new Nobox.CRM.DealsDialog();
                                            dlg.isReadonly = true;
                                            dlg.loadByIdAndOpenDialog($(this).attr("data-id-deal"));
                                        });
                                    }

                                    Step = 51; //Produk jika Olx
                                    if (Inbox.DataRoomActive.Link != null && Inbox.DataRoomActive.Link.ChId == 1532 && !Q.isEmptyOrNull(Inbox.DataRoomActive.Link.Extra)) {
                                        try {
                                            $("#menuProduct").show();
                                            let objProduct = JSON.parse(Inbox.DataRoomActive.Link.Extra);
                                            let elmProduct = ``;
                                            if (objProduct.name)
                                                elmProduct += `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-12" style="font-weight:700;">${objProduct.name}</b>
                                                                </div>`

                                            let elmProductCollapse = ``;
                                            if (objProduct.images.length > 0) {
                                                let dataImg = ``;
                                                objProduct.images.forEach((obj, ind) => {
                                                    dataImg += `<div class="carousel-item ${ind == 0 ? 'active' : null}" style="text-align: -webkit-center;">              
                                                                    <img src="${obj}" style="max-width:70px;border-radius:5px;" class="d-block w-100" alt="carousel">        
                                                                </div>`
                                                });
                                                elmProductCollapse += `<div id="carouselImgProduct" class="carousel slide pt-1 pl-3 pr-3" data-bs-ride="carousel">
                                                            
                                                            <div class="carousel-inner">
                                                                ${dataImg}     
                                                            </div>    
                                                            <a class="carousel-control-prev" href="#carouselImgProduct" role="button" data-bs-slide="prev">        
                                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>        
                                                                <span class="visually-hidden">Previous</span>    
                                                            </a>    
                                                            <a class="carousel-control-next" href="#carouselImgProduct" role="button" data-bs-slide="next">        
                                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>        
                                                                <span class="visually-hidden">Next</span>    
                                                            </a>
                                                    </div>`
                                            }
                                            if (objProduct.description)
                                                elmProductCollapse += `<div class="row pt-1 pl-3 pr-3">
                                                                    <div class="col-12" style="cursor:pointer;">${objProduct.description}</div>
                                                                </div>`
                                            if (objProduct.price)
                                                elmProductCollapse += `<div class="d-flex pt-1 pl-3 pr-3" style="gap: 5px;">
                                                                    <div><i class="fas fa-money-bill"></i></div>
                                                                    <div style="cursor:pointer;">${objProduct.price.value.display}</div>
                                                                </div>`
                                            if (objProduct.location)
                                                elmProductCollapse += `<div class="d-flex pt-1 pl-3 pr-3" style="gap: 5px;">
                                                                    <div><i class="fas fa-map-marker-alt"></i></div>
                                                                    <div style="cursor:pointer;">${objProduct.location}</div>
                                                                </div>`
                                            elmProduct += `
                                                      <div class="text-primary pl-3 pr-3" data-bs-toggle="collapse" href="#collapseProductOlx" role="button" aria-expanded="false" aria-controls="collapseProductOlx">
                                                        ${Q.text("Site.Deals.ShowMore")}
                                                      </div>
                                                    <div class="collapse py-1" id="collapseProductOlx">
                                                        ${elmProductCollapse}
                                                    </div>`;
                                            $("#menuProduct").html(``);
                                            $("#menuProduct").html(`
                                <label class="pl-3 pt-1 mb-0" style="font-weight: bolder;">
                                    Olx Product
                                </label>${elmProduct}
                                `);
                                        } catch (err) {
                                            $("#menuProduct").hide();
                                            $("#menuProduct").html("");
                                        }
                                    } else {
                                        $("#menuProduct").hide();
                                        $("#menuProduct").html("");
                                    }

                                    $(".BlockedRoom").unbind("click");
                                    $(".BlockedRoom").on("click", function () {
                                        blockedroom($(this).attr("data-block"));
                                    });
                                    $(".PinnedRoom").unbind("click");
                                    $(".PinnedRoom").on("click", function () {
                                        pinnedroom($(this).attr("data-pin"));
                                    });
                                    $("#archiveBTN").unbind("click");
                                    $("#archiveBTN").on("click", function () {
                                        MoveArchive($(this).attr("data-archive"));
                                    });
                                    $("#resolvedBTN").unbind("click");
                                    $("#resolvedBTN").on("click", function () {
                                        MarkResolved($(this).attr("data-resolved"));
                                    });
                                    $("#RnABtn").unbind("click");
                                    $("#RnABtn").on("click", function () {
                                        MarkResolvedAndArchived($(this).attr("data-rna"));
                                    });
                                    $("input#checkResolve").unbind("change");
                                    $("input#checkResolve").on("change", function () {
                                        Q.serviceCall({
                                            blockUI: false,
                                            url: "/Services/Chat/Chatrooms/Update",
                                            request: {
                                                EntityId: Inbox.DataRoomActive.Room.Id,
                                                Entity: {
                                                    IsAutoResolve: $(this).prop("checked") == false ? 0 : 1,
                                                },
                                            },
                                            onSuccess: (resSetting) => {
                                                $(this).prop("checked") == false
                                                    ? Q.notifySuccess(
                                                        Q.text("Site.Inbox.NotAutoResolved")
                                                    )
                                                    : Q.notifySuccess(
                                                        Q.text("Site.Inbox.AutoResolved")
                                                    );
                                            },
                                        });
                                    });
                                    $("input#checkArchive").unbind("change");
                                    $("input#checkArchive").on("change", function () {
                                        Q.serviceCall({
                                            blockUI: false,
                                            url: "/Services/Chat/Chatrooms/Update",
                                            request: {
                                                EntityId: Inbox.DataRoomActive.Room.Id,
                                                Entity: {
                                                    IsAutoArchive: $(this).prop("checked") == false ? 0 : 1,
                                                },
                                            },
                                            onSuccess: (resSetting) => {
                                                $(this).prop("checked") == false
                                                    ? Q.notifySuccess(
                                                        Q.text("Site.Inbox.NotAutoArchived")
                                                    )
                                                    : Q.notifySuccess(
                                                        Q.text("Site.Inbox.AutoArchived")
                                                    );
                                            },
                                        });
                                    });
                                    $("#cariagent").val("");
                                    $("#cariagent").unbind("input");
                                    //fungsi pencarian pada tambah agent supaya tidak melakukan request jadi menggunakan jquery
                                    $("#cariagent").on("input", function (e) {
                                        let txt = $(this).val();
                                        let jikaAda = false;
                                        $(".AddAgent").each(function (a) {
                                            if (
                                                $(this)
                                                    .attr("data-nm-agent")
                                                    .toUpperCase()
                                                    .indexOf(txt.toUpperCase()) != -1
                                            ) {
                                                $(this).show();
                                                jikaAda = true;
                                            } else {
                                                $(this).hide();
                                            }
                                        });
                                    });

                                    //klik pada akun menu kanan
                                    $("#accRoom").unbind("click");
                                    $("#accRoom").on("click", function () {
                                        let dlg = new Nobox.Nobox.AccountDialog();
                                        dlg.isReadonly = true;
                                        dlg.loadByIdAndOpenDialog($(this).attr("data-id-account"));
                                    });

                                    $("#emoji")[0].emojioneArea.setText("");
                                    let resTem = Inbox.Default.QuickReply;
                                    let arrTem = [];
                                    if (Inbox.DataRoomActive.Room.ChId != 1557)
                                        resTem = resTem.filter(t => t.Type == "1" || t.Type == null);

                                    resTem.forEach(function (u, i) {
                                        let content = u.Cnt;
                                        if (u.Type == "3" || u.Type == "2") {
                                            let objList = JSON.parse(u.Cnt);
                                            content = objList?.body?.text;
                                            if (content.length > 80) {
                                                content = content.substring(0, 79) + "..."
                                            }
                                        }
                                        else if (u.Cnt.length > 80) {
                                            content = u.Cnt.substring(0, 79) + "..."
                                        }
                                        let badge = `<span class="lkbadge lkbadge-dim lkbadge-warning">General</span>`;
                                        if (u.Type == "3") {
                                            badge = `<span class="lkbadge lkbadge-dim lkbadge-success">List</span>`;
                                        } else if (u.Type == "2") {
                                            badge = `<span class="lkbadge lkbadge-dim lkbadge-danger">Reply Button</span>`;
                                        }
                                        arrTem.push({
                                            name:
                                                `<b class="cmd">${u.Cmd}</b>
                                            <span hidden>[|-|]${u.Cnt}[|-|]${u.Id}[|-|]</span>  ${badge} (${u.Files ? JSON.parse(u.Files).length : "0"} files)<br><span>${content}</span>`,
                                            content: u.Cnt,
                                        });
                                        if (i == resTem.length - 1) {
                                            $("#emojiEditor1").atwho({
                                                at: "/",
                                                data: arrTem,
                                                callbacks: {
                                                    beforeInsert: function (value, $li, e) {
                                                        let index = resTem.findIndex(
                                                            (x) => x.Id == value.split("[|-|]")[2]
                                                        );
                                                        if (resTem[index].Type == "3") {
                                                            let dataMsg = {
                                                                Room: {
                                                                    IdLink: Inbox.DataRoomActive.Link == null ? null : Inbox.DataRoomActive.Link.Id,
                                                                    IdGroup: Inbox.DataRoomActive.Group == null ? null : Inbox.DataRoomActive.Group.Id,
                                                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                                                },
                                                                Msg: {
                                                                    Type: "19",
                                                                    Msg: resTem[index].Cnt,
                                                                    File: null,
                                                                    Files: null,
                                                                },
                                                            };

                                                            if (
                                                                Inbox.DataRoomActive.Agents.filter(
                                                                    (b) => b.UserId == Inbox.Info.currentUser().UserId
                                                                ).length < 1
                                                            ) {
                                                                InsertAgentYgLogin(dataMsg);
                                                            } else {
                                                                KirimPesan(
                                                                    JSON.stringify(dataMsg),
                                                                    `${Inbox.DataRoomActive.Room.Id}`
                                                                );
                                                            }
                                                            $("#emoji")[0].emojioneArea.setText("");
                                                        }
                                                        else if (resTem[index].Type == "2") {
                                                            let dataMsg = {
                                                                Room: {
                                                                    IdLink: Inbox.DataRoomActive.Link == null ? null : Inbox.DataRoomActive.Link.Id,
                                                                    IdGroup: Inbox.DataRoomActive.Group == null ? null : Inbox.DataRoomActive.Group.Id,
                                                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                                                },
                                                                Msg: {
                                                                    Type: "21",
                                                                    Msg: resTem[index].Cnt,
                                                                    File: null,
                                                                    Files: resTem[index].Files,
                                                                },
                                                            };

                                                            if (
                                                                Inbox.DataRoomActive.Agents.filter(
                                                                    (b) => b.UserId == Inbox.Info.currentUser().UserId
                                                                ).length < 1
                                                            ) {
                                                                InsertAgentYgLogin(dataMsg);
                                                            } else {
                                                                KirimPesan(
                                                                    JSON.stringify(dataMsg),
                                                                    `${Inbox.DataRoomActive.Room.Id}`
                                                                );
                                                            }
                                                            $("#emoji")[0].emojioneArea.setText("");
                                                        }
                                                        else {
                                                            if (resTem[index].Files) {
                                                                let initFile = [];
                                                                let files = JSON.parse(resTem[index].Files);
                                                                files.forEach(function (e) {
                                                                    if (e.Filename.includes(".png")) {
                                                                        initFile.push("img");
                                                                    } else if (e.Filename.includes(".PNG")) {
                                                                        initFile.push("img");
                                                                    } else if (e.Filename.includes(".jpg")) {
                                                                        initFile.push("img");
                                                                    } else if (e.Filename.includes(".JPG")) {
                                                                        initFile.push("img");
                                                                    } else if (e.Filename.includes(".jpeg")) {
                                                                        initFile.push("img");
                                                                    } else if (e.Filename.includes(".JPEG")) {
                                                                        initFile.push("img");
                                                                    } else {
                                                                        initFile.push("file");
                                                                    }
                                                                });
                                                                if (files.length > 0) {
                                                                    if (initFile.every((val, i, arr) => val === arr[0] && arr[0] == "img")) {
                                                                        FotoUpload(
                                                                            "QuickReply",
                                                                            resTem[index].Cnt,
                                                                            resTem[index].Files
                                                                        );
                                                                    } else {
                                                                        FileUpload(
                                                                            "QuickReply",
                                                                            resTem[index].Cnt,
                                                                            resTem[index].Files
                                                                        );
                                                                    }
                                                                } else {
                                                                    $("#emoji")[0].emojioneArea.setText(
                                                                        `${resTem[index].Cnt}`
                                                                    );
                                                                }
                                                            } else {
                                                                $("#emoji")[0].emojioneArea.setText(
                                                                    `${resTem[index].Cnt}`
                                                                );
                                                            }
                                                        }
                                                    },
                                                },
                                            });
                                        }
                                    });
                                    if ($("#emojiEditor1").is(':visible'))
                                        $("#emoji")[0].emojioneArea.setFocus();

                                    setTimeout(() => {
                                        bolehRenderMsg = true;
                                    }, 1000);
                                }
                            } else {
                                Q.alert(Q.text("Site.Inbox.ConversationNF"));
                                bolehRenderMsg = true;
                                $("#chatloading").hide()
                                $("#chatnotselected").show()
                            }
                        },
                    });
                }
                //}
            }

            //Tampilkan detail chat pada conversation yg diarchive
            function showChatAr(id) {
                Inbox.Data.IsArchived = true;
                Inbox.Data.SkipInitMsg = true;
                $("#chat-container").html("");
                $("#historyConversation").hide();
                //$(".lds-spinner-chatmsg1").show();
                $("#chatnotselected").hide();
                $("#chatloading").show();
                $("#chatselected").hide();
                $("#previewReplyElm").hide();
                $("elmMuteBot").hide()
                $("elmNeedReply").hide()
                if (!Q.isEmptyOrNull(Inbox.IdRoomAktif)) {
                    $("#roomArId" + Inbox.IdRoomAktif).removeClass(" current");
                }
                Inbox.IdRoomAktif = id;
                $("#roomArId" + id).addClass(" current");
                Q.serviceCall({
                    blockUI: false,
                    url: "/Services/Chat/Chatrooms/DetailArchived",
                    request: {
                        EntityId: id,
                    },
                    onSuccess: async (response) => {
                        //try {
                        await connection.invoke("LeaveConversation", Inbox.IdRoomAktif);
                        //window.history.replaceState(null, null, null);
                        Inbox.DataRoomActive = response.Data;
                        Inbox.ListMessages = [];
                        let res = response.Entity;

                        $(".nk-chat-aside").addClass(" hide-aside");
                        $(".nk-chat-body").addClass(" show-chat");
                        $("#chatnotselected").css("display", "none");
                        $("#chatloading").hide();
                        $("#chatselected").show();
                        $(".isresolvedtool").hide();
                        $("#archiveResolved").hide();
                        $("#showWhenArchive").show();
                        $("#CTemplateElm").hide();
                        $("#createRoomBTN").hide();
                        $("#restoreBTN").attr("data-restore", Inbox.DataRoomActive.Room.Id);
                        //$('.nk-chat-body').removeClass(' profile-shown')
                        //$('#panelkanan').removeClass(' visible')
                        //$('#panelkananch').removeClass(' visible')
                        //$('#panelkanandetail').removeClass(' visible')
                        $(".isblockedandisresolved").hide();
                        $(".isarchived").hide();
                        $(".content-hsm").hide();
                        if (Inbox.DataRoomActive.Room.CtIsBlock == 1) {
                            $(".isnonarchived").hide();
                            $(".isnonblocked").show();
                            $("#unblockCtBtn").show();
                            $("#blockCtBtn").hide();
                        } else {
                            $(".isnonarchived").show();
                            $(".isnonblocked").hide();
                            $("#unblockCtBtn").hide();
                            $("#blockCtBtn").show();
                        }
                        $("#showWhenArchiveAndResolved").show();

                        //Inisial Active Room
                        $("#chat-container").html("");

                        //Profile Information
                        $("#upProf").attr("data-ct-id", Inbox.DataRoomActive.Room.CtId);
                        $("#upProf").attr(
                            "data-ctreal-id",
                            Inbox.DataRoomActive.Room.CtRealId
                        );
                        $("#upProf").attr(
                            "data-ch-id",
                            Inbox.DataRoomActive.Account.Channel
                        );
                        $("#upProf").attr(
                            "data-ct-nm",
                            Inbox.DataRoomActive.Room.CtRealNm == null
                                ? Inbox.DataRoomActive.Room.Ct
                                : Inbox.DataRoomActive.Room.CtRealNm
                        );
                        $(".nk-chat-body").attr("data-ag-id", Inbox.Info.currentUser().UserId);
                        $(".nk-chat-body").attr("data-ag-nm", Inbox.Info.currentUser().DisplayName);
                        $(".nk-chat-body").attr("data-ag-img", Inbox.Info.currentUser().UserImage);
                        $(".nk-chat-body").attr("data-ag-img", Inbox.Info.currentUser().UserImage);

                        //Menu Samping (ini tidak ditampilkan hanya untuk menampung data dari kontak)
                        let NamaKontak =
                            Inbox.DataRoomActive.Room.IsGrp == 1
                                ? Inbox.DataRoomActive.Room.Grp
                                : Inbox.DataRoomActive.Room.CtRealNm == null
                                    ? Inbox.DataRoomActive.Room.Ct
                                    : Inbox.DataRoomActive.Room.CtRealNm;

                        $("#namauser").text(NamaKontak);
                        if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                            $("#profiluser").attr(
                                "style",
                                "background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;cursor: pointer;"
                            );
                            $("#profiluser").attr("data-img", "/Inbox/img/users.jpeg");
                        } else {
                            if (!Q.isEmptyOrNull(Inbox.DataRoomActive.Room.CtImg)) {
                                $("#profiluser").attr(
                                    "style",
                                    "background-image: url('" +
                                    Inbox.DataRoomActive.Room.CtImg +
                                    "');background-size: cover;background-position: center;cursor: pointer;"
                                );
                                $("#profiluser").attr(
                                    "data-img",
                                    Inbox.DataRoomActive.Room.CtImg
                                );
                            } else if (!Q.isEmptyOrNull(Inbox.DataRoomActive.Room.LinkImg)) {
                                $("#profiluser").attr(
                                    "style",
                                    "background-image: url('" +
                                    Inbox.DataRoomActive.Room.LinkImg +
                                    "');background-size: cover;background-position: center;cursor: pointer;"
                                );
                                $("#profiluser").attr(
                                    "data-img",
                                    Inbox.DataRoomActive.Room.LinkImg
                                );
                            } else {
                                $("#profiluser").attr(
                                    "style",
                                    "background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;cursor: pointer;"
                                );
                                $("#profiluser").attr("data-img", "/Inbox/img/user.jpeg");
                            }
                        }

                        //Id User From
                        $(".nk-chat-body").attr(
                            "data-user-from",
                            Inbox.DataRoomActive.Room.From
                        );
                        //Id User To
                        $(".nk-chat-body").attr(
                            "data-user-to",
                            Inbox.DataRoomActive.Room.To
                        );

                        Step = 38; //Channel

                        $("#channeluser").html(Inbox.Function.renderChannelInDetailConversation());

                        Step = 39; //Info Room
                        $("#accRoom").text(Inbox.DataRoomActive.Account.Name);
                        $("#accRoom").attr(
                            "data-id-account",
                            Inbox.DataRoomActive.Account.Id
                        );

                        Step = 40;
                        //$("#accIdExtRoom").text(ObjAccount.IdExt)
                        $("#lsRoom").text(
                            getCookie(Inbox.DataRoomActive.Room.Up, "timezone", "Time")
                        );
                        $("#creRoom").text(
                            getCookie(Inbox.DataRoomActive.Room.In, "timezone", "Time")
                        );

                        Step = 41; //Note
                        Inbox.DataRoomActive.Notes = Inbox.DataRoomActive.Notes;
                        if (Inbox.DataRoomActive.Notes.length > 0) {
                            $("#notesarr").addClass("mt-1");
                            document.getElementById("notesarr").innerHTML =
                                Inbox.DataRoomActive.Notes.map(function (e) {
                                    return (
                                        '<div class="row pb-1 pt-1" style="margin-top:-10px;">' +
                                        '<div class="text col-9 pl-3">' +
                                        e.Cnt +
                                        "</div></div>"
                                    );
                                }).join("\n");
                        } else {
                            $("#notesarr").removeClass("mt-1");
                            $("#notesarr").html(
                                `<span class='text-danger' onclick="$('#addnote').click()" style="cursor: pointer;">${Q.text("Site.Inbox.NotSet")}</span>`
                            );
                        }

                        Step = 41; //Contact Information
                        if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                            $(".contactfound").hide();
                            $(".contactnotfound").hide();
                            $("#menuGrup").html(`
                                <label class="pl-3 pt-1 mb-0" style="font-weight: bolder;">
                                    Group
                                </label>
                                <div class="row pt-1 pl-3 pr-3">
                                    <b class="col-4" style="font-weight:500;">Name</b>
                                    <div class="col-8 text-primary" style="cursor:pointer;" id="grpRoom" title="${Q.text("Site.Inbox.ViewGroup")}">${Inbox.DataRoomActive.Group.Name
                                }</div>
                                </div>
                                <div class="row pt-1 pl-3 pr-3">
                                    <b class="col-4" style="font-weight:500;">Description</b>
                                    <div class="col-8">${!Q.isEmptyOrNull(
                                    Inbox.DataRoomActive.Group.Desc
                                )
                                    ? Inbox.DataRoomActive.Group.Desc
                                    : "-"
                                }</div>
                                </div>`);
                            $("#menuGrup").show();
                            $("#grpRoom").unbind("click");
                            $("#grpRoom").on("click", function () {
                                let dlg = new Nobox.Nobox.GroupDialog();
                                dlg.isReadonly = true;
                                dlg.loadByIdAndOpenDialog(Inbox.DataRoomActive.Group.Id);
                            });
                        } else {
                            $("#menuGrup").hide();
                            if (Inbox.DataRoomActive.ContactReal != null) {
                                $(".contactfound").show();
                                $(".contactnotfound").hide();
                                let nm = ``,
                                    pri = ``,
                                    eml = ``,
                                    adrs = ``,
                                    cmp = ``,
                                    zcode = ``;
                                if (Inbox.DataRoomActive.ContactReal.Name) {
                                    nm = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Name")}</b>
                                                                    <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewContact")}" style="cursor:pointer;" id="MkCtName" data-id-ct="${Inbox.DataRoomActive.ContactReal.Id}">${Inbox.DataRoomActive.ContactReal.Name}</div>
                                                                </div>`;
                                }
                                if (Inbox.DataRoomActive.ContactReal.Country) {
                                    pri = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Country")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Country}</div>
                                                                </div>`;
                                }
                                if (Inbox.DataRoomActive.ContactReal.State) {
                                    eml = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.State")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.State}</div>
                                                                </div>`;
                                }
                                if (Inbox.DataRoomActive.ContactReal.City) {
                                    cmp = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.City")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.City}</div>
                                                                </div>`;
                                }
                                if (Inbox.DataRoomActive.ContactReal.Address) {
                                    adrs = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Address")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Address}</div>
                                                                </div>`;
                                }
                                if (Inbox.DataRoomActive.ContactReal.Postal) {
                                    zcode = `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">${Q.text("Db.Nobox.Lead.Postal")}</b>
                                                                    <div class="col-8">${Inbox.DataRoomActive.ContactReal.Postal}</div>
                                                                </div>`;
                                }
                                $("#profinfo").html(nm + pri + eml + cmp + adrs + zcode);
                                $("#MkCtName").unbind("click");
                                $("#MkCtName").on("click", function () {
                                    let dlg = new Nobox.Nobox.LeadDialog();
                                    dlg.isReadonly = true;
                                    dlg.loadByIdAndOpenDialog($(this).attr("data-id-ct"));
                                });
                            } else {
                                $(".contactfound").hide();
                                $(".contactnotfound").show();
                            }
                        }

                        Step = 42; //Profile Information
                        $("#upProf").attr("data-ct-id", Inbox.DataRoomActive.Room.CtId);
                        $("#upProf").attr(
                            "data-ctreal-id",
                            Inbox.DataRoomActive.Room.CtRealId
                        );
                        $("#upProf").attr(
                            "data-ch-id",
                            Inbox.DataRoomActive.Account.Channel
                        );
                        $("#upProf").attr(
                            "data-ct-nm",
                            Inbox.DataRoomActive.Room.CtRealNm == null
                                ? Inbox.DataRoomActive.Room.Ct
                                : Inbox.DataRoomActive.Room.CtRealNm
                        );

                        Step = 43; //Tags
                        Inbox.Data.TagCanChange = false;
                        if (Inbox.DataRoomActive.Tags == null) {
                            $("#tagskanan").val(null).trigger("change");
                        } else {
                            let arrTags = [];
                            Inbox.DataRoomActive.Tags.forEach(function (e, u) {
                                arrTags.push(e.Id);
                            });
                            $("#tagskanan").val(arrTags).trigger("change");
                        }
                        $("#tagskanan").prop("disabled", true);
                        $("#btnaddtags").hide();

                        Step = 44; //Funnel
                        Inbox.Data.FunnelCanChange = false;
                        $("#funnelskanan")
                            .val(Inbox.DataRoomActive.Room.FnId)
                            .trigger("change");
                        $("#funnelskanan").prop("disabled", true);
                        $("#btnaddfunnels").hide();

                        Step = 45; //Agents
                        Inbox.DataRoomActive.Agents = [];
                        Inbox.DataRoomActive.RoomAgents.forEach((a) => {
                            Inbox.DataRoomActive.Agents.push({
                                Id: a.Id,
                                UserId: a.UserId,
                                DisplayName: a.DisplayName,
                                UserImage: a.UserImage,
                                //RoomId: a.RoomId
                            });
                        });

                        Step = 46;
                        $("#agentname").text(
                            Inbox.DataRoomActive.RoomAgents.length + ` ${Q.text("Site.Inbox.Agent")}`
                        );
                        if (Inbox.DataRoomActive.RoomAgents.length) {
                            $("#agentSelected").addClass("mt-2");
                            $("#agentSelected").html(
                                Inbox.DataRoomActive.RoomAgents.map(function (element) {
                                    let img = "",
                                        btnDelAg = "";
                                    if (element.UserImage) {
                                        img = `style="background-image: url(${Q.resolveUrl(
                                            "~/upload/" + element.UserImage
                                        )});background-size: cover;background-position: center;"`;
                                    } else {
                                        img = `style="background-image: url(/Inbox/img/agent.png);background-size: cover;background-position: center;"`;
                                    }
                                    if (
                                        Inbox.IsAgentView == false ||
                                        Inbox.Info.currentUser().UserId == element.UserId
                                    )
                                        agDel =
                                            '<i data-id-ag="' +
                                            element.Id +
                                            '" data-id-user="' +
                                            element.UserId +
                                            '" data-nm-ag="' +
                                            element.DisplayName +
                                            '" class="DeleteAgent fa fa-close text-danger" style="cursor:pointer;"></i>';
                                    return (
                                        '<div class="user-lkcard mb-1">' +
                                        '<div class="user-lkavatar bg-transparent" ' +
                                        img +
                                        ">" +
                                        "</div>" +
                                        '<div class="col-9 pl-0 ml-2 user-info">' +
                                        '<span class="lead-text">' +
                                        element.DisplayName +
                                        "</span>" +
                                        "</div>" +
                                        btnDelAg +
                                        "</div>"
                                    );
                                }).join("\n")
                            );
                        } else {
                            $("#agentSelected").removeClass("mt-2");
                            $("#agentSelected").html(
                                `<div class="text-danger" id="NSAgents" style="cursor: pointer;">${Q.text("Site.Inbox.NotSet")}</div>`
                            );
                            $("#NSAgents").on("click", function (e) {
                                e.stopPropagation();
                                $("#addAgents").lkdropdown("toggle");
                                setTimeout(() => {
                                    $("#cariagent").focus();
                                }, 100);
                            });
                        }
                        //checkbox auto archive
                        $("#DoNotarchivedBTN").hide();
                        $(".DoNotarchivedBTN").text("");
                        $("#DoNotresolvedBTN").hide();
                        $(".DoNotresolvedBTN").text("");
                        Step = 47; //Messages
                        $("#chatloading").hide();
                        $("#chatselected").show();
                        //$(".lds-spinner-chatmsg1").hide();

                        Step = 48; //Filter agent to assigned
                        $("#listAgent").html("");
                        Inbox.DataRoomActive.SelectAgents.forEach((a, u) => {
                            let warna = "bg-primary",
                                eml = '</span><p class="text-primary fs-11 mb-0">' +
                                    a.JmlConversation +
                                    " " +
                                    Q.text("Site.Inbox.Conversations") +
                                    "</p>";
                            if (a.Online == "Offline") {
                                warna = "bg-secondary";
                            }
                            $("#listAgent").append(
                                '<li data-id-agent="' +
                                a.UserId +
                                '" data-nm-agent="' +
                                a.DisplayName +
                                '" data-img-agent="' +
                                a.UserImage +
                                '" class="AddAgent border-bottom disabledLink"><a class="lkdropdown-item"><div class="d-flex"><div class="onlineIndikator ' +
                                warna +
                                ' mt-1"></div> <div class="ml-2"><p class="mb-0 text-black text-bold">' +
                                a.DisplayName +
                                "</p> " +
                                eml +
                                "</div></div></a></li>"
                            );
                        });

                        Step = 49; //Campaign
                        if (Inbox.DataRoomActive.Campaign == null) {
                            $("#campaignF").hide();
                            $("#campaignNF").show();
                        } else {
                            $("#campaignF").show();
                            $("#campaignNF").hide();
                            let elm = ``;
                            if (Inbox.DataRoomActive.Campaign.Name) {
                                elm =
                                    elm +
                                    `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewCampaign")}" style="cursor:pointer;" id="MkCampaignName" data-id-campaign="${Inbox.DataRoomActive.Campaign.Id}">${Inbox.DataRoomActive.Campaign.Name}</div>
                                            </div>`;
                            }
                            if (Inbox.DataRoomActive.Campaign.Status) {
                                let stCampaign = `<span class="lkbadge lkbadge-outline-danger">CANCEL</span>`;
                                if (Inbox.DataRoomActive.Campaign.Status == 1) {
                                    stCampaign = `<span class="lkbadge lkbadge-outline-secondary">DRAFT</span>`;
                                } else if (Inbox.DataRoomActive.Campaign.Status == 2) {
                                    stCampaign = `<span class="lkbadge lkbadge-outline-warning">PROCESS</span>`;
                                } else if (Inbox.DataRoomActive.Campaign.Status == 3) {
                                    stCampaign = `<span class="lkbadge lkbadge-outline-success">DONE</span>`;
                                }
                                elm =
                                    elm +
                                    `<div class="row pt-1 pl-3 pr-3">
                                                                    <b class="col-4" style="font-weight:500;">Status</b>
                                                                    <div class="col-8">${stCampaign}</div>
                                                                </div>`;
                            }
                            $("#campaignF").html(elm);
                            $("#MkCampaignName").unbind("click");
                            $("#MkCampaignName").on("click", function () {
                                let dlg = new Nobox.Nobox.CampaignDialog();
                                dlg.isReadonly = true;
                                dlg.loadByIdAndOpenDialog($(this).attr("data-id-campaign"));
                            });
                        }

                        Step = 50; //Deal
                        if (Inbox.DataRoomActive.Deal == null) {
                            $("#dealF").hide();
                            $("#dealNF").show();
                        } else {
                            $("#dealF").show();
                            $("#dealNF").hide();
                            let elm = ``;
                            if (Inbox.DataRoomActive.Deal.Name) {
                                elm =
                                    elm +
                                    `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Name</b>
                                                <div class="col-8 text-primary" title="${Q.text("Site.Inbox.ViewDeal")}" style="cursor:pointer;" id="MkDealName" data-id-deal="${Inbox.DataRoomActive.Deal.Id}">${Inbox.DataRoomActive.Deal.Name}</div>
                                            </div>`;
                            }
                            if (Inbox.DataRoomActive.Deal.Pipeline) {
                                elm =
                                    elm +
                                    `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Pipeline</b>
                                                <div class="col-8">${Inbox.DataRoomActive.Deal.Pipeline}</div>
                                            </div>`;
                            }
                            if (Inbox.DataRoomActive.Deal.Stage) {
                                elm =
                                    elm +
                                    `<div class="row pt-1 pl-3 pr-3">
                                                <b class="col-4" style="font-weight:500;">Stage</b>
                                                <div class="col-8">${Inbox.DataRoomActive.Deal.Stage}</div>
                                            </div>`;
                            }

                            $("#dealF").html(elm);
                            $("#MkDealName").unbind("click");
                            $("#MkDealName").on("click", function () {
                                let dlg = new Nobox.CRM.DealsDialog();
                                dlg.isReadonly = true;
                                dlg.loadByIdAndOpenDialog($(this).attr("data-id-deal"));
                            });
                        }
                        $("#accRoom").unbind("click");
                        $("#accRoom").on("click", function () {
                            let dlg = new Nobox.Nobox.AccountDialog();
                            dlg.isReadonly = true;
                            dlg.loadByIdAndOpenDialog($(this).attr("data-id-account"));
                        });

                        $("#restoreBTN").unbind("click");
                        $("#restoreBTN").on("click", function () {
                            RestoreArchived($(this).attr("data-restore"));
                        });

                        //Messages array
                        if (!Q.isEmptyOrNull(Inbox.DataRoomActive.Messages.Msgs)) {
                            let msgsss = JSON.parse(Inbox.DataRoomActive.Messages.Msgs);
                            if (
                                msgsss.length /* && Inbox.DataRoomActive.Agents.length > 0*/
                            ) {
                                msgsss.forEach(function (e, k) {
                                    if (k == 0) {
                                        timeGroup = Q.formatDate(new Date(e.In), "yyyy-MM-dd");
                                    }
                                    if (k == msgsss.length - 1) {
                                        let date = new Date(e.In);
                                        timeGroup = Q.formatDate(
                                            new Date(date.setDate(date.getDate() - 1)),
                                            "yyyy-MM-dd"
                                        );
                                    }
                                    Inbox.Function.TemplateElmMsg.showMsg(e, true, false, "#chat-container", false, false);
                                    //createChatMessage(e, "#chat-container", NamaKontak, "append");
                                    //gotoBottom()
                                });
                            }
                        }
                        //} catch (error) {
                        //    console.error(`LeaveConversation Step = ${Step}, Msg = ${error}`)
                        //}
                    },
                });
            }

            //klik link
            $(".toConversationChannel").on("click", async function () {
                if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                    Q.notifyWarning(Q.text("Site.Inbox.CantRedirect"));
                } else {
                    let link = Inbox.DataRoomActive.Link;
                    if (link.ChId == 19) {
                        if (!Q.isEmptyOrNull(link.IdExt)) {
                            window.open(`mailto:${link.IdExt}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 1) {
                        if (!Q.isEmptyOrNull(link.IdExt)) {
                            let fisrtLater = link.IdExt.charAt(0);
                            let noHp = link.IdExt;
                            let noHpFinal = link.IdExt;
                            if (fisrtLater == "0") {
                                noHpFinal = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                            }
                            window.open(`https://wa.me/${noHpFinal}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 2) {
                        if (!Q.isEmptyOrNull(link.IdExt)) {
                            let extra = JSON.parse(link.Extra);
                            if (!Q.isEmptyOrNull(extra.Username)) {
                                window.open(`https://t.me/${extra.Username}`);
                            } else {
                                Q.notifyWarning(Q.text("Site.Inbox.LinkNoUsername"));
                            }
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 1504) {
                        if (!Q.isEmptyOrNull(link.Name)) {
                            window.open(`https://shopee.co.id/${link.Name}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 1505 || link.ChId == 1562) {
                        if (!Q.isEmptyOrNull(link.IdCvr)) {
                            window.open(`https://www.tokopedia.com/${link.IdCvr}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 1492) {
                        Q.notifyWarning(Q.text("Site.Inbox.LinkNoUsername"));
                        //if (!Q.isEmptyOrNull(link.IdExt)) {
                        //    window.open(`https://www.bukalapak.com/u/${link.IdExt}`);
                        //}
                    } else if (link.ChId == 1532) {
                        if (!Q.isEmptyOrNull(link.IdExt)) {
                            window.open(`https://www.olx.co.id/profile/${link.IdExt.split("_")[0]}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    } else if (link.ChId == 1502) {
                        if (!Q.isEmptyOrNull(link.IdExt)) {
                            window.open(`https://www.blibli.com/member/seller-chat/${link.IdExt}`);
                        } else {
                            Q.notifyError(Q.text("Site.Inbox.LinkNf"));
                        }
                    }
                }
            });

            //ganti tags
            $("#tagskanan").on("change", async function () {
                if (Inbox.Data.TagCanChange == true) {
                    try {
                        let objTag = {
                            Mode: "Select",
                            Id: $("#tagskanan").val(),
                        };
                        await connection.invoke(
                            "MkTag",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(objTag),
                            JSON.stringify($("#tagskanan").val())
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessChangeTag"));
                    } catch (error) {
                        console.error(`MkTag Step = ${Step}, Msg = ${error}`);
                    }
                } else {
                    Inbox.Data.TagCanChange = true;
                }
            });

            $("#funnelskanan").on("change", async function () {
                if (Inbox.Data.FunnelCanChange == true) {
                    try {
                        let objFunnel = {
                            Mode: "Select",
                            Id: $("#funnelskanan").val(),
                        };
                        await connection.invoke(
                            "MkFunnel",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(objFunnel)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessChangeFunnel"));
                    } catch (error) {
                        console.error(`MkFunnel Step = ${Step}, Msg = ${error}`);
                    }
                } else {
                    Inbox.Data.FunnelCanChange = true;
                }
            });

            //menjadikan arhcived
            function MoveArchive(params) {
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmArchived"),
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/MoveArchive",
                            request: {
                                EntityId: params,
                            },
                            onSuccess: async (response) => {
                                try {
                                    await connection.invoke(
                                        "MoveArchive",
                                        params,
                                        response.Unassign
                                    );
                                    Q.notifySuccess(Q.text("Site.Inbox.SuccessArchived"));
                                } catch (error) {
                                    console.error(`MoveArchive Step = ${Step}, Msg = ${error}`);
                                }
                            },
                        });
                    },
                    {
                        // title: "Archive conversation",
                    }
                );
            }

            //restore pesan dari archived
            function RestoreArchived(params) {
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmRestore"),
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/RestoreArchived",
                            request: {
                                EntityId: params,
                            },
                            onSuccess: async (response) => {
                                try {
                                    await connection.invoke(
                                        "RestoreArchive",
                                        params,
                                        response.Unassign,
                                        response.Archive
                                    );
                                    Q.notifySuccess(Q.text("Site.Inbox.SuccessRestore"));
                                } catch (error) {
                                    console.error(
                                        `RestoreArchive Step = ${Step}, Msg = ${error}`
                                    );
                                }
                            },
                        });
                    },
                    {
                        // title: "Restore conversation",
                    }
                );
            }

            //menandai sebagai resolved
            function MarkResolved(params) {
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmResolved"),
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/MarkResolved",
                            request: {
                                EntityId: params,
                                Entity: {
                                    St: 3,
                                    Uc: 0,
                                    IsPin: 1,
                                    Isblock: 1,
                                    ReById: $(".nk-chat-body").attr("data-ag-id"),
                                    ReByNm: $(".nk-chat-body").attr("data-ag-nm")
                                },
                            },
                            onSuccess: (res) => {
                                if (!res.IsError) {
                                    Q.notifySuccess(Q.text("Site.Inbox.SuccessResolved"));
                                } else {
                                    Q.notifyError(res.ErrorMsg);
                                }
                            },
                        });
                    },
                    {
                        //title: "Resolve conversation",
                    }
                );
            }

            //menandai sebagai resolved dan archive
            function MarkResolvedAndArchived(params) {
                Q.confirm(
                    Q.text("Site.Inbox.ConfirmResolvedAndArchived"),
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/MarkResolved",
                            request: {
                                EntityId: params,
                                Entity: {
                                    St: 3,
                                    Uc: 0,
                                    IsPin: 1,
                                    Isblock: 1,
                                    ReById: $(".nk-chat-body").attr("data-ag-id"),
                                    ReByNm: $(".nk-chat-body").attr("data-ag-nm")
                                },
                            },
                            onSuccess: (res) => {
                                if (!res.IsError) {
                                    Q.serviceCall({
                                        blockUI: false,
                                        url: "/Services/Chat/Chatrooms/MoveArchive",
                                        request: {
                                            EntityId: params,
                                        },
                                        onSuccess: async (response) => {
                                            try {
                                                await connection.invoke(
                                                    "MoveArchive",
                                                    params,
                                                    response.Unassign
                                                );
                                                Q.notifySuccess(Q.text("Site.Inbox.SuccessResolvedAndArchived"));
                                            } catch (error) {
                                                console.error(`MarkResolvedAndArchived Step = ${Step}, Msg = ${error}`);
                                            }
                                        },
                                    });
                                } else {
                                    Q.notifyError(res.ErrorMsg);
                                }
                            },
                        });
                    },
                    {
                        //title: "Resolve conversation",
                    }
                );
            }

            //menuju ke menu archive
            $("#cntAr").on("click", function () {
                Inbox.DataRoomActive.Agents = Inbox.Default.Users;
                $(".isNoArchive").hide();
                $(".isArchive").show();
                $("#roomId" + Inbox.IdRoomAktif).removeClass(" current");
                BuatListConversation("archive");
            });

            $("#cntArAgent").on("click", function () {
                Inbox.DataRoomActive.Agents = Inbox.Default.Users;
                $("#conversationAgent").hide();
                $("#conversationArchiveAgent").show();
                $("#roomId" + Inbox.IdRoomAktif).removeClass(" current");
                BuatListConversation("archive");
            });

            //kembali dari menu archive
            $("#backnoarchive").on("click", function () {
                $(".isArchive").hide();
                $(".isNoArchive").show();
                BuatListConversation(initialTab);
            });
            $("#conversationArchiveAgentBack").on("click", function () {
                $("#conversationAgent").show();
                $("#conversationArchiveAgent").hide();
                BuatListConversation(initialTab);
            });

            //kirim ke signalr
            async function KirimPesan(obj, roomId) {
                try {
                    $(".floatCustomSending").show();
                    $("#emojiEditor1").attr("contenteditable", false);
                    let objParse = JSON.parse(obj)
                    if (objParse.Template) {
                        let pesan = await connection.invoke("KirimPesan", JSON.stringify(objParse));
                        if (pesan.isError) {
                            Q.confirm(
                                pesan.errorMsg /*+ ` ${Q.text("Site.Inbox.Subscription")}`*/,
                                () => {
                                    //window.open(
                                    //    pesan.isLimit ? `https://crm.nobox.ai/services/details/inv/${pesan.chIdAlias}/${pesan.chName}` : `https://crm.nobox.ai/services/details/inv/${pesan.chIdAlias}/${pesan.chName}-Automation-${pesan.level}`
                                    //);
                                }
                            );
                            $(`#ack${m.Id}`).attr(`data-error`, pesan.errorMsg + ` ${Q.text("Site.Inbox.Subscription")}`);
                            $(`#ack${m.Id}`).attr(`data-error-id`, m.Id);
                            $(`[data-error-id=${m.Id}]`).unbind(`click`);
                            $(`[data-error-id=${m.Id}]`).on("click", function () {
                                let dlgErr = new Nobox.DialogErrorDialog();
                                dlgErr.loadEntityAndOpenDialog({
                                    ErrorMessage: $(this).attr("data-error"),
                                });
                            });
                        }
                        $(".floatCustomSending").hide();
                        $("#emojiEditor1").attr("contenteditable", true);
                        $(`#ack${m.Id}`).html(
                            `<i style="cursor:pointer;" class="fas fa-exclamation-circle text-danger"></i>`
                        );
                    } else {
                        let isTrialButQuickReply = false;
                        if (Q.isEmptyOrNull(objParse.Msg.ReplyId)) {
                            objParse.Msg.ReplyId = Inbox.ReplyIdMsg;
                        } else {
                            isTrialButQuickReply = true;
                        }
                        objParse.Msg.Id = generateMessageId();
                        $("#cancelReplyElm").click();

                        //if (objParse.Msg.Type != "12" && objParse.Msg.Type != "13") {
                        let objParseDummy = { ...objParse };
                        let objMsgDummy = objParseDummy.Msg;
                        let adaReply = Inbox.ListMessages.filter(x => x.Type.toString() != "6").find(x => x.Id.toString() == objMsgDummy.ReplyId);
                        if (adaReply != null) {
                            objMsgDummy.ReplyId = adaReply.Id;
                            objMsgDummy.ReplyType = adaReply.Type;
                            objMsgDummy.ReplyFrom = adaReply.From;
                            objMsgDummy.ReplyFiles = Q.isEmptyOrNull(adaReply.Files) ? adaReply.File : adaReply.Files;
                            objMsgDummy.ReplyMsg = adaReply.Msg;
                            objMsgDummy.ReplyGrpMember = adaReply.GrpMember;
                        }
                        objMsgDummy.RoomId = objParseDummy.Room.Id;
                        objMsgDummy.From = Inbox.DataRoomActive.Account.Id;
                        objMsgDummy.To = Inbox?.DataRoomActive?.Link?.Id;
                        objMsgDummy.AgentId = Inbox.Info.currentUser().UserId;
                        objMsgDummy.In = moment.utc();
                        objMsgDummy.Up = moment.utc();
                        objMsgDummy.InBy = Inbox.Info.currentUser().UserId;
                        objMsgDummy.UpBy = Inbox.Info.currentUser().UserId;
                        objMsgDummy.Ack = 1;
                        objMsgDummy.RoomId = Inbox.DataRoomActive.Room.Id;
                        let listFile = [], listMsgDummy = [];
                        if (!Q.isEmptyOrNull(objMsgDummy.File) && objMsgDummy.File != "[]") {
                            listFile = JSON.parse(objMsgDummy.File);
                        }
                        else if (!Q.isEmptyOrNull(objMsgDummy.Files) && objMsgDummy.Files != "[]") {
                            listFile = JSON.parse(objMsgDummy.Files);
                        }
                        let isCaption = false;
                        if (listFile.length == 1 && !Q.isEmptyOrNull(objMsgDummy.Msg) && (Inbox.DataRoomActive.Account.Channel == 1 || Inbox.DataRoomActive.Account.Channel == 2 || Inbox.DataRoomActive.Account.Channel == 1557))
                            isCaption = true;

                        // let subscribedCh = Inbox.Info.getChannels().filter(ch => ch.Data == Inbox.DataRoomActive.Account.Channel);
                        // if (subscribedCh.length < 1) {
                        //     if (objMsgDummy.Type == "1" && !isTrialButQuickReply)
                        //         objMsgDummy.Msg += `\n\n${Q.text("Site.Inbox.MsgTrial")}`;
                        //     //else {
                        //     //    if (objMsgDummy.Type != "19" && objMsgDummy.Type != "21")
                        //     //        objMsgDummy.Msg += `\n\n${Q.text("Site.Inbox.MsgTrial")}`;
                        //     //}
                        // }

                        if (!isCaption) {
                            let objMsgDummy2 = { ...objMsgDummy }
                            if (!Q.isEmptyOrNull(objMsgDummy2.Msg)) {
                                objMsgDummy2.Type = listFile.length > 0 ? "1" : objMsgDummy2.Type;
                                objMsgDummy2.File = null;
                                objMsgDummy2.Files = null;
                                listMsgDummy.push(objMsgDummy2)
                            }
                            listFile.forEach((f, i) => {
                                let objMsgDummy3 = { ...objMsgDummy }
                                objMsgDummy3.File = JSON.stringify(f);
                                objMsgDummy3.Files = null;
                                objMsgDummy3.Msg = null;
                                listMsgDummy.push(objMsgDummy3)
                            })
                        } else {
                            if (listFile.length > 0) {
                                listFile.forEach((f, i) => {
                                    let objMsgDummy4 = { ...objMsgDummy }
                                    objMsgDummy4.File = JSON.stringify(f);
                                    objMsgDummy4.Files = null;
                                    listMsgDummy.push(objMsgDummy4)
                                })
                            } else {
                                listMsgDummy.push(objMsgDummy);
                            }
                        }
                        let isLanjut = true;
                        listMsgDummy.forEach(async (m, i) => {
                            if (isLanjut) {
                                m.Id = generateMessageId();
                                if (m.Type != 12 && m.Type != 13) {
                                    console.log({ m }, Inbox.Info.isTrial())
                                    if (Inbox.Info.isTrial() && m.Type == 1) {
                                        const mDummy = { ...m }
                                        mDummy.Msg = `${mDummy.Msg}\n\n${Q.text("Site.Inbox.MsgTrial")}`
                                        Inbox.Function.TemplateElmMsg.showMsg(mDummy, true, true)
                                    } else {
                                        Inbox.Function.TemplateElmMsg.showMsg(m, true, true)
                                    }
                                }
                                //createChatMessage(m, "#chat-container", $("#upProf").attr("data-ct-nm"), "append", "Bawah");

                                if (m.Type == 19 || m.Type == 21) {
                                    m.Msg = objMsgDummy.Msg;
                                }
                                objParse.Msg = m;
                                let pesan = await connection.invoke("KirimPesan", JSON.stringify(objParse));
                                if (pesan.isError) {
                                    Q.confirm(
                                        pesan.errorMsg + ` ${Q.text("Site.Inbox.Subscription")}`,
                                        () => {
                                            window.open(
                                                pesan.isLimit ? `https://crm.nobox.ai/services/details/inv/${pesan.chIdAlias}/${pesan.chName}` : `https://crm.nobox.ai/services/details/inv/${pesan.chIdAlias}/${pesan.chName}-Automation-${pesan.level}`
                                            );
                                        }
                                    );
                                    $(".floatCustomSending").hide();
                                    $("#emojiEditor1").attr("contenteditable", true);
                                    isLanjut = false;
                                    $(`#ack${m.Id}`).html(
                                        `<i style="cursor:pointer;" class="fas fa-exclamation-circle text-danger"></i>`
                                    );
                                    $(`#ack${m.Id}`).attr(`data-error`, pesan.errorMsg + ` ${Q.text("Site.Inbox.Subscription")}`);
                                    $(`#ack${m.Id}`).attr(`data-error-id`, m.Id);
                                    $(`[data-error-id=${m.Id}]`).unbind(`click`);
                                    $(`[data-error-id=${m.Id}]`).on("click", function () {
                                        let dlgErr = new Nobox.DialogErrorDialog();
                                        dlgErr.loadEntityAndOpenDialog({
                                            ErrorMessage: $(this).attr("data-error"),
                                        });
                                    });
                                }
                                if (i == listMsgDummy.length - 1) {
                                    $(".floatCustomSending").hide();
                                    $("#emojiEditor1").attr("contenteditable", true);
                                }
                            }
                        })
                    }
                } catch (error) {
                    //let PesanPending = localStorage.getItem("PesanPending");
                    //let ArrPesan = Q.isEmptyOrNull(PesanPending)
                    //    ? []
                    //    : JSON.parse(PesanPending);
                    //ArrPesan.push({ RoomId: roomId, Obj: obj });
                    //localStorage.setItem("PesanPending", JSON.stringify(ArrPesan));
                    $(".floatCustomSending").hide();
                    $("#emojiEditor1").attr("contenteditable", true);
                    //console.error(`KirimPesan Step = ${Step}, Msg = ${error}`);
                }
            }

            //kirim pesan dari inputan emoji
            $(".chat-send").on("click", async function (e) {
                let data = $(this).attr("data-msg");
                if (data) {
                    checkUserInRoomAndInsertMsg(data);
                } else {
                    if ($("#emoji")[0].emojioneArea.getText() == "" || $("#emoji")[0].emojioneArea.getText() == null || $("#emoji")[0].emojioneArea.getText() == undefined) {
                        //Q.alert("Message cannot be null");
                    } else if ($("#emoji")[0].emojioneArea.getText().length <= 2000) {
                        checkUserInRoomAndInsertMsg()
                    } else {
                        Q.notifyError(Q.text("Site.Inbox.MsgLong"));
                    }
                }
            });

            function checkUserInRoomAndInsertMsg(data = "") {
                if (!Q.isEmptyOrNull(data)) {
                    let objData = JSON.parse(data);
                    $(".chat-send").attr("data-msg", "");
                    function insertMsg() {
                        Inbox.Data.SkipMsg = Inbox.Data.SkipMsg + 1;
                        let dataMsg = {
                            Room: {
                                IdLink:
                                    Inbox.DataRoomActive.Link == null
                                        ? null
                                        : Inbox.DataRoomActive.Link.Id,
                                IdGroup:
                                    Inbox.DataRoomActive.Group == null
                                        ? null
                                        : Inbox.DataRoomActive.Group.Id,
                                IdAccount: Inbox.DataRoomActive.Account.Id,
                                IdRoom: Inbox.DataRoomActive.Room.Id,
                            },
                            Msg: {
                                Type: "1",
                                Msg: objData.text,
                                File: null,
                                Files: null,
                                ReplyId: objData.idMsg
                            },
                        };
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                        $("#emoji")[0].emojioneArea.setText("");
                    }
                    if (Inbox.IsAgentView) {
                        insertMsg();
                    } else {
                        if (Inbox.DataRoomActive.Agents.filter((b) => b.UserId == Inbox.Info.currentUser().UserId).length) {
                            insertMsg();
                        } else {
                            let dataMsg = {
                                Room: {
                                    IdLink:
                                        Inbox.DataRoomActive.Link == null
                                            ? null
                                            : Inbox.DataRoomActive.Link.Id,
                                    IdGroup:
                                        Inbox.DataRoomActive.Group == null
                                            ? null
                                            : Inbox.DataRoomActive.Group.Id,
                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                },
                                Msg: {
                                    Type: "1",
                                    Msg: objData.text,
                                    File: null,
                                    Files: null,
                                    ReplyId: objData.idMsg
                                },
                            };
                            InsertAgentYgLogin(dataMsg);
                            $("#emoji")[0].emojioneArea.setText("");
                        }
                    }
                } else {
                    function insertMsg() {
                        Inbox.Data.SkipMsg = Inbox.Data.SkipMsg + 1;
                        let dataMsg = {
                            Room: {
                                IdLink:
                                    Inbox.DataRoomActive.Link == null
                                        ? null
                                        : Inbox.DataRoomActive.Link.Id,
                                IdGroup:
                                    Inbox.DataRoomActive.Group == null
                                        ? null
                                        : Inbox.DataRoomActive.Group.Id,
                                IdAccount: Inbox.DataRoomActive.Account.Id,
                                IdRoom: Inbox.DataRoomActive.Room.Id,
                            },
                            Msg: {
                                Type: "1",
                                Msg: $("#emoji")[0].emojioneArea.getText(),
                                File: null,
                                Files: null,
                            },
                        };
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                        $("#emoji")[0].emojioneArea.setText("");
                    }
                    if (Inbox.IsAgentView) {
                        insertMsg();
                    } else {
                        if (Inbox.DataRoomActive.Agents.filter((b) => b.UserId == Inbox.Info.currentUser().UserId).length) {
                            insertMsg();
                        } else {
                            let dataMsg = {
                                Room: {
                                    IdLink:
                                        Inbox.DataRoomActive.Link == null
                                            ? null
                                            : Inbox.DataRoomActive.Link.Id,
                                    IdGroup:
                                        Inbox.DataRoomActive.Group == null
                                            ? null
                                            : Inbox.DataRoomActive.Group.Id,
                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                },
                                Msg: {
                                    Type: "1",
                                    Msg: $("#emoji")[0].emojioneArea.getText(),
                                    File: null,
                                    Files: null,
                                },
                            };
                            InsertAgentYgLogin(dataMsg);
                            $("#emoji")[0].emojioneArea.setText("");
                        }
                    }
                }
            }

            //button upploadfoto
            $("#uploadfoto").on("click", function () {
                $(".toggle-opt").removeClass(" active");
                $(".chat-upload-option").removeClass(" expanded");
                FotoUpload(null);
            });

            //upload foto
            function FotoUpload(messages, pesan, pesanfile) {
                let dlg = new Nobox.ChatmessagesImgDialog();
                dlg.callback = async (msg, files, file) => {
                    let resImg = {
                        Msg: msg,
                        Files: files,
                        File: file,
                    };
                    let dataMsg = {
                        Room: {
                            IdLink:
                                Inbox.DataRoomActive.Link == null
                                    ? null
                                    : Inbox.DataRoomActive.Link.Id,
                            IdGroup:
                                Inbox.DataRoomActive.Group == null
                                    ? null
                                    : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {
                            Type: "3",
                            Msg: resImg.Msg,
                            File: resImg.File,
                            Files: resImg.Files,
                        },
                    };
                    if (
                        Inbox.DataRoomActive.Agents.filter(
                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                        ).length < 1
                    ) {
                        InsertAgentYgLogin(dataMsg);
                    } else {
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                    }
                };
                if (messages != null) {
                    $("#emoji")[0].emojioneArea.setText("");
                    dlg.isFile = "File";
                    dlg.loadEntityAndOpenDialog({
                        RoomId: $(".nk-chat-body").attr("data-id"),
                        From: $(".nk-chat-body").attr("data-user-from"),
                        To: $(".nk-chat-body").attr("data-user-to"),
                        AgentId: $(".nk-chat-body").attr("data-ag-id"),
                        Msg: pesan,
                        File: pesanfile,
                    });
                } else {
                    dlg.loadEntityAndOpenDialog({
                        RoomId: $(".nk-chat-body").attr("data-id"),
                        From: $(".nk-chat-body").attr("data-user-from"),
                        To: $(".nk-chat-body").attr("data-user-to"),
                        AgentId: $(".nk-chat-body").attr("data-ag-id"),
                    });
                }
            }

            //button uploadfile
            $("#uploadfile").on("click", function () {
                $(".toggle-opt").removeClass(" active");
                $(".chat-upload-option").removeClass(" expanded");
                FileUpload(null);
            });

            //fungsi validasi agent
            function InsertAgentYgLogin(dataMsg) {
                let entAgent = {
                    RoomId: Inbox.DataRoomActive.Room.Id,
                    UserId: Inbox.Info.currentUser().UserId,
                    DisplayName: Inbox.Info.currentUser().DisplayName,
                    UserImage: Inbox.Info.currentUser().UserImage,
                    HandId: Inbox.Info.currentUser().UserId,
                    CtId:
                        Inbox.DataRoomActive.Link == null
                            ? null
                            : Inbox.DataRoomActive.Link.Id,
                    ChId: Inbox.DataRoomActive.Room.ChId,
                };
                let objPesanSap = {
                    msg: "Site.Inbox.HasAsign",
                    user: null,
                    userHandle: Inbox.Info.currentUser().UserId
                }
                Q.serviceCall({
                    blockUI: false,
                    url: "/Services/Chat/Chatrooms/JoinAgentAndSentMsg",
                    request: {
                        Agent: entAgent,
                        Msg: {
                            Type: 6,
                            RoomId: $(".nk-chat-body").attr("data-id"),
                            Msg: JSON.stringify(objPesanSap),
                        },
                        RoomId: $(".nk-chat-body").attr("data-id"),
                    },
                    onSuccess: async (response) => {
                        if (!response.IsError) {
                            try {
                                entAgent.Id = response.Data;
                                let finalObjAgent = {
                                    Mode: "Add",
                                    Data: entAgent,
                                };
                                let objPesan = BuatObjPesan(
                                    6,
                                    JSON.stringify(objPesanSap),
                                    null,
                                    null
                                );
                                await connection.invoke(
                                    "MkAgent",
                                    $(".nk-chat-body").attr("data-id"),
                                    JSON.stringify(finalObjAgent),
                                    JSON.stringify(objPesan),
                                    response.JmlUnassigned.toString()
                                );
                                KirimPesan(
                                    JSON.stringify(dataMsg),
                                    `${Inbox.DataRoomActive.Room.Id}`
                                );
                            } catch (error) {
                                console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                            }
                        } else {
                            Q.alert(response.ErrorMsg);
                        }
                    },
                });
            }

            //upload file
            function FileUpload(messages, pesan, pesanfile) {
                let dlg = new Nobox.ChatmessagesFileDialog();
                dlg.callback = async (msg, files, file, type) => {
                    let resFile = {
                        Msg: msg,
                        Files: files,
                        File: file,
                        Type: type,
                    };
                    let dataMsg = {
                        Room: {
                            IdLink:
                                Inbox.DataRoomActive.Link == null
                                    ? null
                                    : Inbox.DataRoomActive.Link.Id,
                            IdGroup:
                                Inbox.DataRoomActive.Group == null
                                    ? null
                                    : Inbox.DataRoomActive.Group.Id,
                            IdAccount: Inbox.DataRoomActive.Account.Id,
                            IdRoom: Inbox.DataRoomActive.Room.Id,
                        },
                        Msg: {
                            Type: resFile.Type,
                            Msg: resFile.Msg,
                            File: resFile.File,
                            Files: resFile.Files,
                        },
                    };
                    if (
                        Inbox.DataRoomActive.Agents.filter(
                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                        ).length < 1
                    ) {
                        InsertAgentYgLogin(dataMsg);
                    } else {
                        KirimPesan(
                            JSON.stringify(dataMsg),
                            `${Inbox.DataRoomActive.Room.Id}`
                        );
                    }
                };
                if (messages != null) {
                    $("#emoji")[0].emojioneArea.setText("");
                    dlg.isFile = "File";
                    dlg.loadEntityAndOpenDialog({
                        RoomId: $(".nk-chat-body").attr("data-id"),
                        From: $(".nk-chat-body").attr("data-user-from"),
                        To: $(".nk-chat-body").attr("data-user-to"),
                        AgentId: $(".nk-chat-body").attr("data-ag-id"),
                        Msg: pesan,
                        File: pesanfile,
                    });
                } else {
                    dlg.loadEntityAndOpenDialog({
                        RoomId: $(".nk-chat-body").attr("data-id"),
                        From: $(".nk-chat-body").attr("data-user-from"),
                        To: $(".nk-chat-body").attr("data-user-to"),
                        AgentId: $(".nk-chat-body").attr("data-ag-id"),
                    });
                }
            }

            //trigger input type file khusus video
            $("#videoInputContainer").off("click").on("click", function () {
                $("#idVideoInput").click();
            })
            $("#idVideoInput").on("change", function () {
                const file = this.files[0];  // Mendapatkan file yang dipilih
                if (file) {
                    const validation = isVideoN30MB(file);
                    if (!validation.isValid) {
                        Q.alert(validation.message);
                        $(this).value = '';  // Reset input jika tidak valid
                    } else {
                        const reader = new FileReader();

                        // Event saat file selesai dibaca
                        reader.onload = function (e) {
                            const base64String = e.target.result;  // Hasil pembacaan dalam Base64
                            $("#videoControlElm").attr("src", base64String);
                            $("#videoControlElm").attr("mimetype", file.type);
                            $('#modalVideoPreview').lkmodal('show');
                            setTimeout(() => {
                                $("#inputMsgVideo").focus();
                            }, 1000);
                        };

                        // Membaca file sebagai data URL (Base64)
                        reader.readAsDataURL(file);
                    }
                }
            })
            $('#inputMsgVideo').on('keypress', function (event) {
                // Cek apakah tombol yang ditekan adalah Enter (kode 13)
                if (event.which === 13) {
                    $("#btnSendVideo").click();
                }
            });
            $("#btnSendVideo").on("click", function () {
                if (!$("#btnSendVideo").hasClass("disabled")) {
                    $("#btnSendVideo").addClass("disabled");
                    let base64String = $("#videoControlElm").attr("src").split(',')[1];
                    if (Q.isEmptyOrNull(base64String)) {
                        Q.alert(Q.text("Site.Inbox.NoVideo"));
                    } else {
                        Q.serviceCall({
                            blockUI: true,
                            url: "/Inbox/UploadFile/ConvertBase64ToFile",
                            request: {
                                media: {
                                    data: base64String,
                                    mimetype: $("#videoControlElm").attr("mimetype"),
                                    filename: "",
                                },
                            },
                            onSuccess: async (hasil) => {
                                $("#btnSendVideo").removeClass("disabled");
                                if (!hasil.IsError) {
                                    let dataMsg = {
                                        Room: {
                                            IdLink:
                                                Inbox.DataRoomActive.Link == null
                                                    ? null
                                                    : Inbox.DataRoomActive.Link.Id,
                                            IdGroup:
                                                Inbox.DataRoomActive.Group == null
                                                    ? null
                                                    : Inbox.DataRoomActive.Group.Id,
                                            IdAccount: Inbox.DataRoomActive.Account.Id,
                                            IdRoom: Inbox.DataRoomActive.Room.Id,
                                        },
                                        Msg: {
                                            Type: "4",
                                            Msg: $("#inputMsgVideo").val(),
                                            File: JSON.stringify([hasil.Data]),
                                            Files: null,
                                        },
                                    };
                                    if (
                                        Inbox.DataRoomActive.Agents.filter(
                                            (b) => b.UserId == Inbox.Info.currentUser().UserId
                                        ).length < 1
                                    ) {
                                        InsertAgentYgLogin(dataMsg);
                                    } else {
                                        KirimPesan(
                                            JSON.stringify(dataMsg),
                                            `${Inbox.DataRoomActive.Room.Id}`
                                        );
                                    }
                                    $("#videoControlElm").attr("src", "");
                                    $("#videoControlElm").attr("mimetype", "");
                                    $(".closeModalVideo").click();
                                    $("#inputMsgVideo").val("");
                                    $("#idVideoInput").val("");
                                }
                            },
                            onError: (hasil) => {
                                $("#btnSendVideo").removeClass("disabled");
                            }
                        });
                    }
                }
            })
            function isVideoN30MB(file) {
                // Daftar tipe MIME video yang lengkap
                const validVideoTypes = [
                    'video/mp4',         // MP4
                    'video/webm',        // WebM
                    'video/ogg',         // Ogg
                    'video/x-msvideo',   // AVI
                    'video/x-matroska',  // MKV
                    'video/3gpp',        // 3GP
                    'video/3gpp2',       // 3GPP2
                    'video/mpeg',        // MPEG
                    'video/x-flv',       // FLV
                    'video/quicktime',   // MOV
                    'video/x-ms-wmv'     // WMV
                ];

                const maxSizeInMB = 30;  // Batas ukuran file dalam MB
                const maxSizeInBytes = maxSizeInMB * 1024 * 1024;
                const validExtensions = ['mp4', 'webm', 'ogg', 'avi', 'mkv', '3gp', 'mpeg', 'flv', 'mov', 'wmv'];

                // Cek tipe MIME
                if (!validVideoTypes.includes(file.type)) {
                    return { isValid: false, message: Q.text("Site.Inbox.OnlyVideoFile") };
                }

                // Cek ukuran file
                if (file.size > maxSizeInBytes) {
                    return { isValid: false, message: Q.text("Site.Inbox.FileSize").replace("{maxSizeInMB}", maxSizeInMB) };
                }

                // Cek ekstensi file (ekstra lapisan keamanan)
                const fileExtension = file.name.split('.').pop().toLowerCase();
                if (!validExtensions.includes(fileExtension)) {
                    return { isValid: false, message: Q.text("Site.Inbox.ExtensionNotValid") };
                }

                // Jika semua validasi lolos
                return { isValid: true, message: '' };
            }

            //menampilkan kamera
            $(".KlikKamera").on("click", function () {
                let width = 312;
                let height = 232;

                if (screen.width < screen.height) {
                    width = 312;
                    height = 392;
                } else {
                    width = 312;
                    height = 232;
                }
                $(".toggle-opt").removeClass(" active");
                $(".chat-upload-option").removeClass(" expanded");
                $("#footer-camera").hide();
                $("#results").hide();
                $("#btnmodalfotocamera").click();
                $("#msgCamera").val("");
                Webcam.set({
                    width: width,
                    height: height,
                    dest_width: width,
                    dest_height: height,
                    crop_width: width,
                    crop_height: height,
                });

                Webcam.attach("#my_camera");
            });

            //ga jadi ambil foto
            $(".CancelCamera").on("click", function () {
                $("#my_camera").show();
                $("#tombolcamera").show();
                $("#footer-camera").hide();
                $("#results").hide();
                Webcam.reset();
            });

            //jepret kamera
            $("#tombolcamera").on("click", function () {
                document.getElementById("results").style.display = "block";
                Webcam.snap(function (data_uri) {
                    // display results in page
                    $("#results").attr("src", data_uri);
                    Webcam.reset();
                });
                $("#footer-camera").show();
                $("#msgCamera").focus();
                $("#my_camera").hide();
                $("#tombolcamera").hide();
            });

            //klik button kamera
            $("#sendCamera").on("click", function () {
                Q.serviceCall({
                    blockUI: true,
                    url: "/Inbox/UploadFile/ConvertBase64ToFile",
                    request: {
                        media: {
                            data: $("#results").attr("src").split(',')[1],
                            mimetype: "image/jpeg",
                            filename: "",
                        },
                    },
                    onSuccess: async (hasil) => {
                        if (!hasil.IsError) {
                            let dataMsg = {
                                Room: {
                                    IdLink:
                                        Inbox.DataRoomActive.Link == null
                                            ? null
                                            : Inbox.DataRoomActive.Link.Id,
                                    IdGroup:
                                        Inbox.DataRoomActive.Group == null
                                            ? null
                                            : Inbox.DataRoomActive.Group.Id,
                                    IdAccount: Inbox.DataRoomActive.Account.Id,
                                    IdRoom: Inbox.DataRoomActive.Room.Id,
                                },
                                Msg: {
                                    Type: "3",
                                    Msg: $("#msgCamera").val(),
                                    File: JSON.stringify([hasil.Data]),
                                    Files: null,
                                },
                            };
                            if (
                                Inbox.DataRoomActive.Agents.filter(
                                    (b) => b.UserId == Inbox.Info.currentUser().UserId
                                ).length < 1
                            ) {
                                InsertAgentYgLogin(dataMsg);
                            } else {
                                KirimPesan(
                                    JSON.stringify(dataMsg),
                                    `${Inbox.DataRoomActive.Room.Id}`
                                );
                            }
                            $("#closefotocamera").click();
                        }
                    },
                });
            });

            //jika enter pada inputan text dibawah hasil kamera
            $("#msgCamera").on("keyup", function (e) {
                if (e.keyCode == 13) {
                    $("#sendCamera").click();
                }
            });

            //Join agent ke conversation
            function addagent(id, nm, img, isAutoAssign = false, roomId = 0) {
                let objAgent = {};
                if (img == null || img == "null" || img == "" || img == undefined) {
                    objAgent = {
                        UserId: id,
                        RoomId: roomId == 0 ? $(".nk-chat-body").attr("data-id") : roomId,
                        DisplayName: nm,
                        HandId: $(".nk-chat-body").attr("data-ag-id"),
                        CtId: $("#upProf").attr("data-ct-id"),
                        ChId: $("#upProf").attr("data-ch-id"),
                    };
                } else {
                    objAgent = {
                        UserId: id,
                        RoomId: roomId == 0 ? $(".nk-chat-body").attr("data-id") : roomId,
                        DisplayName: nm,
                        UserImage: img,
                        HandId: $(".nk-chat-body").attr("data-ag-id"),
                        CtId: $("#upProf").attr("data-ct-id"),
                        ChId: $("#upProf").attr("data-ch-id"),
                    };
                }
                let objPesanSap = {
                    msg: "Site.Inbox.HasAsign",
                    user: null,
                    userHandle: id
                }
                if (id != $(".nk-chat-body").attr("data-ag-id")) {
                    objPesanSap.msg = "Site.Inbox.HasAsignBy";
                    objPesanSap.user = Inbox.Info.currentUser().UserId
                }
                if (isAutoAssign) {
                    objPesanSap.msg = "Site.Inbox.HasAsign";
                    objPesanSap.user = null
                    Q.serviceCall({
                        blockUI: false,
                        url: "/Services/Chat/Chatrooms/AddAgentToConversation",
                        request: {
                            RoomId: roomId,
                            UserId: id,
                            RoomAgent: objAgent,
                            isHanded: 0,
                            Msg: {
                                Type: 6,
                                RoomId: roomId,
                                Msg: JSON.stringify(objPesanSap),
                            },
                        },
                        onSuccess: async (response) => {
                            if (!response.IsError) {
                                if (response.Data.IsExist) {
                                    Q.alert(Q.text("Site.Inbox.AgentJoin"));
                                } else {
                                    objAgent.Id = Number(
                                        response.Data.idAgentRoom
                                    ).toString();
                                    let finalObjAgent = {
                                        Mode: "Add",
                                        Data: objAgent,
                                    };
                                    let objPesan = BuatObjPesan(
                                        6,
                                        JSON.stringify(objPesanSap),
                                        null,
                                        null
                                    );
                                    try {
                                        await connection.invoke(
                                            "MkAgent",
                                            roomId,
                                            JSON.stringify(finalObjAgent),
                                            JSON.stringify(objPesan),
                                            response.Data.Unassigned.toString()
                                        );
                                        Q.notifySuccess(
                                            Q.text("Site.Inbox.SuccessAddAgent")
                                        );
                                    } catch (error) {
                                        console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                                    }
                                    let objDataRoom = {
                                        Mode: "Add",
                                        Data: response.Data.objRoom,
                                    };
                                    try {
                                        await connection.invoke(
                                            "AgentConversation",
                                            JSON.stringify(objDataRoom),
                                            objAgent.UserId,
                                            Inbox.Info.currentUser().TenantId
                                        );
                                    } catch (error) {
                                        console.error(
                                            `AgentConversation Step = ${Step}, Msg = ${error}`
                                        );
                                    }
                                }
                            }
                        },
                    });
                } else {
                    if (Q.Authorization.hasPermission("Role:Supervisor")) {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/AddAgentToConversation",
                            request: {
                                RoomId: $(".nk-chat-body").attr("data-id"),
                                UserId: id,
                                RoomAgent: objAgent,
                                isHanded: 0,
                                Msg: {
                                    Type: 6,
                                    RoomId: $(".nk-chat-body").attr("data-id"),
                                    Msg: JSON.stringify(objPesanSap),
                                },
                            },
                            onSuccess: async (response) => {
                                if (!response.IsError) {
                                    if (response.Data.IsExist) {
                                        Q.alert(Q.text("Site.Inbox.AgentJoin"));
                                    } else {
                                        objAgent.Id = Number(response.Data.idAgentRoom).toString();
                                        let finalObjAgent = {
                                            Mode: "Add",
                                            Data: objAgent,
                                        };
                                        let objPesan = BuatObjPesan(
                                            6,
                                            JSON.stringify(objPesanSap),
                                            null,
                                            null
                                        );
                                        try {
                                            await connection.invoke(
                                                "MkAgent",
                                                $(".nk-chat-body").attr("data-id"),
                                                JSON.stringify(finalObjAgent),
                                                JSON.stringify(objPesan),
                                                response.Data.Unassigned.toString()
                                            );
                                            Q.notifySuccess(
                                                Q.text("Site.Inbox.SuccessAddAgent")
                                            );
                                        } catch (error) {
                                            console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                                        }
                                        let objDataRoom = {
                                            Mode: "Add",
                                            Data: response.Data.objRoom,
                                        };
                                        try {
                                            await connection.invoke(
                                                "AgentConversation",
                                                JSON.stringify(objDataRoom),
                                                objAgent.UserId,
                                                Inbox.Info.currentUser().TenantId
                                            );
                                        } catch (error) {
                                            console.error(
                                                `AgentConversation Step = ${Step}, Msg = ${error}`
                                            );
                                        }
                                    }
                                }
                            },
                        });
                    } else {
                        let dlgOpsi = new Nobox.OpsiAddAgentDialog();
                        dlgOpsi.callback = (res) => {
                            if (res == "Add") {
                                Q.serviceCall({
                                    blockUI: false,
                                    url: "/Services/Chat/Chatrooms/AddAgentToConversation",
                                    request: {
                                        RoomId: $(".nk-chat-body").attr("data-id"),
                                        UserId: id,
                                        RoomAgent: objAgent,
                                        isHanded: 0,
                                        Msg: {
                                            Type: 6,
                                            RoomId: $(".nk-chat-body").attr("data-id"),
                                            Msg: JSON.stringify(objPesanSap),
                                        },
                                    },
                                    onSuccess: async (response) => {
                                        if (!response.IsError) {
                                            if (response.Data.IsExist) {
                                                Q.alert(Q.text("Site.Inbox.AgentJoin"));
                                            } else {
                                                objAgent.Id = Number(
                                                    response.Data.idAgentRoom
                                                ).toString();
                                                let finalObjAgent = {
                                                    Mode: "Add",
                                                    Data: objAgent,
                                                };
                                                let objPesan = BuatObjPesan(
                                                    6,
                                                    JSON.stringify(objPesanSap),
                                                    null,
                                                    null
                                                );
                                                try {
                                                    await connection.invoke(
                                                        "MkAgent",
                                                        $(".nk-chat-body").attr("data-id"),
                                                        JSON.stringify(finalObjAgent),
                                                        JSON.stringify(objPesan),
                                                        response.Data.Unassigned.toString()
                                                    );
                                                    Q.notifySuccess(
                                                        Q.text("Site.Inbox.SuccessAddAgent")
                                                    );
                                                } catch (error) {
                                                    console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                                                }
                                                let objDataRoom = {
                                                    Mode: "Add",
                                                    Data: response.Data.objRoom,
                                                };
                                                try {
                                                    await connection.invoke(
                                                        "AgentConversation",
                                                        JSON.stringify(objDataRoom),
                                                        objAgent.UserId,
                                                        Inbox.Info.currentUser().TenantId
                                                    );
                                                } catch (error) {
                                                    console.error(
                                                        `AgentConversation Step = ${Step}, Msg = ${error}`
                                                    );
                                                }
                                            }
                                        }
                                    },
                                });
                            } else if (res == "Transfer") {
                                objPesanSap.msg = "Site.Inbox.TransferTo"
                                Q.confirm(
                                    Q.text("Site.Inbox.SuccessTransfer"),
                                    () => {
                                        Q.serviceCall({
                                            blockUI: false,
                                            url: "/Services/Chat/Chatrooms/AddAgentToConversation",
                                            request: {
                                                RoomId: $(".nk-chat-body").attr("data-id"),
                                                UserId: id,
                                                RoomAgent: objAgent,
                                                isHanded: 1,
                                                Msg: {
                                                    Type: 6,
                                                    RoomId: $(".nk-chat-body").attr("data-id"),
                                                    Msg: JSON.stringify(objPesanSap),
                                                },
                                            },
                                            onSuccess: async (response) => {
                                                if (!response.IsError) {
                                                    if (response.Data.IsExist) {
                                                        Q.alert(
                                                            Q.text("Site.Inbox.AgentJoin")
                                                        );
                                                    } else {
                                                        objAgent.Id = Number(
                                                            response.Data.idAgentRoom
                                                        ).toString();
                                                        let finalObjAgent = {
                                                            Mode: "Edit",
                                                            Data: objAgent,
                                                            IdUserDel: $(".nk-chat-body").attr("data-ag-id"),
                                                        };
                                                        let objPesan = BuatObjPesan(
                                                            6,
                                                            JSON.stringify(objPesanSap),
                                                            null,
                                                            null
                                                        );
                                                        try {
                                                            await connection.invoke(
                                                                "MkAgent",
                                                                $(".nk-chat-body").attr("data-id"),
                                                                JSON.stringify(finalObjAgent),
                                                                JSON.stringify(objPesan),
                                                                response.Data.Unassigned.toString()
                                                            );
                                                            Q.notifySuccess(
                                                                Q.text("Site.Inbox.SuccessAddAgent")
                                                            );
                                                        } catch (error) {
                                                            console.error(
                                                                `MkAgent Step = ${Step}, Msg = ${error}`
                                                            );
                                                        }
                                                    }
                                                }
                                            },
                                        });
                                    },
                                    //{ title: `Transfer this conversation to "${nm}" ?` }
                                );
                            }
                        };
                        dlgOpsi.dialogOpen();
                    }
                }
            }

            //Remove agent
            function deleteAgent(params, idUser, nm) {
                let objPesanSap = {
                    msg: "Site.Inbox.AgentOut",
                    user: null,
                    userHandle: idUser
                }
                if (params != $(".nk-chat-body").attr("data-ag-id")) {
                    objPesanSap.msg = "Site.Inbox.AgentOutBy";
                    objPesanSap.user = Inbox.Info.currentUser().UserId
                }
                Q.confirm(
                    `${Q.text("Site.Inbox.ConfirmUnassign")} "${nm}"?`,
                    () => {
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/RemoveAgentFromConversation",
                            request: {
                                Delete: {
                                    EntityId: params,
                                },
                                Msg: {
                                    Type: 6,
                                    RoomId: $(".nk-chat-body").attr("data-id"),
                                    Msg: JSON.stringify(objPesanSap),
                                },
                            },
                            onSuccess: async (response) => {
                                if (!response.IsError) {
                                    let finalObjAgent = {
                                        Mode: "Delete",
                                        Data: params,
                                    };
                                    let objPesan = BuatObjPesan(
                                        6,
                                        JSON.stringify(objPesanSap),
                                        null,
                                        null
                                    );
                                    try {
                                        await connection.invoke(
                                            "MkAgent",
                                            $(".nk-chat-body").attr("data-id"),
                                            JSON.stringify(finalObjAgent),
                                            JSON.stringify(objPesan),
                                            response.JmlUnassigned.toString()
                                        );
                                        Q.notifySuccess(Q.text("Site.Inbox.SuccessDelAgent"));
                                    } catch (error) {
                                        console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                                    }
                                    let objDataRoom = {
                                        Mode: "Delete",
                                        Data: $(".nk-chat-body").attr("data-id"),
                                        IdUserDel: idUser,
                                    };
                                    try {
                                        await connection.invoke(
                                            "AgentConversation",
                                            JSON.stringify(objDataRoom),
                                            idUser,
                                            Inbox.Info.currentUser().TenantId
                                        );
                                    } catch (error) {
                                        console.error(`MkAgent Step = ${Step}, Msg = ${error}`);
                                    }
                                }
                            },
                        });
                    },
                    {
                        // onNo: () => {
                        //   Q.notifyInfo("Remove Failed.");
                        // },
                        // title: "Unassign agent",
                    }
                );
            }

            //Tambah note
            $("#addnote").on("click", function () {
                let dlg = new Nobox.ChatnotesDialog();
                dlg.userLogin = Inbox.Info.currentUser();
                dlg.ObjAccount = Inbox.DataRoomActive.Account;
                dlg.ObjLink = Inbox.DataRoomActive.Link;
                dlg.callback = async (data) => {
                    try {
                        await connection.invoke(
                            "MkNote",
                            $(".nk-chat-body").attr("data-id"),
                            JSON.stringify(data)
                        );
                        Q.notifySuccess(Q.text("Site.Inbox.SuccessAddNote"));
                    } catch (error) {
                        console.error(`MkNote Step = ${Step}, Msg = ${error}`);
                    }
                };
                dlg.applyChangesButton.remove();
                dlg.loadEntityAndOpenDialog({
                    RoomId: $(".nk-chat-body").attr("data-id"),
                });
            });

            //Kembali dari list conversation history
            $("#backchathistory").on("click", function () {
                $("#panelkananch").removeClass(" visible");
                $("#panelkanandetail").removeClass(" visible");
                $("#panelkanan").addClass(" visible");
            });

            //Kembali dari detail message conversation history
            $("#backchathistorydetail").on("click", function () {
                $("#panelkananch").addClass(" visible");
                $("#panelkanandetail").removeClass(" visible");
                $("#panelkanan").removeClass(" visible");
            });

            //Tampilkan pesan dari conversation history
            function showChatHistory(id) {
                Inbox.Data.SkipInitMsgHistory = false;
                $("#chat-history-cnt").html("");
                $(".lds-spinner-chatmsghistory").show();
                Inbox.Data.IdRoomHistory = id;
                Q.serviceCall({
                    blockUI: false,
                    url: "/Services/Chat/Chatroomagents/List",
                    request: {
                        IncludeColumns: [
                            "Id",
                            "UserId",
                            "UserImage",
                            "DisplayName",
                            "RoomId",
                        ],
                        EqualityFilter: {
                            RoomId: id,
                            UserId: $(".nk-chat-body").attr("data-ag-id"),
                        },
                    },
                    onSuccess: (res) => {
                        //Inbox.DataRoomActive.Agents = res.Entities;
                        //Masih belum tau supervisor bolaeh apa tidak membuka history percakapan yang dianya tidak join

                        //if (res.Entities.length) {
                        $("#panelkananch").removeClass(" visible");
                        $("#panelkanan").removeClass(" visible");
                        $("#panelkanandetail").addClass(" visible");
                        let skip = 0;
                        Q.serviceCall({
                            blockUI: false,
                            url: "/Services/Chat/Chatrooms/DetailRoom",
                            request: {
                                EntityId: id,
                            },
                            onSuccess: (response) => {
                                if (!response.IsError) {
                                    skip = skip + response.Data.Messages.length;
                                    resMsg = response.Data.Messages;
                                    Inbox.Data.SkipMsgHistory = skip;
                                    $(".lds-spinner-chatmsghistory").hide();
                                    if (
                                        resMsg.length /* && Inbox.DataRoomActive.Agents.length > 0*/
                                    ) {
                                        resMsg.forEach(function (e, u) {
                                            if (u == resMsg.length - 1) {
                                                Inbox.Data.SkipInitMsgHistory = false;
                                            }
                                            Inbox.Function.TemplateElmMsg.showMsg(e, false, false, "#chat-history-cnt", false, false);
                                            //createChatMessage(
                                            //    e,
                                            //    "#chat-history-cnt",
                                            //    response.Data.Room.Ct
                                            //);
                                            //gotoBottomHistory();
                                        });
                                    }
                                }
                            },
                        });

                        //} else {
                        //    Q.alert('You dont have permission in this conversation.')
                        //}
                    },
                });
            }

            //Template untuk buat list conversation history
            function createChatHistory(evn, idElm) {
                if (evn.Uc == null) {
                    jmlRead = ``;
                } else {
                    jmlRead = `<div class="status unread">
                                                    <span class="lkbadge lkbadge-pill lkbadge-primary">${evn.Uc}</span>
                                                    </div>`;
                }
                if (evn.TagsIds == "" || evn.TagsIds === null) {
                    tags = "";
                } else {
                    tags = `<div class="chat-context">
                                                <div class="text"><i class="fas fa-tags" style="font-size:initial;"></i>
                                                <span style="font-size:11px;" title="${evn.Tags}">${evn.Tags}</span></div>
                                                </div>`;
                }

                iconkontak = Inbox.Function.renderChannelInListConversation(evn.ChId);

                if (evn.St == 2) {
                    statuschat = `<span ch-data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-primary">${Q.text("Site.Inbox.Assigned")}</span>`;
                } else if (evn.St == 1) {
                    statuschat = `<span ch-data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-danger">${Q.text("Site.Inbox.Unassigned")}</span>`;
                } else if (evn.St == 3) {
                    statuschat = `<span ch-data-st-id="ST${evn.Id}" class="lkbadge lkbadge-outline-success">${Q.text("Site.Inbox.Resolved")}</span>`;
                }

                if (evn.IsPin == 2) {
                    pin = `<i ch-data-pin-id="pin${evn.Id}" class="fas fa-thumbtack ml-1" style="font-size:16px;"></i>`;
                    pinned = "pinned";
                } else {
                    pin = ``;
                    pinned = "";
                }

                if (evn.CtIsBlock == 1) {
                    block = `<i data-block-id="block${evn.CtRealId}" class="fas fa-user-alt-slash ml-1 text-danger" style="font-size:16px;"></i>`;
                } else {
                    block = ``;
                }

                let sdr = evn.SdrMsg == "me" ? '<i class="fas fa-reply"></i>' : "";
                let iconMsg = "";
                if (evn.LastMsg != null) {
                    if (evn.LastMsg.includes('<i class="fa fa-image"></i>')) {
                        evn.LastMsg = evn.LastMsg.replace(
                            '<i class="fa fa-image"></i> ',
                            ""
                        );
                        iconMsg = '<i class="fa fa-image"></i>';
                    } else if (evn.LastMsg.includes("<i class='fa fa-image'></i>")) {
                        evn.LastMsg = evn.LastMsg.replace(
                            "<i class='fa fa-image'></i> ",
                            ""
                        );
                        iconMsg = '<i class="fa fa-image"></i>';
                    } else if (evn.LastMsg.includes('<i class="fa fa-file"></i>')) {
                        evn.LastMsg = evn.LastMsg.replace(
                            '<i class="fa fa-file"></i> ',
                            ""
                        );
                        iconMsg = '<i class="fa fa-file"></i>';
                    } else if (evn.LastMsg.includes("<i class='fa fa-file'></i>")) {
                        evn.LastMsg = evn.LastMsg.replace(
                            "<i class='fa fa-file'></i> ",
                            ""
                        );
                        iconMsg = '<i class="fa fa-file"></i>';
                    } else if (
                        evn.LastMsg.includes('<i class="fa fa-microphone"></i>')
                    ) {
                        evn.LastMsg = evn.LastMsg.replace(
                            '<i class="fa fa-microphone"></i>',
                            ""
                        );
                        iconMsg = '<i class="fa fa-microphone"></i>';
                    } else if (
                        evn.LastMsg.includes("<i class='fa fa-microphone'></i>")
                    ) {
                        evn.LastMsg = evn.LastMsg.replace(
                            "<i class='fa fa-microphone'></i> ",
                            ""
                        );
                        iconMsg = '<i class="fa fa-microphone"></i>';
                    } else if (evn.LastMsg.includes('<i class="fa fa-video"></i>')) {
                        evn.LastMsg = evn.LastMsg.replace(
                            '<i class="fa fa-video"></i>',
                            ""
                        );
                        iconMsg = '<i class="fa fa-video"></i>';
                    } else if (evn.LastMsg.includes("<i class='fa fa-video'></i>")) {
                        evn.LastMsg = evn.LastMsg.replace(
                            "<i class='fa fa-video'></i> ",
                            ""
                        );
                        iconMsg = '<i class="fa fa-video"></i>';
                    } else if (
                        evn.LastMsg.includes("<i class='fa fa-sticky-note'></i>")
                    ) {
                        evn.LastMsg = evn.LastMsg.replace(
                            "<i class='fa fa-sticky-note'></i> ",
                            ""
                        );
                        iconMsg = '<i class="fa fa-sticky-note"></i>';
                    }
                }
                if (evn.TimeMsg == null) {
                    evn.TimeMsg = "";
                } else if (isToday(new Date(evn.TimeMsg))) {
                    //evn.TimeMsg = "Today at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                    evn.TimeMsg = getCookie(evn.TimeMsg, "timezone", "TimeOnly");
                } else if (isYesterday(new Date(evn.TimeMsg))) {
                    //evn.TimeMsg = "Yesterday at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly');
                    evn.TimeMsg = "Yesterday";
                } else {
                    evn.TimeMsg = getCookie(
                        evn.TimeMsg,
                        "timezone",
                        "Date"
                    ) /* + " at " + getCookie(evn.TimeMsg, "timezone", 'TimeOnly')*/;
                }

                if (evn.IsGrp == 1) {
                    profil = `style="background-image: url('/Inbox/img/users.jpeg');background-size: cover;background-position: center;"`;
                } else {
                    if (!Q.isEmptyOrNull(evn.CtImg)) {
                        profil = `style="background-image: url('${evn.CtImg}');background-size: cover;background-position: center;"`;
                    } else if (!Q.isEmptyOrNull(evn.LinkImg)) {
                        profil = `style="background-image: url('${evn.LinkImg}');background-size: cover;background-position: center;"`;
                    } else {
                        profil = `style="background-image: url('/Inbox/img/user.jpeg');background-size: cover;background-position: center;"`;
                    }
                }
                const template = `<li id="chathistoryId${evn.Id
                    }" class="ShowChatHistory chat-item border-bottom disabledLink ///// ${pinned}">
                                                <div class="chat-item-all"><div class="chat-link chat-open">
                                                <div class="chat-media user-lkavatar" ${profil}></div>
                                                <div class="chat-info">
                                                <div class="chat-from">
                                                <div class="name" data-room-name="chathistoryNm${evn.Id
                    }">${evn.IsGrp == 1
                        ? evn.Grp
                        : evn.CtRealNm == null
                            ? evn.Ct
                            : evn.CtRealNm
                    }</div>
                                                <span class="time" id="TIMEidchathistory${evn.Id
                    }">${isToday(new Date(evn.Up))
                        ? getCookie(
                            evn.Up,
                            "timezone",
                            "TimeOnly"
                        ) /*"Today at " + getCookie(evn.Up, "timezone", 'TimeOnly')*/
                        : getCookie(evn.Up, "timezone", "Date")
                    } <span ch-data-act-id="act${evn.Id}" data-act-ct-id="${evn.CtRealId
                    }">${pin} ${block}</span></span>
                                                </div>
                                                <div class="chat-context"><div class="text ${evn.SdrMsg == "you" && evn.IsNeedReply == 1 ? "text-danger" : ""}">
                                                ${sdr} 
                                                ${iconMsg} 
                                                ${Q.isEmptyOrNull(evn.UserLastMsg) ? "" : (`<b>${evn.UserLastMsg.length > 12 ? evn.UserLastMsg.substring(0, 12) + "..." : evn.UserLastMsg}: </b>`)}
                                                ${evn.LastMsg == null || evn.LastMsg == "null"
                        ? ""
                        : String(evn.LastMsg)
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;").replace("Site.Inbox.PaymentPaid", Q.text("Site.Inbox.PaymentPaid"))
                            .replace("Site.Inbox.PaymentPending", Q.text("Site.Inbox.PaymentPending"))
                            .replace("Site.Inbox.StatusPreparing", Q.text("Site.Inbox.StatusPreparing"))
                            .replace("Site.Inbox.StatusPayRequest", Q.text("Site.Inbox.StatusPayRequest"))
                            .replace("Site.Inbox.StatusShipped", Q.text("Site.Inbox.StatusShipped"))
                            .replace("Site.Inbox.StatusDelivered", Q.text("Site.Inbox.StatusDelivered"))
                            .replace("Site.Inbox.StatusCanceled", Q.text("Site.Inbox.StatusCanceled"))
                            .replace("Site.Inbox.OrderConfirm", Q.text("Site.Inbox.OrderConfirm"))
                            .replace("Site.Inbox.OrderReject", Q.text("Site.Inbox.OrderReject"))
                    }</div></div>
                                                <div class="chat-context">
                                                <div class="text">${iconkontak}
                                                <span>${evn.ChAcc
                    }</span></div>
                                                ${statuschat}
                                                </div>
                                                ${tags}
                                                </div>
                                                </div>
                                                </div>
                                            </li>`;
                $(idElm).append(template);
            }

            //Navigasi ke menu conversation history(menu kanan)
            $("#tochathistory").on("click", function () {
                $("#panelkananch").addClass(" visible");
                $("#panelkanan").removeClass(" visible");
                $("#panelkanandetail").removeClass(" visible");
                $(".lds-spinner-chathistory").show();
                $("#chathistorycnt").html("");
                let equalFilter = { CtId: Inbox.DataRoomActive.Room.CtId, St: 3 };
                if (Inbox.DataRoomActive.Room.IsGrp == 1) {
                    equalFilter = { GrpId: Inbox.DataRoomActive.Room.GrpId, St: 3 };
                }
                Q.serviceCall({
                    blockUI: false,
                    url: "/Services/Chat/Chatrooms/ListHistory",
                    request: {
                        Sort: ["IsPin DESC", "TimeMsg DESC"],
                        Skip: 0,
                        Take: 500,
                        EqualityFilter: equalFilter,
                        Criteria: [["In"], "<=", Inbox.DataRoomActive.Room.In],
                    },
                    onSuccess: (res) => {
                        $(".lds-spinner-chathistory").hide();
                        res.Entities.forEach(function (e) {
                            createChatHistory(e, "#chathistorycnt");
                        });
                        $(".ShowChatHistory").unbind("click");
                        $(".ShowChatHistory").on("click", function () {
                            showChatHistory($(this).attr("id").replace("chathistoryId", ""));
                        });
                    },
                });
            });

            async function CreateNewConversation(Obj) {
                let hasil = await connection.invoke("CreateNewRoom", Obj);
                let hasilFinal = JSON.parse(hasil);
                if (hasilFinal.IsError) {
                    Q.alert(hasilFinal.ErrorMsg);
                } else {
                    let adaElm = $(`#roomId${hasilFinal.Room.Id}`).length;
                    if (adaElm == 0) {
                        BuatRoomList(hasilFinal.Room, true);
                    } else {
                        $(`#roomId${hasilFinal.Room.Id}`).click();
                    }
                    if (hasilFinal.Room.St == 1 && !Q.Authorization.hasPermission("Role:Supervisor")) {
                        setTimeout(() => {
                            const user2Assign = Inbox.Info.currentUser();
                            addagent(
                                user2Assign.UserId,
                                user2Assign.DisplayName,
                                user2Assign.UserImage,
                                true,
                                hasilFinal.Room.Id
                            );
                        }, 500)
                    }
                }
            }

            $("#createRoomBTN").on("click", () => {
                Q.confirm(Q.text("Site.Inbox.CreateConversation"), () => {
                    CreateNewConversation({
                        AccId: Inbox.DataRoomActive.Account.Id,
                        ChId: Inbox.DataRoomActive.Account.Channel,
                        Chat: Inbox.DataRoomActive.Room.IsGrp == 1 ? 1 : 0,
                        To: 2,
                        Contact: null,
                        Manual: null,
                        LinkId:
                            Inbox.DataRoomActive.Room.IsGrp == 1
                                ? null
                                : Inbox.DataRoomActive.Link.Id,
                        GrpId:
                            Inbox.DataRoomActive.Room.IsGrp == 1
                                ? Inbox.DataRoomActive.Group.Id
                                : null,
                    });
                });
            });

            $("#createroom").on("click", () => {
                let dlg = new Nobox.ChatroomsCreateDialog();
                dlg.callback = (res) => {
                    if (!Q.isEmptyOrNull(res.Manual)) {
                        let fisrtLater = res.Manual.charAt(0);
                        let noHp = res.Manual;
                        if (fisrtLater == "0")
                            res.Manual = Inbox.Info.settingDefault.CountryCode + noHp.substring(1);
                    }
                    CreateNewConversation({
                        AccId: Number(res.AccId),
                        ChId: Number(res.ChId),
                        LinkId: Q.isEmptyOrNull(res.LinkId) ? null : Number(res.LinkId),
                        GrpId: Q.isEmptyOrNull(res.GrpId) ? null : Number(res.GrpId),
                        Chat: Number(res.Chat),
                        CtId: Q.isEmptyOrNull(res.Contact) ? null : Number(res.Contact),
                        Manual: res.Manual,
                        To: Number(res.To),
                    });
                };
                dlg.loadNewAndOpenDialog();
                dlg.element.find(".field.Contact .editor").select2("open");
            });
        } catch (err) {
            setTimeout(StartSignalR, 3000);
        }
    }

    // ===== CONFIGURATION =====
    const CONFIG = {
        RECONNECT_DELAY: 15, // seconds
        PENDING_MESSAGES_KEY: "PesanPending",
        UI_SELECTORS: {
            floatCustom: ".floatCustom",
            floatCustomConnecting: ".floatCustomConnecting",
            floatCustomSending: ".floatCustomSending",
            countDown: "#countDownReconnect",
            tryNowBtn: "#TryNow"
        }
    };

    // ===== STATE MANAGEMENT =====
    const ConnectionManager = {
        reconnectTimer: null,
        isReconnecting: false,

        // Clear any existing reconnection timer
        clearReconnectTimer() {
            if (this.reconnectTimer) {
                clearInterval(this.reconnectTimer);
                this.reconnectTimer = null;
            }
        },

        // Set reconnecting state
        setReconnecting(state) {
            this.isReconnecting = state;
        }
    };

    // ===== UTILITY FUNCTIONS =====
    const Utils = {
        // Safe localStorage operations with error handling
        getStorageItem(key) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : null;
            } catch (error) {
                console.error(`Error parsing localStorage item ${key}:`, error);
                return null;
            }
        },

        setStorageItem(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
                return true;
            } catch (error) {
                console.error(`Error setting localStorage item ${key}:`, error);
                return false;
            }
        },

        // UI Helper functions
        showElement(selector) {
            $(selector).show();
        },

        hideElement(selector) {
            $(selector).hide();
        },

        updateCountdown(count) {
            $(CONFIG.UI_SELECTORS.countDown).text(count);
        }
    };

    // ===== PENDING MESSAGES HANDLER =====
    async function processPendingMessages() {
        const pendingMessages = Utils.getStorageItem(CONFIG.PENDING_MESSAGES_KEY);

        if (!pendingMessages || !Array.isArray(pendingMessages) || pendingMessages.length === 0) {
            return;
        }

        Utils.showElement(CONFIG.UI_SELECTORS.floatCustomSending);

        try {
            // Process messages sequentially to avoid overwhelming the server
            const successfullyProcessed = [];

            for (let i = 0; i < pendingMessages.length; i++) {
                const message = pendingMessages[i];

                try {
                    await connection.invoke("KirimPesan", message.Obj);
                    successfullyProcessed.push(i);
                    console.log(`Successfully sent pending message ${i + 1}/${pendingMessages.length}`);
                } catch (error) {
                    console.error(`Failed to send pending message ${i + 1}:`, error);
                    // Continue processing other messages instead of stopping
                }
            }

            // Remove successfully processed messages (in reverse order to maintain indices)
            successfullyProcessed.reverse().forEach(index => {
                pendingMessages.splice(index, 1);
            });

            // Update localStorage with remaining messages
            Utils.setStorageItem(CONFIG.PENDING_MESSAGES_KEY, pendingMessages);

        } finally {
            Utils.hideElement(CONFIG.UI_SELECTORS.floatCustomSending);
        }
    }

    // ===== SUBSCRIPTION MANAGEMENT =====
    async function subscribeUser() {
        const currentUser = Inbox.Info.currentUser();

        if (!currentUser) {
            throw new Error("Current user information not available");
        }

        try {
            if (Q.Authorization.hasPermission("Role:Supervisor")) {
                await connection.invoke("SubscribeUserSpv", currentUser.TenantId);
                console.log("Subscribed as Supervisor");
            } else {
                await connection.invoke("SubscribeUserAgent", currentUser.UserId);
                console.log("Subscribed as Agent");
            }
        } catch (error) {
            console.error("Failed to subscribe user:", error);
            throw error; // Re-throw to handle at higher level
        }
    }

    // ===== ROOM MANAGEMENT =====
    async function joinActiveRoom() {
        if (Inbox.IdRoomAktif) {
            try {
                await connection.invoke("JoinConversation", Inbox.IdRoomAktif, "");
                console.log(`Joined room: ${Inbox.IdRoomAktif}`);
            } catch (error) {
                console.error("Failed to join active room:", error);
                throw error;
            }
        }
    }

    // ===== RECONNECTION LOGIC =====
    async function attemptReconnection() {
        if (ConnectionManager.isReconnecting) {
            console.log("Reconnection already in progress, skipping...");
            return;
        }

        ConnectionManager.setReconnecting(true);

        try {
            console.log("Attempting to reconnect...");

            // Start the connection
            await connection.start();
            console.log("SignalR connection established");

            // Hide connecting indicator
            Utils.hideElement(CONFIG.UI_SELECTORS.floatCustomConnecting);

            // Subscribe user
            await subscribeUser();

            // Join active room if exists
            await joinActiveRoom();

            // Process any pending messages
            await processPendingMessages();

            console.log("Reconnection completed successfully");

        } catch (error) {
            console.error("Reconnection failed:", error);

            // Hide connecting indicator and start countdown for retry
            Utils.hideElement(CONFIG.UI_SELECTORS.floatCustomConnecting);
            ConnectionManager.clearReconnectTimer();
            startReconnectCountdown();

        } finally {
            ConnectionManager.setReconnecting(false);
        }
    }

    // ===== COUNTDOWN MANAGEMENT =====
    function startReconnectCountdown() {
        Utils.showElement(CONFIG.UI_SELECTORS.floatCustom);

        let countDown = CONFIG.RECONNECT_DELAY;
        Utils.updateCountdown(countDown);

        ConnectionManager.reconnectTimer = setInterval(() => {
            countDown--;
            Utils.updateCountdown(countDown);

            if (countDown <= 0) {
                ConnectionManager.clearReconnectTimer();
                Utils.hideElement(CONFIG.UI_SELECTORS.floatCustom);
                Utils.showElement(CONFIG.UI_SELECTORS.floatCustomConnecting);
                attemptReconnection();
            }
        }, 1000);
    }

    // ===== EVENT HANDLERS =====
    function setupEventHandlers() {
        // Handle connection close
        connection.onclose(async () => {
            console.log("SignalR connection closed, starting reconnection process...");
            startReconnectCountdown();
        });

        // Handle manual reconnect button
        $(CONFIG.UI_SELECTORS.tryNowBtn).off("click").on("click", () => {
            console.log("Manual reconnection triggered");
            ConnectionManager.clearReconnectTimer();
            Utils.hideElement(CONFIG.UI_SELECTORS.floatCustom);
            Utils.showElement(CONFIG.UI_SELECTORS.floatCustomConnecting);
            attemptReconnection();
        });
    }

    // ===== INITIALIZATION =====
    function initializeSignalR() {
        console.log("Initializing SignalR connection manager...");

        // Setup event handlers
        setupEventHandlers();

        // Start initial connection after a short delay
        setTimeout(() => {
            if (typeof StartSignalR === "function") {
                StartSignalR();
            } else {
                console.warn("StartSignalR function not found, attempting direct connection...");
                attemptReconnection();
            }
        }, 1000);
    }

    // Start the initialization
    initializeSignalR();
});
